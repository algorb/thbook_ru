\eject

\vbox{\hsize=93.2mm\baselineskip=12pt\leftskip3.5mm\parskip0pt \eightit

\leavevmode\llap{1. }Когда выдающийся, но пожилой ученый утверждает, что что-то возможно, он почти наверняка прав. Когда он утверждает, что что-то невозможно, он, вероятно,\break ошибается. 

\leavevmode\llap{2. }Единственный способ обнаружить пределы возможного -- это отправиться в путь к невозможному. 

\leavevmode\llap{3. }Любая достаточно развитая технология неотличима от магии. \vskip 6pt \rightline{\eightrm -- C. Clarke, {\eightmit 1973}} } 

\chapter Приложение. 

\subchapter Компиляция. 

Если вы хотите скомпилировать Therion из исходников и запустить его, вам нужны (первые три необходимы только во время компиляции): \list

* GNU C/C++ компилятор. * GNU make. * Perl. * Python 2.7 или 3. * Tcl/Tk 8.4.3 или новее (\www{https://www.tcl.tk}) с набором виджетов {\it BWidget} (\www{https://sourceforge.net/projects/tcllib/}) и необязательным расширением\break {\it tkImg} (\www{https://sourceforge.net/projects/tkimg/}). 

%  {\it Tom} OpenGL extension (improved version is included in Therion source 
%  distribution)
%  and 
* \TeX\ дистрибутив с plain форматом \TeX, pdf\TeX, и \MP\break (\www{https://www.tug.org}). * LCDF Typetools пакет (\www{https://www.lcdf.org/type/}). * ImageMagick дистрибутив с утилитами {\it convert} и {\it identify}, если вы хотите использовать деформирование эскизы съемок. * {\it ghostscript}, если вы хотите создать откалиброванные изображения карт с привязкой к географическим картам. \endlist

Для компиляции Loch вам необходимы: 

\list

* freetype 2 или новее с поддержкой freetype-config; * wxWidgets 2.6 или новее с поддержкой wx-config; * VTK 5.0 или новее; * libjpeg, libpng, zlib. \endlist

Все программы (за исключением пакетов BWidget и tkImg) обычно\break включаются в дистрибутивы Linux, Unix или MacOS X. Для Windows\break необходимы MinGW и MSYS (\www {http://www.mingw.org}). Эти дистрибутивы содержат GNU make и GCC. Кстати, почему бы не использовать\break предварительно скомпилированную версию для Windows?. 

\subsubchapter Быстрый старт. 

\list

* распаковать исходники дистрибутива |therion-5.*.tar.gz|; * |cd therion|; * |make config-macosx| или |make config-win32|, если вы используете MacOS X или Windows, соответственно; * |make|; * |sudo make install|. \endlist

%Installing Tom:
%
%\list
%* if you use Windows, download a Tcl/Tk source distribution, |make| and
%  |make install| it under MSYS
%* |cd therion/thtom/linux| or |cd therion/thtom/win|
%* |make|
%* copy |Tom0.2| directory (which should contain |pkgIndex.tcl| and one of 
%  |libtom.so| or |libtom.dll|) 
%  to the |lib| subdirectory of your 
%  Tcl/Tk distribution.
%\endlist
\subsubchapter Руководство для хакеров. 

{\it Make параметры} 

Файл Therion'а {\it makefile} может принимать некоторые необязательные опции: 

\list

* |config-linux|, |config-macosx|, |config-win32| = настроить Therion для\break конкретной платформы. Linux по умолчанию; * |config-release|, |config-oxygen|, |config-ozone| = установить уровень\break оптимизации для компилятора C++ (none, |-O2| или |-O3|); * |config-debug| = полезно перед отладкой программы; * |install| = установить Therion; * |clean| = удалить все временные файлы. \endlist

{\it Кросс-компиляция для Windows}\NEW{5.4} 

Therion поддерживает компиляцию исполняемых файлов Win32 в Linux с использованием кросс-компилятора MXE (\www{http://mxe.cc}). 

\list

* установите следующие static/win32-пакеты (i686-w64-mingw32.static-\char42) в\break директорию |/usr/lib/mxe/|: binutils, bzip2, expat, freetype-bootstrap, gcc,\break gettext, glib, harfbuzz, jpeg, libiconv, libpng, tiff, vtk, wxwidgets, xz, zlib; * измените PATH: {\catcode`\=12|export PATH=/usr/lib/mxe/usr/bin:$PATH|}; * |cd therion|; * |make config-win32cross|; * |make|. \endlist

{\it Добавление новых переводов} 

Therion поддерживает перевод текстовых меток на картах. Предположим, вы хотите добавить новый язык |xx|: 

\list

* запустите `|perl process.pl export xx|' в подкаталоге Therion'а `thlang'; Это создаст файл |texts_xx.txt|. Этот файл имеет кодировку UTF-8; * отредактируйте файл |texts_xx.txt|. Добавьте свои переводы в строки,\break начинающиеся с `|xx:|'; * запустите |make update|; * скомпилируйте Therion. \endlist

{\it Добавление новых кодировок} 

Хотя кодировка Unicode UTF-8 содержит все символы, которые Therion\break может использовать, возможно вам будет неудобно использовать ее. В этом случае можно добавить поддержку любой 8-битной кодировки для текстовых входных файлов. Скопируйте файл перевода в |thchencdata| каталог; добавьте его имя в хэш-код `ifiles' в начале скрипта Perl |generate.pl|; запустите его и перекомпилируйте Therion. 

Файл перевода должен содержать два шестнадцатеричных символа (первый в 8-разрядной кодировке, второй в Unicode) в каждой строке. Можно\break добавлять комментарии за символом `|#|'. 

{\it Добавление новых \TeX\ кодировок} 

Легко добавить новые кодировки для вывода 2D-карты \[\NEW{5.3}Этот раздел относится к выбору шрифтов старого стиля с использованием команды |tex-fonts| в файле инициализации и устарела при использовании команды |pdf-fonts|.]. Скопируйте\break соответствующий файл сопоставления кодировки с расширением |*.enc| в\break |texenc/encodings|, запустите скрипт Perl |mktexenc.pl| расположенный в\break каталоге |texenc| и перекомпилируйте Therion. 

%
Therion использует те же файлы кодировки, что и программа |afm2tfm| из дистрибутива \TeX, который имеет тот же формат, что и векторная кодировка в шрифте PostScript. Вы можете найти более подробную информацию в главе {\it 6.3.1.5 Формат файла кодировки} в документации к программе Dvips. 

{\it Генерация новых header-файлов \TeX\ и \MP\ } 

Therion использует \TeX\ и \MP\ для 2D-визуализации карт и верстки. Предопределенные макросы компилируются в исполняемый файл Therion'а и копируются в рабочий каталог непосредственно перед запуском \MP\ и \TeX\ (если не используется опция |--use-extern-libs|). Команда |layout| позволяет изменять некоторые макросы в файле конфигурации во время выполнения. 

Тем не менее, возможно внесение постоянных изменений в файлы макросов. После изменения файлов в каталогах |mpost| и |tex| необходимо запустить\break Perl-скрипты |genmpost.pl| и |gentex.pl|, которые генерируют header файлы C++, и снова компилируют исполняемый файл Therion'а. 

\subchapter Переменные среды. 

Therion считывает следующие переменные среды: 

\list

* |THERION| = [не требуется] путь поиска для файла(ов) (x)therion.ini; * |HOME| (|HOMEDRIVE| + |HOMEPATH| на WinXP) = [не требуется, но обычно присутствует в вашей системе] путь поиска для файла(ов) (x)therion.ini; * |TEMP|, |TMP| = системный временный каталог, где Therion хранит\break временные файлы (в каталоге с именем |th$PID$|, где |$PID$| является\break идентификатором процесса), если только |tmp-path| указан в файле\break инициализации. \endlist

Проконсультируйтесь с документацией вашей ОС о том, как их установить. 

\subchapter Файлы инициализации. 

Системно-зависимые параметры Therion'а и XTherion'а указаны в файле\break therion.ini или xtherion.ini, соответственно. Они ищутся в следующих\break каталогах: 

\list

* в UNIX: |.|, |$THERION|, |$HOME/.therion|, |/etc|, |/usr/etc|, |/usr/local/etc|; * в Windows: |.|, |$THERION|, |$HOME\.therion|, |<директория установки|\break |Therion'а>|, |C:\WINDOWS|, |C:\WINNT|, |C:\Program Files\Therion| \endlist

\subsubchapter Therion. 

Если файл не найден, Therion использует настройки по умолчанию. Если вы хотите их вывести, используйте опцию |--print-init-file|. Файл инициализации читается как любой другой файл. Пустые строки или строки,\break начинающиеся с `|#|', игнорируются, строки, заканчивающиеся на обратную косую черту, продолжаются в следующей строке. В настоящее время\break поддерживаются команды инициализации: 

\list

* |loop-closure <therion/survex>| 

По умолчанию используется |survex|, если он установлен, иначе\break используется |therion|; 

* |encoding-default <имя кодировки>| 

Устанавливает стандартную выходную кодировку (в настоящее время не используется); 

* |encoding-sql <имя кодировки>| 

Устанавливает стандартную выходную кодировку для экспорта SQL; 

* |language <xx[_YY]>| 

Язык вывода по умолчанию. Список доступных языков смотрите на\break странице авторских прав; 

* |units <metric/imperial>| 

Устанавливает единицы по умолчанию; 

* |mpost-path <путь файла>| 

Устанавливает полный путь к исполняемому файлу \MP, если\break Therion не сможет его найти (``|mpost|'' является значением по умолчанию); 

* |mpost-options <текст>| 

Устанавливает опции \MP; 

* |pdftex-path <путь файла>| 

Устанавливает полный путь к исполняемому файлу pdf\TeX, если Therion не сможет его найти (``|pdfetex|'' является значением по умолчанию); 

* |identify-path <путь файла>| 

Устанавливает полный путь к идентификатору ImageMagick, если Therion не может его найти (``|ident|'' является значением по умолчанию); 

* |convert-path <путь файла>| 

Устанавливает полный путь к исполняемому файлу ImageMagick, если\break Therion не может его найти (``|convert|'' является значением по умолчанию); 

* |source-path <каталог>| 

Путь к файлам данных и конфигурации. Используется в основном для system-wide grades и определений макетов; 

* |tmp-path <каталог>| 

Путь, где должен быть создан временный каталог; 

* |tmp-remove <команда ОС>| 

Системная команда для удаления файлов из временного каталога; 

* |tex-env <on/off>| 

Работает только в Windows. Когда установлено значение |off| (по\break умолчанию), Therion временно очищает все переменные среды, связанные с \TeX. Полезно, если в вашей системе установлен другой дистрибутив \TeX, который настроил переменные среды, которые могут запутать программы \TeX\ и \MP, поставляемые с дистрибутивом Therion для Windows. 

Установите в |on|, если вы используете другой дистрибутив \TeX\ для\break обработки карт; 

* |text <ID языка> <текст Therion'а> <свой текст>| 

С помощью этой опции вы можете изменить любой текст перевода по умолчанию на выходе. Список текстов и\break доступных переводов смотрите в файле |thlang/texts.txt|; 

* |cs-def <id> <proj4def>|\NEW{5.4} 

%[other options]
Определяет новую систему координат |<id>| используя синтаксис Proj4; 

* |pdf-fonts <rm> <it> <bf> <ss> <si>|\NEW{5.3} 

Настройка шрифтов, которые будут использоваться в PDF-картах. За\break командой должны следовать пути, указывающие, где в вашей системе расположены обычные, курсивные, полужирные, без засечек и наклонные без засечек шрифты. Поддерживаются шрифты TrueType и OpenType. 

Для использования этой команды Therion требует установки LCDF\break Typetools в вашей системе. Пример: 

|pdf-fonts "/usr/share/fonts/Serif.ttf" \
			"/usr/share/fonts/Serif-Italic.ttf" \
			"/usr/share/fonts/Serif-Bold.ttf" \
			"/usr/share/fonts/Sans.ttf" \
			"/usr/share/fonts/Sans-Oblique.ttf"| 

* |otf2pfb <on/off>|\NEW{5.3} 

Когда установлено значение |on| (по умолчанию), шрифты OpenType,\break используемые в |pdf-fonts|, преобразуются в шрифты PFB, если они\break основаны на PostScript. Некоторая информация теряется в формате PFB, но есть преимущество в том, что pdf\TeX\ может встраивать часть шрифтов PFB (в отличие от шрифтов OpenType, которые должны быть встроены полностью); 

* |tex-fonts <кодировка> <rm> <it> <bf> <ss> <si>| 

Исходный и более сложный способ настройки шрифтов для PDF-карт. Вам нужно явно указать кодировку (не более 256 символов из шрифта, который будет использоваться). Список поддерживаемых в настоящее время кодировок выводится опцией |--print-tex-encodings| в командной\break строке. Та же кодировка должна использоваться при генерации \TeX\break метрик (|*.tfm| файлов) для этих шрифтов (например, с использованием программы afm2tfm), и эта кодировка должна быть явно указана в файле карты в pdf\TeX. Единственным исключением является базовый набор\break шрифтов Computer Modern, который использует `сырую' кодировку. Эта кодировка не нуждается в указывании в файле карты pdf\TeX. 

За кодировкой должны следовать пять спецификаций шрифтов для\break обычных, курсивных, полужирных, без засечек и наклонных без засечек. Значение по умолчанию: |tex-fonts raw cmr10 cmti10 cmbx10 cmss10 cmssi10|. 

Пример использования других шрифтов (например, TrueType Palatino в кодировке xl2, кодировка, полученная из ISO8859-2). Запустите: 

|ttf2afm -e xl2.enc -o palatino.afm palatino.ttf| 

|afm2tfm palatino.afm -u -v vpalatino -T xl2.enc| 

|vptovf vpalatino.vpl vpalatino.vf vpalatino.tfm| 

Вы получите файлы |vpalatino.vf|, |vpalatino.tfm| и |palatino.tfm|. Добавьте строчку 

|palatino <xl2.enc <palatino.ttf| 

в pdf\TeX\ файл карты. То же самое должно быть сделано для курсивых и полужирных шрифтов и соответствующих шрифтов без засечек и\break наклонных без засечек. Если вы ленитесь, попробуйте: 

|tex-fonts xl2 palatino palatino palatino palatino palatino| 

(Мы должны использовать виртуальный шрифт |vpalatino| вместо |palatino|, который не содержит кернинга или лигатуры, но pdf\TeX\ не поддерживает команду |\pdfincludechars| на виртуальных шрифтах. Будет улучшен). 

Если вы хотите добавить некоторые не поддерживаемые кодировки,\break прочитайте главу {\it Компиляция / Руководство хакера}; 

* |tex-fonts-optional <кодировка> <rm> <it> <bf> <ss> <si>| 

Подобно смотрите в |tex-fonts|, но дополнительно проверяется, установлены ли в системе шрифты \TeX. Ничего не происходит, если какой-либо из указанных шрифтов отсутствует. 

Этот параметр используется по умолчанию для чешских/словацких и\break кириллических шрифтов, чтобы избежать ошибок \MP\ для систем без этих шрифтов. 

Поскольку тест занимает некоторое время (экземпляр pdfTeX запущен), вы можете полностью отключить поведение по умолчанию, установив\break |tex-fonts| в файле INI. 

\endlist

\subsubchapter XTherion. 

Файл инициализации для XTherion на самом деле является сценарием Tcl, обрабатываемыми при запуске XTherion'а. Файл комментирован; смотрите комментарии для подробностей. 

%\subsubchapter Speed optimization.
%
%[Optionally creating \MP\ and \TeX\ format files.]
\subchapter Ограничения. 

\list

* размер скрапа = $\approx 2.8 \times 2.8$ м в выходном масштабе (ограничение\break\MP); * размер страницы = 

PDF-карта или атлас: $\approx 5 \times 5$ м (ограничение pdf\TeX) 

SVG-карта: без ограничений; * количество скрапов = примерно 500--6000, в зависимости от частоты\break поперечных сечений 

текущий предел \MP: $4 (скрапы + сечения) < 4096$ (может быть\break произвольно увеличено) 

предел pdf\TeX: $2\times страницы + изображения + шаблоны + 6 (скрапы + сечения)\break < 32500$ \endlist

\subchapter Примеры данных. 

Следующий простой пример иллюстрирует базовое использование команд Therion'а: 

|encoding utf-8 

survey main -title "Тестовая пещера" 

	survey first
		centreline
			units compass grad
			data normal from to compass clino length
							1	  2  100	   -5	 10
		endcentreline
	endsurvey 

	survey second -declination [3 deg]
		centreline
			calibrate length 0 0.96
			data normal from to compass length clino
							1	  2  0		  10	  +10
		endcentreline
	endsurvey 

	centreline
		equate 2@first 1@second
	endcentreline 

	# скрапы обычно находятся в отдельных *.th2 файлах
	scrap s1 -author 2004 "Команда Therion'а" 

		point 763 746 station -name 2@second
		point 702 430 station -name 2@first
		point 352 469 station -name 1@first
		point 675 585 air-draught -orientation 240 -scale large 

		line wall -close on
			287 475
			281 354 687 331 755 367
			981 486 846 879 683 739
			476 561 293 611 287 475
		endline 

	endscrap 

	map m1 -title "Тестовая карта"
		s1
	endmap 

endsurvey| 

Соответствующий конфигурационный файл может быть: 

|encoding utf-8
source test 

layout l1
	scale 1 100
	layers off
endlayout 

select m1@main 

export model -fmt survex
export map -layout l1| 

Если вы сохраните файл данных как `test.th' и конфигурационный файл как `thconfig', вы можете обработать их с помощью Therion'а. 

%\subchapter Map symbols library.
%\input sym/symlib
\subchapter История изменений. 

\list

\everypar{\hangindent16pt\hangafter1} * {\bf 1999} 

Октябрь: первые конкретные идеи. 

Ноябрь: начало программирования (скрипты Perl и макросы \MP). 

Декабрь, 27: Therion впервые компилирует простую карту в формате PostScript (32 Кбайт Perl и 7 Кбайт \MP\ и \TeX\ исходного кода). Модель деформации карты существенно отличалась от текущей\break (позиции характеристик были относительно конкретного съемного\break замера, а не позиции всех станций в скрапе). Эта версия уже включала некоторые интересные функции, такие как {\it функции трансформации}, которые позволяли определять спецификацию входного формата для данных съемки или разбивать большие карты на несколько листов. 

Декабрь, 30: первая веб-страница (с примерами данных, но без исходного кода). 

* {\bf 2000}\nobreak\par\nobreak Январь: xthedit (Tcl/Tk) -- графический интерфейс для Therion'а. 

Февраль, 18: начало перепрограммирования (Perl). 

Апрель, 1: первая гиперссылка PDF-карты/атласа. 

Август: эксперименты с PDF, pdf\TeX\ и \MP

* {\bf 2001} 

Ноябрь: начало повторной реализации с нуля: Therion (C++ с некоторыми скриптами Perl, унаследованными от предыдущей версии); понятие\break скрапа; интерактивный редактор 2D-карт ThEdit в качестве замены\break xthedit (Delphi). 

Декабрь: ThEdit впервые экспортирует простую карту. 

* {\bf 2002} 

Март: Therion 0.1 -- Therion способен обрабатывать данные съемки\break (центральной линии) пещеры Мертвых летучих мышей. XTherion -- текстовый редактор, предназначенный для Therion'а (Tcl/Tk). 

Июль, 27: Therion 0.2 -- Therion впервые компилирует простую карту (состоящую из двух скрапов) (800 КБ исходного кода). 

Август: XTherion расширен до редактора 2D-карт (в качестве замены\break ThEdit). 

Сентябрь: Therion собирает первую реальную и сложную карту пещеры. XTherion использует компилятор. 

%  Oct 5: Public presentation of Therion, held on Trango\v{s}ka
* {\bf 2003}\nobreak 

Март: первая версия Therion Book завершена. 

Апрель: Therion включен в Debian GNU/Linux. 

Июнь: все сценарии Perl переписанные на C++, Therion -- это одна\break исполняемая программа (хотя использует Survex и \TeX). 

%  Nov 10: first idea of the Labyrinth project
* {\bf 2004}\Nobreak 

Март: Therion 0.3 -- Therion экспортирует трехмерную модель, созданную с 2D-карт. Алгоритм замыкания колец включен в Therion. 

* {\bf 2006}\Nobreak 

Октябрь: Therion 0.4 -- Новый 3D-просмотрщик (Loch). 

* {\bf 2007}\Nobreak 

Февраль: Therion 0.5 -- Поддержка морфинга эскизов растровых\break изображений. \endlist

\subchapter Будущее. 

Хотя Therion уже используется для создания карт, есть много новых\break функций, которые необходимо реализовать: 

\subsubchapter Главная. 

\list

* информация о закрытии колец в SQL. \endlist

\subsubchapter 2D-карты. 

\list

* завершить предопределенные наборы символов; * генерировать регистры для атласа; * использовать MPlib вместо \MP\endlist

\subsubchapter 3D-модели. 

\list

* улучшить моделирование ходов. \endlist

\subsubchapter XTherion. 

\list

* улучшить возможности 2D-редактирования. \endlist

\subsubchapter Loch. 

\list

* цветовые схемы; * дерево съемок для выбора подсекций для отображения; * пространственная фильтрация (например, отсечение плоскостями); * поддержка нескольких поверхностей. \endlist

\subsubchapter Лабиринт. 

\list

* полностью новый графический интерфейс в далеком будущем (смотрите \www{https://labyrinth.speleo.sk}) \endlist

\endinput

