\eject

\vbox{\rightline{\pic[100mm]{agrippa.jpg}} \kern-20mm \eightit\baselineskip10pt\rightskip105mm\leftskip0mm\parindent1.05cm Only for you, children of doctrine and learning, have we written this work. Examine this book, ponder the meaning we have dispersed in various places and gathered again; what we have concealed in one place we have disclosed in another, that it may be understood by your wisdom.\par \kern-10pt \rightline{\hfil\eightrm ---Henricus C. Agrippa ab Nettesheym, \eightmit 1533} } 

\chapter Создание файлов данных. 

\subchapter Основы. 

Входные файлы для Therion'а имеют текстовый формат. Существует нес\-колько правил о том, как должен выглядеть такой файл: 

\list * Есть два типа команд. Однострочные команды и многострочные команды. 

* Однострочная команда завершается символом конца строки. Их синтаксис 

|command arg1 ... argN [-option1 value1 -option2 value2 ...]| 


где {\it arg1 ... argN} являются обязательными аргументами, а пары {\it -option value} являются параметрами, которые вы можете свободно пропустить. Какие аргументы и опции доступны, зависит от конкретной команды. Примером может служить 

|point 643.5 505.0 gradient -orientation 144.7| 

с тремя обязательными аргументами и одной дополнительной парой оп\-ция/значение. Иногда параметров нет или может быть несколько зна\-че\-ний. 

* Многострочные команды начинаются аналогично однострочным, но про\-дол\-жа\-ются на последующих строках до явного завершения команды. Эти строки могут содержать либо данные, либо параметры, которые при\-ме\-ня\-ются к последующим данным. Если строка данных начинается со слова, зарезервированного для опции, вам нужно вставить `|!|' перед ней. Син\-так\-сис 

|command arg1 ... argN [-option1 value1 -option2 value2 ...]
	...
	optionX valueX
	data
	...
endcommand| 

Опять же, для лучшей иллюстрации приведем пример: 

|line wall -id walltobereferenced
	1174.0 744.5
	1194.0 756.5 1192.5 757.5 1176.0 791.0
	smooth off
	1205.5 788.0 1195.5 832.5 1173.5 879.0
endline| 

Эта команда |line| имеет один обязательный аргумент, тип линии (коренная стена в данном случае), за которой следует одина опция. Следующие две строки содержат данные (координаты кривых Безье). Следующая строка (``|smooth off|'') указывает параметр, который применяется к последующим данным (т.е. не для всей строки, в отличие от опции |-id| в первой строке), и последняя строка содержит еще несколько данных. 

* Если значение параметра или аргумента содержит пробелы, вы должны заключить это значение в \hbox{|" "|} или \hbox{|[ ]|}. Если вы хотите поместить двойную кавычку |"| в текст в \hbox{|" "|} вам нужно вставить его дважды. Кавычки ис\-поль\-зу\-ются для строк; скобки для числовых значений и ключевых слов. 

* Каждая строка, заканчивающаяся обратным слэшем (|\|), считается про\-дол\-жен\-ной на следующей строке, как будто не было ни разрыва строки, ни зазора. 

* Все, что следует за |#| и до конца строки, даже внутри команды, считается комментарием и игнорируется. 

* \NEW{5.4}Многострочные комментарии внутри |comment| ... |endcomment| блока раз\-ре\-шены в файлах данных и конфигурационных файлах. 

\endlist

\subchapter Типы данных. 

Therion использует следующие типы данных: 

\list

* {\it keyword} = последовательность |A-Z|, |a-z|, |0-9| и |_-/| символов (не начинающиеся с `|-|'). * {\it ext\_keyword} = слово, которое также может содержать |+*.,'| символы, но не в первой позиции. * {\it date} = спецификация даты (или временного интервала) в формате \hfil\break |YYYY.MM.DD@HH:MM:SS.SS - YYYY.MM.DD@HH:MM:SS.SS| или `|-|' чтобы указать неопределенную дату. * {\it person} = имя и фамилия человека, разделенные пробельными символами. Используйте `|/|' чтобы отделить имя и фамилию, если есть несколько имен. * {\it string} = последовательность любых символов. \NEW{5.3}Строки могут содержать специальный тег |<lang:XX>| для разделения переводов. В многоязычных строках только текст между |<lang:XX>| (где |XX| - это язык, выбранный в файле инициализации или конфигурации) и следующим тегом |<lang:YY>| отображается на выходе. Если совпадение не найдено, все до появления тега |<lang:ZZ>| отображается. * {\it units} = поддерживаемые единицы длины: meter[s], centimeter[s], inch[es], feet[s], yard[s] (можно сокращать m, cm, in, ft, yd). Поддерживаемые угловые единицы:  degree[s], minute[s] (можно сокращать deg, min), grad[s], mil[s], percent[age] (только для угла наклона).
 Значение градуса может быть введено в десятичной системе ($x.y$) или в специальной нотации для градусов, минут и секунд ($deg[{:}min[{:}sec]]$). \endlist

\subchapter Системы координат. 

Therion поддерживает преобразования координат в геодезические системы координат. Вы можете указать опцию |cs| в объектах |centreline|, |surface|, |import| и |layout| и ввести XY в выбранной системе координат. Вы также можете указать вывод |cs| в конфигурационном файле. 

Если вы не указали какой-либо |cs| в вашем наборе данных, то предполагается, что вы работаете в |local| системе координат, и никакие преобразования не выполняются. Если вы укажете |cs| в любом месте данных, то вы должны указать его для всех данных местоположения (|fix|, |origin| и |layout| и т. д.). 

|cs| применяется ко всем последующим данным местоположения, пока другие |cs| не будут указаны или до конца текущего объекта, в зависимости от того, что наступит раньше. 

Поддерживаются следующие системы координат: 

\list

* |UTM1| -- |UTM60| = Универсальная поперечная проекция Меркатора (Universal Transverse Mercator) в северном полушарии и заданной зоне, WGS84. * |UTM1N| -- |UTM60N| = то же, что и |UTM1| -- |UTM60| * |UTM1S| -- |UTM60S| = UTM в южном полушарии, WGS84. * |lat-long|, |long-lat| = широта (N положительная, S отрицательная) и долгота (E положительная, W отрицательная) в заданном порядке в градусах (раз\-ре\-шено $deg[{:}min[{:}sec]]$), WGS84. По умолчанию не поддерживается на выходе. * |EPSG:<number>| =Большинство систем координат EPSG. Почти каждая сис\-тема координат, используемая во всем мире, имеет собственный номер EPSG. Чтобы найти номер вашей системы, см. |extern/proj4/nad/epsg| файл в дистрибутиве исходников. * |ESRI:<number>| = Аналогично EPSG, но стандарт ESRI. 

%* |EUR79Z30| = UTM zone 30, EUR79 datum.  % ad-hoc addition not worth mentioning??
* |JTSK|, |iJTSK| = Чехословацкая система S-JTSK, используемая с 1920-х годов с южной и западной осью (JTSK) и ее модифицированной версией с осью, указывающей восток и север отрицательными числми (iJTSK). JTSK не поддерживается на выходе (как и iJTSK). * |JTSK03|, |iJTSK03| = новая реализация S-JTSK, введенная в Словакии в 2011 году. * |OSGB:<H, N, O, S или T><A-Z исключая I>| = Британская Национальная Сеть.\NEW{5.4} * |S-MERC| = сферическая проекция Меркатора, используемая различными сайтами онлайн-сопоставления.
 \endlist

\subchapter Магнитное склонение. 

Therion содержит встроенный IGRF\[См. \www{https://www.ngdc.noaa.gov/IAGA/vmod/}] --- модель геомагнитного поля Земли, дей\-стви\-тель\-ная для периода 1900--2020 гг\NEW{5.4}. Он автоматически используется, если пещера находится в пространстве с использованием любой из под\-дер\-жи\-вае\-мых геодезических систем координат, и никакое склонение не опре\-де\-ля\-ется пользователем.
 Вычисленное склонение указано в файле LOG для ин\-фор\-ма\-ции. 

\subchapter Формат данных. 

Синтаксис входных файлов объясняется в описании отдельных команд. Изу\-че\-ние примеров файлов, распространяемых вместе с Therion, поможет вам понять основы. Смотрите также примеры в {\it Приложении}. 

В каждом из следующих разделов описывается одна команда Therion, исполь\-зую\-щая следующую структуру: 

{\it Описание:} примечания относительно этой команды. 

{\it Синтаксис:} описание синтаксиса. 

{\it Контекст:} указывает контекст, в котором используется эта команда. Кон\-текст {\it survey} означает, что команда должна быть заключена в пару |survey ... endsurvey|. Контекст {\it scrap} означает, что команда должна быть заключена в пару |scrap ... endscrap|. Контекст {\it all} означает, что команда может исполь\-зо\-ваться в любом месте. 

{\it Аргументы:} список обязательных аргументов с пояснениями. 

{\it Опции:} список доступных опций. 

{\it Опции командной строки:} для многострочных команд, которые могут быть указаны среди строк данных. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `encoding'. 

\description

устанавливает кодировку входного файла. Это позволяет использовать сим\-волы не ASCII во входных файлах. \enddescription

\syntax

|encoding <encoding-name>| \endsyntax

\context

Это должна быть самая первая команда в файле. \endcontext

\arguments

* |<encoding-name>| = чтобы увидеть список всех поддерживаемых имен ко\-ди\-ро\-вок, запустите Therion с опцией |--print-encodings|. Кодировки `UTF-8' (Unicode) и `ASCII' (7 бит) всегда поддерживаются. \endarguments

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `input'. 

\description

вставляет содержимое файла на место команды. Расширение по умолчанию `.th' и его можно не указывать. Для максимальной портабельности исполь\-зуйте относительные пути, а для разделения каталогов используйте харак\-тер\-ный для Unix `|/|', а не обратный слеш используемый в Windows `|\|'.  \enddescription

\syntax

|input <file-name>| \endsyntax

\context

all \endcontext

\arguments

* |<file-name>| \endarguments

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `survey'. 

\description

Survey -- основная структура данных. 

% Each data object must belong to a   survey. 
Survey могут быть вложенными -- это позволяет построить иерархическую структуру. Обычный уровень иерархической структуры survey представлен пещерами, более высокие уровни карстовыми областями, а более низкие уровни, например, ходами пещеры.
 

Каждый survey имеет собственное пространство имен, указанное его |<id>| аргументом. Объекты (например станции или скрапы, см. ниже), которые относятся к subsurvey текущего survey, записываются как 

|<object-id>@<subsurvey-id>|, 

или, если есть больше уровней вложения 

|<object-id>@<subsubsurvey-id>.<subsurvey-id>|.\[Примечание: невозможно связать любой объект с survey более высокого уровня.] 

Это означает, что идентификаторы объектов должны быть уникальными только в рамках одного survey. Например, имена станций съемки могут быть одинаковыми, если они находятся в разных survey. Это позволяет делать нумерацию станций с 0 в каждом survey или объединение двух пещер в одну пещерную систему без переименования станций съемки. 

\enddescription

\syntax

|survey <id> [OPTIONS]
	... другие объекты ...
endsurvey [<id>]| \endsyntax

\context

none, survey \endcontext

\arguments

* |<id>| = идентификатор \endarguments

\options * |namespace <on/off>| = указывает, создавать ли survey пространство имен (|on| по умолчанию). * |declination <specification>| = устанавливает склонение по умолчанию для всех объектов данных в этом survey (которые могут быть переопределены но\-вым склонением в suburveys). The |<specification>| имеет три формы: 

1. |[]| пустую строку. Это приведет к сбросу склонения. 

2. |[<значение> <единицы>]| установит одно значение (также для undated survey). 

3. |[<дата1> <начение1> [<дата2> <значение2> ... ] <единицы>]| установит склонение для нескольких дат. Тогда склонение каждого замера будет установлено в соответствии со спецификацией даты объекта данных.
 Если вы хотите явно указать склонение для данных без даты, используйте `|-|' вместо даты.
 

Если не определено склонение и определена какая-либо геодезическая система координат, склонение автоматически вычисляется с исполь\-зо\-ва\-нием встроенной геомагнитной модели. 

Обратите внимание: склонение положительно, когда магнитный север на\-хо\-дится к востоку от истинного севера. 

* |person-rename <старое имя> <новое имя>| = переименовать человека, имя кото\-рого было изменено. 

* |title <строка>| = описание объекта. 

* |entrance <имя-станции>| = указывает главный вход в пещеру, представленный в этом survey. Если это не указано, и в этом survey есть только одна станция отмеченная входом, он считается также входом в пещеру. Эта информация используется для |cave-list| экспорта. \endoptions

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `centreline'. 

\description

Описание данных survey (нитки хода).  Синтаксис заимствован из Survex с небольшими изменениями; руководство Survex может быть полезно в ка\-честве дополнительной справки для использования. Можно использовать си\-но\-ним `centerline'. \enddescription

\syntax

|centreline [OPTIONS]
	date <дата>
	team <персона> [<роли>]
	explo-date <дата>
	explo-team <персона>
	instrument <quantity list> <описание>
	calibrate <quantity list> <zero error> [<scale>]
	units <quantity list> [<factor>] <единицы>
	sd <quantity list> <значение> <единицы>
	grade <grade list>
	declination <значение> <единицы>
	grid-angle <значение> <единицы>
	infer <what> <on/off>
	mark <тип>
	flags <shot flags>
	station <станция> <комментарий> [<flags>]
	cs <система координат>
	fix <станция> [<x> <y> <z> [<std x> <std y> <std z>]]
	equate <station list>
	data <стиль> <readings order>
	break
	group
	endgroup
	walls <auto/on/off>
	vthreshold <число> <единицы>
	extend <spec> [<станция> [<станция>]]
	station-names <префикс> <суффикс>
	...
	[данные съемки]
	...
endcentreline| \endsyntax

\context

none, survey \endcontext

\options

* |id <ext_keyword>| = id объекта * |author <дата> <персона>| = автор данных и дата их создания * |copyright <дата> <строка>| = дата и имя авторского права * |title <строка>| = описание объекта \endoptions

\comopt

* |date <дата>| = дата съемки. Если указано несколько дат, создается временной интервал. * |explo-date <дата>| = дата исследования. Если указано несколько дат, создается временной интервал. * |team <персона> [<роли>]| = член съемочного отделения. Первый аргумент -- его имя, остальные описывают роли человека в команде (необязательно -- в настоящее время не используется). Поддерживаются следующие значения: station, length, tape, [back]compass, [back]bearing, [back]clino, [back]gradient, counter, depth, station, position, notes, pictures, pics, instruments (insts), assistant (dog). * |explo-team <персона>| = член исследовательского отделения. * |instrument <quantity list> <description>| = описание инструмента, который исполь\-зо\-вался для определения количественных данных (те же значения, что и роль человека в команде). * |infer <what> <on/off>| = `|infer plumbs on|' говорит программе интерпретировать угол наклона $\pm90\,^\circ$ как UP/DOWN (это означает, что угол наклона не будет изменяться при раскидывании невязки). `|infer equates on|' программа будет интерпретировать замеры с длиной 0 в качестве команды equate (что означает, что не применяются никакие корректировки длины). * |declination <значение> <единицы>| = задает склонение для последующих замеров $$истинный\ азимут = измеренный\ азимут + склонение$$ Склонение положительно, когда магнитный север находится к востоку от истинного севера. Если ни одно cклонение не указано, или cклонение сброшено (|-|), тогда действительная спецификация склонения ищется во всех съемках, в которых находится объект данных. См. опцию declination команды survey. * |grid-angle <значение> <единицы>| = задает угол магнитной сетки (склонение от направления на север). * |sd <quantity list> <значение> <единицы>| = задает стандартное отклонение для данных измерений. Quantity list может содержать следующие значения: length, tape, bearing, compass, gradient, clino, counter, depth, x, y, z, position, easting, dx, northing, dy, altitude, dz. * |grade <grade list>| = устанавливаются стандартные отклонения для угла нак\-лона съемки (смотрите команду grade). Все ранее заданные стандартные отклонения или определения теряются. Если вы хотите изменить SD, используйте опцию sd после этой команды. Если указано несколько опре\-делений, то применяется только последнее. Вы можете указать определе\-ния только для позиции или только для съемок. Если вы хотите их комбинировать, вы должны использовать их в одной строке. * |units <quantity list> [<factor>] <единицы>| = установка единиц для данных измере\-ний (так же как и для sd). * |calibrate <quantity list> <zero error> [<масштаб>]| = установка калибровки прибора. Измеренное значение рассчитывается по следующей формуле: $измерен\-ное\ значение = (прочитанное\ значение - zero\ error) \times масштаб$. Поддержи\-ваемые единицы такие же, как в sd. * |break| = может использоваться между данными, чтобы отделить два пересе\-чения. * |mark [<список станций>] <тип>| = установить тип именованных станций. |<тип>| может принимать одно из значений: fixed (фиксированным), painted (нари\-сованный) и temporary (временным) (по умолчанию). Если список станций отсутствует, все последующие станции будут отмечены соответствующим типом. * |flags <флаги замеров>| = установить флаги для следующих замеров. Поддержи\-ваемые флаги: |surface| (для измерений на поверхности), |duplicate| (для дубли\-рованных съемок), |splay| (для коротких боковых замеров, которые по умол\-чанию скрыты на картах и моделях). Они исключаются из расчетов длины. 

Все замеры, имеющие в названии одной из станций `|.|' или `|-|' по умолча\-нию имеют тип |splay| (смотрите также команду |data|). 

Если флаг установлен на |approx[imate]|, он включается в вычисления общей длины, но также отображается отдельно в статистике съемки. Он должен использоваться для замеров, которые не были сняты должным образом и нуждаются в пересъемке. 

Также перед флагом допускается приставка ``|not|''. * |station <станция> <комментарий> [<флаги>]| = установить комментарий станции и ее флаги. Если в качестве комментария указан |""|, то он игнорируется. 

Поддерживаемые флаги: |entrance| (вход), |continuation| (продолжение), |air-draught
[:winter/summer]| (ток воздуха:зима/лето), |sink| (понор), |spring| (источник), |doline| (карстовая воронка), |dig| (раскоп), \NEW{5.3}|arch| (свод), |overhang| (нависание потолка). Также приставка |not| может быть использована перед флагом, чтобы уда\-лить ранее добавленный флаг. 

Вы также можете указать пользовательские атрибуты для станции, исполь\-зуя флаг |attr|, за которым следуют имя и значение атрибута. Пример:\hfil\break |station 4 "колодец для изучения" continuation attr code "V"| 

Если есть ход, который был исследован, но еще не снят, то предполагаемая исследуемая длина этого хода может быть учтена добавлением к станции флага |continuation|. Просто добавьте флаг |explored <исследовательская-длинна>| для станции. Исследовательские длины являются частью статистики съем\-ки/пещеры, отображаемой отдельно. Пример:\hfil\break |station 40 "ужасная прогулка" continuation explored 100m| 

* |cs <система координат>| = система координат для станций с фиксированными координатами. * |fix <station> [<x> <y> <z> [<std x> <std y> <std z>]]| = фиксировать координаты станции (с указанными ошибками -- к ним применяется только преобразо\-вание единиц, а не калибровка). * |equate <список станций>| = эквивалентность заданных точек. * |data <стиль> <порядок считывания>| = установить стиль данных (normal, topofil, diving, cartesian, cylpolar, dimensions, nosurvey) и порядок считывания. Считывание может принимать одно из следующих ключевых слов: station, from, to, tape/length, [back]compass/[back]bearing, [back]clino/\penalty0[back]gradi\-ent, depth, fromdepth, todepth, depthchange, counter, fromcount, tocount, northing, easting, altitude, up/ceiling\[Размер может быть задан как пара |[<from> <to>\char"5D|, что означает размер в начале и в конце замера.], down/floor, left, right, ignore, ignoreall. 

Смотрите руководство к Survex для подробностей. 

Для разноуровневых данных поддерживаются ключевые слова новой стро\-ки и направления. Если есть прямые и обратные данные азимута или угла, то вычисляется среднее из них. 

\NEW{5.3} Если в замере одна из станций имеет название `|.|' или `|-|', то у замера устанавливается атрибут |splay|. {\it Dot} следует использовать для замеров, заканчивающихся внутри хода, {\it dash} для замеров, заканчивающихся на стенах хода, на полу или потолке. Хотя Therion еще не делает различий между ними, его следует использовать для улучшения 3D-моделирования в будущем. 

* |group| * |endgroup| = |group/endgroup| пара позволяет пользователю делать временные изменения практически в любых настройках (калибровка, единицы, sd, данные, флаги...). * |walls <auto/on/off>| =включение/выключение генерации формы хода из дан\-ных LRUD для последующих замеров. Если установлен |auto|, то ход генери\-руется только в том случае, если отсутствует скрап содержащий данную нитку хода. * |vthreshold <число> <единицы>| = пороговое значение для интерпретации пока\-заний LRUD как показания лево-право-верх-низ, перпендикулярное замеру. 

Если ходы горизонтальны (|наклон < vthreshold|), LR считается перпендикуляр\-ным к замеру, а UD вертикальными. 

Если ходы более или менее вертикальные (|наклон > vthreshold|), тогда даже UD становится перпендикулярным к замеру, в противном случае ходы выглядят не очень хорошо. В случае вертикальных замеров UD интерпре\-тируется как измерение с севера на юг от станции, чтобы построить вертикальные участки модели. 

* |extend <spec> [<станция> [<станция>]]| = определение развертки нитки хода. |<spec>| принимает следующие значения: 

|normal/reverse| = развернуть данную и следующие станции в таком же/обрат\-ном направлении по отношению к предыдущей станции. Если заданы две станции -- направление применяется только к данному замеру; 

|left/right| =как указано выше, но направление указано явно; 

|vertical| = не перемещает станцию (замер) в направлении $X$, использует только $Z$ компонент замера; 

|start| = указать начальную станцию (замер); 

|ignore| = игнорирует указанную станцию (замер), продолжает развертку как у другой станции (замера), если возможно; 

|hide| = не показывает указанную станцию (замер) в развертке; 

Если ни одна из станций не указана, |<spec>| действует для следующих указанных замеров. 

* |station-names <префикс> <суффикс>| = добавляет данный префикс/суффикс для всех станций съемки в текущей нитки хода. Для сохранения типизации. 

\endcomopt

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `scrap'. 

\description

Скрап -- это часть 2D-карты, которая не содержит пересекающихся ходов (т.е. все хода могут быть нарисованы на бумаге не пересекаясь). Для небольших и простых пещер вся пещера может поместиться в одном скрапе. В сложных системах скрап обычно представляет собой один грот или один ход. В идеале скрап содержит около 100 м пещеры.\[Если необходимо, скрапы могут быть намного меньше, несколько метров пещеры. {При определении размера скрапа учитывайте следующее:} Использование небольших скрапов может потребовать больше времени для их обрисовки и для оптимизации их объедине\-ния. С другой стороны, маленькие скрапы, вероятно, будут менее искажены алгоритмами преобразования карт, чем более крупные скрапы. Слишком большие скрапы может исчерпать \MP память, если часто используются заливки хода. Кроме того редактор карт в XTherion'е медленнее реагирует при редактировании больших скрапов.] Каждый скрап обраба\-тывается отдельно \MP; слишком большие скрапы могут превысить размер \MP памяти и вызвать ошибки. 

Скрап состоит из точечных, строковых и областных символов. Смотрите главу {\it, Как карта собирается в единое целое} для объяснения, как и в котором порядке они выводятся при отображении. 

Граница скрапа состоит из линий с опцией |-outline| или |-outline in| (стены хода по умалчанию имеют опцию |-outline out|). Эти линии не должны пересекаться, иначе, Therion (\MP) не может определить внутреннюю часть скрапа и \MP\ выдает предупреждение ''|scrap outline intersects itself|''. 

У каждого скрапа есть своя собственная локальная декартова система координат, которая обычно соответствует миллиметровой бумаге (если Вы определяете координаты символов карты вручную) или пикселям отсканированного изображения (если Вы используете XTherion). Therion делает преобразование этой локальной системы координат в реальные координаты, используя позиции станций съемки, которые определены в скрапе как символы точки на карте и определены в нитке хода. Если скрап не содержит по крайней мере две станции съемки с определением |-name|, тогда Вы должны использовать опцию |-scale| для калибровки скрапа. (Это обычно используется для сечений.) 

Трансформация состоит из следующих шагов: \list * Линейное преобразование (смещение, масштабирование и вращение), которые 'лучше всего' соответствуют станциям. 'Лучше всего' означает, что сумма квадратов расстояний между соответствующими станциями до и после трансформации минимальна. Результат отображается красный, если опция |debug| в команде |layout| установлена в |on|. * Non-linear transformation of the scrap which (1) moves survey stations to their correct position, (2) is continuous. Отображается синим в режиме |debug|. * Non-linear transformation of the scrap which (1) moves joined points together, (2) doesn't move survey stations, (3) is continuous. В конце положение контрольных точек кривых корректируется, чтобы сохранить гладкость. Результат -- готовая карта. \endlist

\enddescription

\syntax |scrap <id> [OPTIONS] ... point, line and area commands ... endscrap [<id>]| \endsyntax

\context

none, survey \endcontext

\arguments

*|<id>| = scrap identifier \endarguments

\options

* |projection <specification>| = specifies the drawing projection. Each projection is identified by a type and optionally by an index in the form |type[:index]|. The index can be any keyword. The following projection types are supported: 

1. |none| = no projection, used for cross sections or maps that are independent of survey data (e.g.~digitization of old maps where no centreline data are available). No index is allowed for this projection. 

2. |plan| = basic plan projection (default). 

3. |elevation| = orthogonal projection (a.k.a.\ projected profile) which optionally takes a view direction as an argument (e.g.~|[elevation 10]| or |[elevation 10 deg]|). 

4. |extended| = extended elevation (a.k.a.\ extended profile). 

* |scale <specification>| = is used to pre-scale (convert coordinates from pixels to meters) the scrap data. If scrap projection is none, this is the only transformation that is done with coordinates. The |<specification>| has four forms: 

1. |<number>| = |<number>| meters per drawing unit. 

2. |[<number> <length units>]| = |<number> <length units>| per drawing unit. 

3. |[<num1> <num2> <length units>]| = |<num1>| drawing units corresponds to |<num2> <length units>| in reality. 

4. |[<num1> ... <num8> [<length units>]]| = this is the most general format, where you specify, in order, the $x$ and $y$ coordinates of two points in the scrap and two points in reality. Optionally, you can also specify units for the coordinates of the `points in reality'. This form allows you to apply both scaling and rotation to the scrap. * |cs <coordinate system>| = assumes that (calibrated) local scrap coordinates are given in specified coordinate system. It is useful for absolute placing of imported sketches where no survey stations are specified.\[If there are some survey stations in the scrap, the |cs| specification is ignored.] * |stations <list of station names>| = stations you want to plot to the scrap, but which are not used for scrap transformation. You don't have to specify (draw) them with the |point station| command. * |sketch <filename> <x> <y>| = underlying sketch bitmap specification (lower left corner coordinates). * |walls <on/off/auto>| = specify if the scrap should be used in 3D model reconstruction * |flip (none)/horizontal/vertical| = flips the scrap after scale transformation * |station-names <prefix> <suffix>| = adds given prefix/suffix to all survey stations in the current scrap. Для сохранения типизации. 

* |author <date> <person>| = author of the data and its creation date * |copyright <date> <string>| = copyright date and name * |title <string>| = description of the object \endoptions

\subsubchapter `point'. 

\description

Point is a command for drawing a point map symbol. \enddescription

\syntax

|point <x> <y> <type> [OPTIONS]| \endsyntax

\context

scrap \endcontext

\arguments

* |<x>| and |<y>| are the drawing coordinates of an object. * |<type>| determines the type of an object. The following types are supported: 

{\it special objects:} |station|\[Survey station. For each scrap (with the exception of scraps in `none' projection) at least one station with station reference (|-name| option) has to be specified.], |section|\[|section| is an anchor for placing the cross-section at this point. This symbol has no visual representation. The cross section must be in the separate scrap with `none' projection specified. You can specify it through the |-scrap| option.], |dimensions|\[Use |-value| option to specify passage dimensions above/below centerline plane used while creating 3D model.]; 

{\it labels:} |label|, |remark|, |altitude|\[General altitude label. All altitudes are exported as a difference against grid $Z$ origin (which is 0 by default). To display altitude on the passage wall, use |altitude| option for any line point of the passage wall], |height|\[Height of formations inside of the passage (like pit etc.); see below for details.], |passage-height|\[Height of the passage; see below for details.], |station-name|\[If no text is specified, the name of the nearest station is used.], \penalty-100 |date|; 

{\it symbolic passage fills:}\[Unlike other point symbols, these are clipped by the scrap border. See the chapter {\it How the map is put together}.] |bedrock|, |sand|, |raft|, |clay|, |pebbles|, |debris|, |blocks|, |water|, |ice|, |guano|, |snow|; 

{\it speleothems:} |flowstone|, |moonmilk|, |stalactite|, |stalagmite|, |pillar|, |curtain|, |helictite|, |soda-straw|, |crystal|, |wall-calcite|, |popcorn|, |disk|, |gypsum|, |gypsum-flower|, |aragonite|, |cave-pearl|, |rimstone-pool|, |rimstone-dam|, |anastomosis|, |karren|, |scallop|, |flute|, |raft-cone|, \NEW{5.4}|clay-tree|; 

{\it equipment:} |anchor|, |rope|, |fixed-ladder|, |rope-ladder|, |steps|, |bridge|, |traverse|, |camp|, |no-equipment|; 

{\it passage ends:} |continuation|, |narrow-end|, |low-end|, |flowstone-choke|, |breakdown-choke|, \NEW{5.4}|clay-choke|, |entrance|; 

{\it others:} |dig|, |archeo-material|, |paleo-material|, |vegetable-debris|, |root|, |water-flow|, |spring|\[Always use |spring| and |sink| symbols with a |water-flow| arrow.], |sink|, \NEW{5.4}|ice-stalactite|, |ice-stalagmite|, |ice-pillar|, |gradient|, |air-draught|\[Number of ticks is set according to |-scale| option], |map-connection|\[Virtual point, used to indicate connection between shifted maps (extended elevation, map offset).], |extra|\[Additional morphing point.], |u|\[For user defined point symbols.]. 

\endarguments

\options

* |subtype <keyword>| = determines the object's subtype. The following subtypes for given types are supported: 

{\it station:}\[if station subtype is not specified, Therion reads it from centreline, if it's specified there] |temporary| (default), |painted|, |natural|, |fixed|; 

{\it air-draught:} |winter|, |summer|, |undefined| (default); 

{\it water-flow:} |permanent| (default), |intermittent|, |paleo|. 

The subtype may be specified also directly in |<type>| specification using `|:|' as a separator.\[E.g.~|station:fixed|] 

Any subtype specification can be used with user defined type (|u|). In this case you need also to define corresponding metapost symbol (see the chapter {\it New map symbols}). 

* |orientation/orient <number>| = defines the orientation of the symbol. If not specified, it's oriented to north. 0 $\le$ |number| $<$ 360. * |align| = alignment of the symbol or text. The following values are accepted: center, c, top, t, bottom, b, left, l, right, r, top-left, tl, top-right, tr, bottom-left, bl, bottom-right, br. * |scale| = symbol scale, can be: tiny (xs), small (s), normal (m), large (l), huge (xl) or a numeric value. Normal is default. Named sizes scale by $\sqrt 2$, so that $xs \equiv 0.5$, $s \equiv 0.707$, $m \equiv 1.0$, $l \equiv 1.414$ and $xl \equiv 2.0$. * |place <bottom/default/top>| = changes displaying order in the map. * |clip <on/off>| = specify whether a symbol is clipped by the scrap border. You cannot specify this option for the following symbols: station, station-name, label, remark, date, altitude, height, passage-height. * |dist <distance>| = valid for extra points, specifies the distance to the nearest station (or station specified using |-from| option. If not specified, appropriate value from LRUD data is used. * |from <station>| = valid for extra points, specifies reference station. * |visibility <on/off>| = displays/hides the symbol. * |context <point/line/area> <symbol-type>| = (to be used with |symbol-hide| and |symbol-show| layout options) symbol will be hidden/shown according to rules for specified |<symbol-type>|.\[Example: if you specify |-context point air-draught| to a label which displays the observation date, the |symbol-hide point air-draught| command would hide both air-draught arrow and the corresponding label.] * |id <ext_keyword>| = ID of the symbol. 

{\it Type-specific options:}\Nobreak 

* |name <reference>| = if the point type is station, this option gives the reference to the real survey station. * |extend [prev[ious] <station>]| = if the point type is station and scrap projection is extended elevation, you can adjust the extension of the centreline using this option. * |scrap <reference>| = if the point type is section, this is a reference to a cross-section scrap. * |explored <length>| = if the point type is continuation, you can specify length of passages explored but not surveyed yet. This value is afterwards displayed in survey/cave statistics. * |text| = text of the label, remark or continuation. It may contain following formatting keywords:\[For SVG output, only |<br>|, |<thsp>|, |<it>|, |<bf>|, |<rm>| and |<lang:XX>| keywords are taken into account; all others are silently ignored.] 

|<br>| = line break 

|<center>|/|<centre>|, |<left>|, |<right>| = line alignment for multi-line labels. Ignored if there is no |<br>| tag. 

|<thsp>| = thin space 

|<rm>|, |<it>|, |<bf>|, |<ss>|, |<si>| = font switches 

\NEW{5.3} |<rtl>| and |</rtl>| = marks beginning and end of a right-to-left written text 

\NEW{5.3}|<lang:XX>| = creates multilingual label (see |string| type for detailed description) 

* |value| = value of height, passage-height or altitude label or point dimensions 

{\it height:} according to the sign of the value (positive, negative or unsigned), this type of symbol represents chimney height, pit depth or step height in general. The numeric value can be optionally followed by `|?|', if the value is presumed and units can be added (e.g.~|-value [40? ft]|). 

{\it passage-height:} the following four forms of value are supported: |+<number>| (the height of the ceiling), |-<number>| (the depth of the floor or water depth), |<number>| (the distance between floor and ceiling) and |[+<number> -<number>]| (the distance to ceiling and distance to floor). 

{\it altitude:} the value specified is the altitude difference from the nearest station. If the altitude value is prefixed by ``|fix|'' (e.g. |-value [fix 1300]|), this value is used as an absolute altitude. The value can optionally be followed by length units. 

{\it dimensions:} |-value [<above> <below> [<units>]]| specifies passage dimensions a\-bo\-ve/below centerline plane used in 3D model. \endoptions

\subsubchapter `line'. 

\description

Line is a command for drawing a line symbol on the map. Each line symbol is oriented and its visualization may depend on its orientation (e.g.~pitch edge ticks). The general rule is that the free space is on the left, rock on the right. Examples: the lower side of a pitch, higher side of a chimney and interior of a passage are on the left side of pitch, chimney or wall symbols, respectively. \enddescription

\syntax

|line <type> [OPTIONS] [OPTIONS] ... [LINE DATA] ... [OPTIONS] ... [LINE DATA] ... endline| \endsyntax

\context

scrap \endcontext

\arguments

* |<type>| is a keyword that determines the type of line. The following types are supported: 

{\it passages:} |wall|, |contour|, |slope|\[Slope line marks upper border of the sloping area. It's necessary to specify |l-size| in at least one point. Gradient lines length and orientation is an average of specified |l-size|s and |orientation|s in the nearest points. If there is no orientation specification, gradient marks are perpendicular to the slope line.], |floor-step|, |pit|, |ceiling-step|, |chimney|, |overhang|, |ceiling-meander|, |floor-meander|; 

{\it passage fills:} |flowstone|, |moonmilk|, |rock-border|\[Outer outline of large boulders. If the line is closed, it is filled with the background colour.], |rock-edge|\[Inner edges of large boulders.], |water-flow|; 

{\it labels:} |label|; 

{\it special:} |border|, |arrow|, |section|\[Line showing cross-section position.\NEW{5.3}\  If both control points (red dots) of a B\'ezier curve (grey line) are given then the section line (blue) is drawn up to the perpendicular projection (dotted) of the first control point and from the projection (dotted) of the section control point. No section curve is displayed.\hfil\break\MPpic{xsect.1}], |survey|\[Survey line is automatically drawn by Therion.], |map-connection|\[Used to indicate connection between maps (in offset, or the same points in extended elevation).], |u|\[For user defined line symbols.]. \endarguments

\comopt

* |subtype <keyword>| = determines line subtype. The following subtypes are supported for given types: 

{\it wall:} |invisible|, |bedrock| (default), |sand|, |clay|, |pebbles|, |debris|, |blocks|, |ice|, |underlying|, \NEW{5.4}|overlying|, |unsurveyed|, |presumed|, |pit|\[Usually open to surface.], |flowstone|, |moonmilk|; 

{\it border:} |visible| (default), |invisible|, |temporary|, |presumed|; 

{\it water-flow:} |permanent| (default), |conjectural|, |intermittent|; 

{\it survey:} |cave| (default), |surface| (default if centreline has surface flag). 

The subtype may be specified also directly in |<type>| specification using `|:|' as a separator.\[E.g.~|border:invisible|] 

Any subtype specification can be used with user defined type (|u|). In this case you need also to define corresponding metapost symbol (see the chapter {\it New map symbols}). 

* |[LINE DATA]| specify either the coordinates of a line segment |<x> <y>|, or coordinates of a B\'ezier curve arc |<c1x> <c1y> <c2x> <c2y> <x> <y>|, where |c| indicates the control point. * |close <on/off/auto>| = determines whether a line is closed or not * |mark <keyword>| = is used to mark the point on the line (see |join| command). * |orientation/orient <number>| = orientation of the symbols on the line. If not specified, it's perpendicular to the line on its left side. 0 $\le$ |number| $<$ 360. * |outline <in/out/none>| = determines whether the line serves as a border line for a scrap. Default value is `|out|' for walls, `|none|' for all other lines. Use |-outline in| for large pillars etc. * |reverse <on/off>| = whether points are given in reverse order. * |size <number>| = line width (left and right sizes are set to one half of this value) * |r-size <number>| = size of the line to the right * |l-size <number>| = same to the left. Required for |slope| type. * |smooth <on/off/auto>| = whether the line is smooth at the given point. Auto is default. * |adjust <horizontal/vertical>| = shifts the line point to be aligned horizontally/ver\-ti\-cally with the previous point (or next point if there is no previous point). The result is horizontal/vertical line segment). If all line points have this option, they are aligned to the average $y$ or $x$ coordinate, respectively. This option is not allowed in the |plan| projection. * |place <bottom/default/top>| = changes displaying order in the map. * |clip <on/off>| = specify whether a symbol is clipped by the scrap border. * |visibility <on/off>| = displays/hides the symbol. * |context <point/line/area> <symbol-type>| = (to be used with |symbol-hide| and |symbol-show| layout options) symbol will be hidden/shown according to rules for specified |<symbol-type>|. 

{\it Type-specific options:}\Nobreak 

* |altitude <value>| = can be specified only with the wall type. This option creates an altitude label on the wall. All altitudes are exported as a difference against grid $Z$ origin (which is 0 by default). If the value is specified, it gives the altitude difference of the point on the wall relative to the nearest station. The value can be prefixed by a keyword ``|fix|'', then no nearest station is taken into consideration; the absolute given value is used instead. Units can follow the value. Examples: |+4|, |[+4 m]|, |[fix 1510 m]|. * |border <on/off>| = this option can be specified only with the `slope' symbol type. It switches on/off the border line of the slope. * |direction <begin/end/both/none/point>| = can be used only with the section type. It indicates where to put a direction arrow on the section line. None is default. * |gradient <none/center/point>| = can be used only with the contour type and indicates where to put a gradient mark on the contour line. If there is no gradient specification, behaviour is symbol-set dependent (e.g. no tick in UIS, tick in the middle in SKBB). * |head <begin/end/both/none>| = can be used only with the arrow type and indicates where to put an arrow head. End is default. * |text <string>| = valid only for label lines. * \NEW{5.4}|height <value>| = height of pit or wall:pit; available in \MP\ as a numeric variable |ATTR__height|. \endcomopt

\options

* |id <ext_keyword>| = ID of the symbol. \endoptions

\subsubchapter `area'. 

\description

Area is specified by surrounding border lines. They may be of any type, but must be listed in order and each pair of consecutive lines must intersect. In order to be sure that lines intersect even after scrap transformation you may e.g.~continue a lake border 1\,cm behind a passage wall---these overlaps will be automatically clipped by scrap border. You may use invisible border to achieve this inside of the passage. 

\enddescription

\syntax

|area <type> place <bottom/default/top> clip <on/off> visibility <on/off> ... border line references ... endarea| \endsyntax

\context

scrap \endcontext

\arguments

* |<type>| is one of following: |water|, |sump|, |sand|, |debris|, |blocks|, |flowstone|, |moonmilk|, |snow|, |ice|, |clay|, |pebbles|, |bedrock|\[An empty area which can be used to clean the background.], |u|\[For user defined area symbols, may be followed by arbitrary subtype.]. \endarguments

\comopt

* the data lines consist of border line references (IDs) * |place <bottom/default/top>| = changes displaying order in the map. * |clip <on/off>| = specify whether a symbol is clipped by the scrap border. * |visibility <on/off>| = displays/hides the symbol. * |context <point/line/area> <symbol-type>| = (to be used with |symbol-hide| and |symbol-show| layout options) symbol will be hidden/shown according to rules for specified |<symbol-type>|. \endcomopt

\options

* |id <ext_keyword>| = ID of the symbol. \endoptions

\subsubchapter `join'. 

\description

Join works in two modes: it joins either two scraps or two or more points or lines in a map together. 

When joining more than two points or lines, use one join command for all of them, not a sequence of join commands for pairs.\[E.g. use |join a b c|, not |join a b| followed by |join b c|.] 

When joining scraps, only passage walls are joined. It's a good idea to place a scrap join in the passage which is as simple as possible, otherwise you have to specify join for each pair of objects which should be joined. \[If you want some object which is clipped by a scrap boundary to continue to a neighbouring scrap, use |-clip off| option for that object.] \enddescription

\syntax

|join <point1> <point2> ... <pointN> [OPTIONS]| \endsyntax

\context

none, scrap, survey \endcontext

\arguments

* |<pointX>| can be an ID of a point or line symbol, optionally followed by a line point mark |<id>:<mark>| (e.g.~|podangl_l31@podangl:mark1|). |<mark>| can be also `|end|' (end of the line) or line point index (where 0 is the first point). 

A special case is when |<point1>| and |<point2>| are scrap IDs---than the closest scrap ends are joined together. \endarguments

\options

* |smooth <on/off>| indicates whether two lines are to be connected smoothly. * |count <N>| (when used with scraps) = Therion will try to join scraps which connect in |N| locations/passages. \endoptions

\subsubchapter `equate'. 

\description

Устанавливает эквивалентность станций съемки. \enddescription

\syntax

|equate <список станций>| \endsyntax

\context

none, survey \endcontext

\subsubchapter `map'. 

\description

A map is a collection of either scraps or other maps of the same projection type. It's possible to include survey in the map---this will display centreline in the map. Map object simplifies the data management when selecting data for output. See the chapter {\it How the map is put together} for more thorough explanation. \enddescription

\syntax

|map <id> [OPTIONS] ... scrap, survey or other map references ... break ... next level scrap, survey or other map references ... preview <above/below> <other map id> endmap| \endsyntax

\context

none, survey \endcontext

\arguments

*|<id>| = scrap identifier \endarguments

\comopt

* the data lines consist of scrap or map references. Note that you can not mix them together. * if you refer to map, you can specify offset at which this sub-map will be displayed together with preview type of its original position. Syntax is following:\hfil\break |<map reference> [<offset X> <offset Y> <units>] <above/below/none>| * scraps following the |break| will be placed on another level * |preview <above/below> <other map id>| will put the outline of the other map in the specified preview position relative to the current map. 

Preview is displayed only if the map is in the |map-level| level as specified by the |select| command. 

Use the revise command if you want to add maps from higher levels to the preview. * |colo[u]r <color>| = set the map colour; this option overrides the automatic choice when the layout specifies |colour map-fg [map]|. \endcomopt

\options

* |projection/proj <plan/elevation/extended/none>| = required if the map contains survey. * |title <string>| = description of the object * |survey <id>| =\NEW{5.4} associate a survey with map (e.g.\ all surveying statistics from this survey will be used when this map is selected for output). \endoptions

\subsubchapter `surface'. 

\description

Surface (terrain) specification. It is possible to display it in two ways: as a scanned topographical map (both in 2D map and 3D model\[You need to enter elevation data in order to display the topographical map in 3D model. Currently only JPEG maps are supported in 3D.]) or surface grid -- digital elevation model (in 3D model only). \enddescription

\syntax

|surface [<name>] cs <coordinate system> bitmap <filename> <calibration> grid-units <units> grid <origin x> <origin y> <x spacing> <y spacing> <x count> <y count> grid-flip (none)/vertical/horizontal [grid data] endsurface| \endsyntax

\context

none, survey \endcontext

\comopt

* |cs <coordinate system>| = coordinate system for bitmap calibration and grid origin specification * |bitmap <filename> <calibration>| = scanned topographical map. 

|calibration| may have two forms: 

1. |[X1 Y1 x1 y1 X2 Y2 x2 y2 [units]]|, where upper case X/Y variables are picture coordinates (pixels; lower-left corner is |0 0|), lower-case x/y variables are real coordinates. Optional units apply to real coordinates (metres by default). 

2. |[X1 Y1 station1 X2 Y2 station2]|, where upper case X/Y variables are picture coordinates and |station1| and |station2| are survey stations names. 

* |grid-units <units>| = units in which grid is specified. Metres by default. 

* |grid <origin x> <origin y> <x spacing> <y spacing> <x count> <y count>| 

|<origin x> <origin y>| = specify coordinates of the lower-left (S-W) corner of the grid 

|<x spacing> <y spacing>| = distance between grid nodes in W-E and S-N directions 

|<x count> <y count>| = number of nodes in the row and number of rows which form the grid (see below). 

* |[grid data]| = a stream of numbers giving the altitude a.s.l.~in grid nodes. It starts in the grid-origin and fills the grid in rows (in the row from W to E; rows from S to N). 

* |grid-flip (none)/vertical/horizontal| = useful if your grid (exported from other program) needs to be flipped 

\endcomopt

\subsubchapter `import'. 

\description

Reads survey data in different formats (currently processed centreline in *.3d, *.plt, *.xyz formats). Survey stations may be referenced in scraps etc. When importing Survex' 3D file, stations are inserted in survey hierarchy, if there exists identical hierarchy to that in 3D file. \enddescription

\syntax

|import <file-name> [OPTIONS]| \endsyntax

\context

survey / all\[only with .3d files, where survey structure is specified] \endcontext

\options

* |filter <prefix>| = if specified, only stations with given prefix and shots between them will be imported. Prefix will be removed from station names. * |surveys (create)/use/ignore| = specifies how to import survey structure (works only with .3d files). 

|create| = split stations into subsurveys, if subsurveys do not exist, create them 

|use| = split stations into existing subsurveys 

|ignore| = do not split stations into sub-surveys * |cs <coordinate system>| = coordinate system for stations with fixed coordinates * |calibrate [<x> <y> <z> <X> <Y> <Z>]| = coordinates in the imported file are shifted from lower-case coordinates to upper-case coordinates. \endoptions

\subsubchapter `grade'. 

\description

This command is used to store predefined precisions of centreline data. See |sd| option description for |centreline| command. \enddescription

\syntax: |grade <id> ... [<quantity list> <value> <units>] ... endgrade| \endsyntax

\context

all \endcontext

\subsubchapter `revise'. 

\description

This command is used to set or change properties of an already existing object. \enddescription

\syntax

The syntax of this command for object created with ``single line'' command is 

|revise id [-option1 value1 -option2 value2 ...]| 

For objects created with ``multi line'' commands is syntax following 

|revise id [-option1 value1 -option2 value2 ...] ... optionX valueX data ... endrevise| \endsyntax

\context

all \endcontext

\arguments

The id stands for object identifier (the id of an object you want to revise must always be specified). \endarguments

\subchapter Custom attributes. 

Objects {\it survey}, {\it centreline}, {\it scrap}, {\it point}, {\it line}, {\it area}, {\it map} and {\it surface} can contain user-defined attributes in a form |-attr <name> <value>|. |<name>| may contain alphanumeric characters, |<value>| is a string. 

The custom attributes are used in map export depending on output format: \list

* in {\it shapefile} export they are written directly to the associated dbf file, * in maps generated using \MP\ (PDF, SVG) the attributes are written in the \MP\ source file as strings (named like |ATTR_<name>|) and can be evaluated and used by user in symbols definition macros. 

You can test presence of such a variable using |if known ATTR_<name>: ... fi|. 

\endlist

\subchapter XTherion. 

XTherion -- графический пользовательский интерфейс для Therion. Он помо\-гает в создании файлов входных данных. В настоящее время он работает в трех основных режимах: текстовый редактор, редактор карт и компилятор. \[Здесь мы обсуждаем созданием данных, поэтому в этом разделе описаны только два первых режима. Функции компилятора смотрите в главе Обработка данных.] 

Его не обязательно использовать для Therion -- вы можете редактировать входные файлы в своем любимом текстовом редакторе и запускать Therion из командной строки. XTherion также не является единственным гра\-фи\-чес\-ким интерфейсом, который можно использовать с Therion.
 Можно написать лучшую, более удобную для пользователя, более WYSIWYG, быструю, более надежную и удобную в использовании. Есть желающие? 

В этом руководстве не описываются такие знакомые вещи, как `если вы хотите сохранить файл, перейдите в меню Файл и выберите Сохранить или нажмите Ctrl-s'. Просмотрите верхнее меню, чтобы почувствовать XTherion. 

Для каждого режима работы есть дополнительное меню справа или слева. Подменю могут быть свернуты; вы можете развернуть их, нажав кнопку меню. Для большинства меню и кнопок в строке состояния есть короткое описание, поэтому нетрудно догадаться о значении каждого из них. Показ подменю сбоку может быть настроен пользователем. Right-click on the menu button and select in the menu which of the other menus it should be swapped with. 

\subsubchapter XTherion -- текстовый редактор. 

Текстовый редактор XTherion предлагает некоторые интересные функции, которые могут помочь в создании текстовых входных файлов: поддержка кодировки Unicode и возможность открытия нескольких файлов. \[Кодировка файла указана в первой строке файла. Эта строка скрыта XTherion'ом и может быть доступна только косвенно, используя правое меню.]
 

Чтобы упростить ввод данных, он поддерживает форматирование таблиц нитки хода. Для ввода данных существует меню {\it Таблица данных}. Она может быть настроена на ввод данных пользователя, нажав кнопку {\it Определить формат данных}, когда курсор находится под спецификацией данных (опция `дата' в команде `centreline').
 

\subsubchapter XTherion -- редактор карт. 

Редактор карт позволяет вам рисовать и редактировать карту полностью в интерактивном режиме. Но не ожидайте слишком многого. XTherion не является редактором WYSIWYG. Он отображает только позицию, а не фактическую форму, нарисованных точек или линий. Визуально нет ника\-кой разницы между геликтитом и текстовой меткой -- оба они отображаются как простые точки.
 Тип и другие атрибуты любого объекта указываются только в меню {\it Точка} и {\it Линия}. 

\ifx\pdfoutput\undefined\else \leavevmode\llap{\smash{\raise10pt\hbox{\pdfannot width 6cm height 0cm depth 4cm {/Subtype /Text /Name /Help /Contents (Hints: 1. What does loop closure do? 2. Why do we use MetaPost?) }}} \qquad}\fi {\it Упражнение:} Найдите две существенные причины, почему карта, нари\-со\-ван\-ная в XTherion, не может быть идентична выходу Therion. (Если вы ответите на это, вы узнаете, почему XTherion никогда не будет истинным редактором WYSIWYG. Лень авторов -- не правильный ответ.) 

Начнем с описания типичного использования редактора карт. Во-первых, вам нужно решить, какую часть пещеры (какой скрап) вы рисуете. \[В одном файле можно нарисовать несколько скрапов, в этом случае все неактивные скрапы отображаются желтым.] 

После создания нового файла в редакторе карт вы можете загрузить одно или несколько {\bf изображений} -- сканированные эскизы съемки пещеры\[XTherion не может масштабировать и поворачивать отдельные изображения, поэтому используйте ту же ориентацию, масштаб и DPI для всех изображений, используемых в одном и том же скрапе.] -- в качестве подложки для рисования. Нажмите кнопку {\it Вставка} в меню {\it Фоновые изображения}. К сожалению, из-за ограничений языка Tcl/Tk, под\-дер\-жи\-ва\-ются только изображения в форматах GIF, PNM и PPM (плюс PNG и JPEG, если вы установили расширение tkImg). Кроме того, XTherion поддерживает XVI (XTherion vector image), в котором отображается нитка хода и LRUD, и данные PocketTopo экспортируются в формат Therion'а (см. ниже). Все добавленные изображения помещаются в верхний левый угол рабочей области. Переместите их можно двойным щелчком правой кнопкой мыши на изображении и перетаскиванием или через меню. Для повышения про\-из\-во\-ди\-тель\-ности на более медленных компьютерах можно временно вы\-гру\-зить неиспользуемое изображение из памяти, сняв флажок {\it показать}. Можно открыть существующий файл без загрузки фоновых изображений с по\-мощью меню {\it Открыть (без картинок)}. \[{Примечание:} Therion никак не использует фоновые изображения, если вы не назначили их для определенного скрапа с помощью опции |-sketch|.] 

Размер и масштабирование {\bf области рисования} настраивается в соот\-вет\-ству\-ющем меню.
 {\it Авто} вычисляет оптимальный размер рабочей области в соот\-вет\-ствии с размерами и позициями загруженных фоновых изображений. 

После этих этапов подготовки вы готовы к рисованию или, точнее, для {\bf создания файла данных карты}. Важно помнить, что вы на самом деле создаете текстовый файл, который должен соответствовать синтаксису, опи\-сан\-ному в главе {\it Формат данных}. На самом деле в редакторе карт исполь\-зу\-ются только несколько команд Therion'а: многострочная команда |scrap ... endscrap| может содержать команды |point|, |line| и |area|. (См. главу {\it Формат данных}). Это соответствует этапу ручного рисованния карты, которая стро\-ится из точек, линий и заполненных областей.
 

Итак, первым шагом является определение {\bf скрапа} с помощью |scrap ... endscrap| многострочной команды. В меню {\it Команды в файле} выберите подменю {\it Действие} и выберите {\it Вставить скрап}. Это изменит кнопку {\it Действие} на {\it Вставить скрап}, если у нее было другое значение. После нажатия этой кнопки в начало файла будет вставлен новый скрап. Вы должны видеть строки 

|scrap - scrap1
endscrap
end of file| 

в окне предварительного просмотра над кнопкой {\it Вставить скрап}. Это окно представляет собой упрощенный вывод текстового файла, который будет сохранен XTherion'ом. Показаваются только команды (|scrap|, |point|, |line|, |text| -- почему так, смотрите ниже) и их типы (для |point| и |line|) или ID (для |scrap|).
 

Полное содержимое любой команды отображается в меню {\it Просмотр коман\-ды}. 

Для изменения ранее созданных команд есть дополнительные меню -- напри\-мер {\it Скрап} для команды |scrap|. Здесь вы можете изменить ID (очень важно!) и другие опции. Подробнее смотрите главу {\it Формат данных}. 

Теперь можно вставить некоторые {\bf точечные символы}. Как и в случае встав\-ки скрапа, перейдите в меню {\it Команды в файле}, нажмите подменю {\it Действие} и выберите {\it Вставить точку}; затем нажать кнопку с изменившимся наз\-ва\-нием на {\it Вставить точку}. Сочетание клавишь для этого -- Ctrl-p. Затем нажмите на нужное место в рабочей области, и вы увидите синюю точку, представляющую символ точки. Ее атрибуты можно настроить в меню {\it Точка}. Вы останетесь в режиме `вставки' -- каждый щелчок по рабочей области добавляет новый символ точки. Старайтесь не нажимать дважды в одном месте -- тогда вы вставите два точечных символа в одном и том же месте!
 Чтобы выйти из режима `вставить', нажмите клавишу {\it Esc} на клавиатуре или кнопку {\it Выбрать} в меню {\it Команды в файле}. 

Каков порядок команд в выходном файле? Точно такой же, как в меню {\it Команды в файле}. Вновь созданные точечные, линейные и текстовые объ\-екты добавляются перед текущей выделенной строкой. Можно изменить порядок, выбрав строку и нажав кнопки {\it Вниз}, {\it Вверх} или {\it Переместить} в меню {\it Команды в файле}. Таким образом вы также можете перемещать объекты между скрапами. 

{\bf Рисование линий} аналогично рисованию в других программах редактирова\-ния векторной графики, которые работают с кривыми Безье. (Угадайте, как войти в режим вставки линии кроме использования сочетания Ctrl-l.) Нажмите, где должна быть первая точка, затем перетащите мышь с нажатой левой кнопкой и отпустите ее в том месте, где должна быть первая контрольная точка. Затем нажмите где-нибудь еще (эта точка будет второй точкой кривой) и перетащите мышь (отрегулируйте вторую контрольную точку предыдущей дуги и первую контрольную точку следующего дуги, одновременно). Если это объяснение кажется слишком неясным, вы может поработать в некоторых стандартных векторных редакторах. Линия будет завершена после выхода из режима вставки. Начало и ориентация линии отмечены небольшой оранжевой галочкой в первой точке. 

Для символов линии существуют два управляющих меню: {\it Линия} и {\it Точка линии}. Сначала устанавливаются атрибуты для всей кривой, такие как тип или имя. Важным является чек-бокс {\it обратная}: Therion требует ори\-ен\-ти\-ро\-ван\-ных кривых, и нет ничего необычного в том, что вы начинаете рисовать с неправильного конца. Меню {\it Точка линии} позволяет вам отрегулировать атрибуты любой выбранной точки на линии, например, сглаживание кривой в этой точке (которая включена по умолчанию) или наличие соседних кон\-троль\-ных точек (`|<<|' и `|>>|').
 

{\bf Области} определяются окружающими их линиями. Нажмите {\it Вставить об\-ласть}, а затем щелкните строки окружающие нужную область. Они авто\-ма\-ти\-чески вставляются в {\it Область} и называются (если они еще не названы). Альтернативный способ вставить их как |text| \[ВНИМАНИЕ! Команда |text| -- это не команда Therion'а! Это всего лишь псевдоним для блока произвольного текста в XTherion. В файле, сохраненном XTherion'ом, будет только то, что вы введете в {Редакторе} или смотрите в {Просмотре команд}. Это может быть определение области или что угодно, например комментарий, начинающийся с символа `|\#|'.], содержимое которого (вве\-ден\-ное в меню {\it Редактор} в редакторе карты) обычно многострочная команда |area ... endarea| (см. раздел {\it Формат данных}.)
 

%
Если вы нарисуете несколько скрапов с |none| проекцией, необходимо {\bf отка\-либ\-ро\-вать} область рисования. Масштаб можно определить только одним способом в XTherion -- используя координаты двух точек (заданных как в системе координат изображения, так и в `реальной' системе координат). 

После выбора скрапа (щелкните по его заголовку в меню {\it Команды в файле}) появятся два небольших красных квадрата, соединенных красной стрелкой (по умолчанию они будут в нижних углах области рисования). Вы должны перетащить их в точки с известными координатами -- обычно пересечения линий сетки на миллиметровке на отсканированном чертеже. Если вы не видите их, вы можете: \list

* нажать кнопку {\it Масштаб} в меню {\it Скрап} и щелкнуть два разных места на изображении, где должны быть конечные точки калибровочной стрелки, или * переместить указатель мыши в нужную позицию, прочитать координаты указателя и ввести эти координаты в {\it масштабирующие точки для кар\-тинки} в меню {\it Скрап}.
 После заполнения пар координат X1, Y1 и X2, Y2 стрелка калибровки будет перемещаться соответственно. \endlist

Затем вам нужно ввести реальные координаты этих точек (X1, Y1, X2, Y2). 

В {\bf режиме выбора} вы можете выбрать существующие линейные или точеч\-ные объекты и установить их атрибуты в соответствующих меню, пере\-мес\-тить их или удалить их (Ctrl-d или {\it Кнопка действия} в меню {\it Команды в файле} после установки {\it Действие} на {\it Удалить}). 

% [adding or deleting a point on the curve]
Существует меню {\it Поиск и выделение}, которое позволяет легко переклю\-чаться между объектами и показывать элементы, которые вы не видите при взгляде на изображение. Например, если вы введете слово `station' и нажмите {\it Показать все}, все станции на экране станут красными. 

XTherion не выполняет проверку синтаксиса; он только записывает объекты с атрибутами в текстовый файл. Любые ошибки обнаруживаются только при обработке этих файлов с помощью Therion. 

СОВЕТ. Ввод символов одного и того же типа одновременно экономит вам много времени, потому что вам не нужно менять тип символа и параметры заполнения для каждого нового символа. Поле {\it Опции} сохраняет старое значение, и достаточно изменить всего несколько символов. \[В случае станций съемки XTherion автоматически увеличивает номер станции для сле\-дую\-щего вставленного символа.] Рекомендуется начать с рисования всех станций съемки (не забудьте дать им имена (номера) в соответствии с настоящими именами в команде centreline), далее все хода, за которыми следуют все остальные точечные символы, линии и области. В конец рисуем поперечные сечения. 

\subsubchapter Дополнительные инструменты. 

\NEW{5.3}{\bf Помощь/Привязать изображение} создает файл MAP совместимый с OziExplorer на основе геоданных включенных в карту PDF\[Может присутствовать до девяти калибровочных точек в виде фиксированных станций в нитке хода с использованием геодезической системы координат.].
 

Если карта в формате PDF была преобразована в растровое изо\-бра\-же\-ние с использованием внешней программы, конвертер использует растровое изо\-бра\-же\-ние {\it и} pdf-карту с тем же базовым именем, расположенным в том же каталоге, для вычисления калибровочных данных.
 

Если используется непосредственно файл PDF, то вам необходимо уста\-но\-вить DPI и формат вывода перед автоматическим преобразованием \[|Ghostscript| и |convert| должны быть установлены в вашей системе. Обратите внимание, что установщик Windows не содержит |ghostscript|.] в растровый формат. 

\NEW{5.3}{\bf Данные PocketTopo} экспортированные в формате Therion'а\[Это специальный текстовый формат, который нужно импортировать с помощью XTherion'а и не может обрабатываться непосредственно Therion'ом.] из приложения PocketTopo можно импортировать в текстовом редакторе, а также в редак\-торе карт ({\it Файл $\to$ Импорт $\to$ PocketTopo therion export} и {\it Фоновые изоб\-ра\-же\-ния $\to$ Вставить $\to$ PocketTopo therion export}). Тот же файл используется для обоих импортов. Импорт эскиза напрямую не создает данные скрапа. Рисунок просто отображается на фоне как сканированное растровое изобра\-жение, и должен быть оцифрован вручную. 

\subsubchapter Сочитания клавишь и мыши в редакторе карт. {\it Общие} \list

* Ctrl+Z = отменить изменения; * Ctrl+Y = вернуть изменения; * F9 = компилировать текущий проект; * для выбора объекта в списке с помощью клавиатуры: переключайтесь с помощью `Tab' в желаемый список; перемещаться на нужный объект (объект подчеркивается); нажмите `Пробел'; * PageUp/PageDown = скролинг вверх/вниз в боковой панели; * Shift+PageUp/PageDown = скролинг вверх/вниз в окне Команды в файле. \endlist

{\it Область рисования и фоновые изображения} \list

* клик правой кнопкой мыши = скролинг области рисования; * двойной щелчок правой кнопкой мыши по изображению = перемещение изображения. \endlist

{\it Вставка скрапа} \list

* Ctrl+R = вставить скрап. \endlist

{\it Вставка линии} \list

* Crtl+L = вставить новую линию и войти в режим `вставка точек линии'; * щелчек левой кнопкой мыши = вставить точку линии (без контрольных точек) * Ctrl+щелчек левой кнопкой мыши = вставить точку линии очень близко к существующей точке (обычно она вставляется на ближайшую существую\-щую точку); * щелчек левой кнопкой мыши+тянуть = вставить точку линии (с контроль\-ными точками); * удерживать Ctrl при перемещении = изменить расстояние предыдущей контрольной точки; * щелчек левой кнопкой мыши+переместить контрольную точку = перемес\-тить ее положение; * щелчек правой кнопкой мыши на одной из предыдущих точек = выбирает предыдущую точку в режиме вставки (полезно, если вы хотите изменить также направление предыдущей контрольной точки); * Esc или щелчек левой кнопкой мыши на последней точке = завершение вставки линии; * щелчек левой кнопкой мыши на первой точке линии = замкнуть линию и завершить вставку линии. \endlist

{\it Редактирование линии} \list

* щелчок левой кнопкой мыши+перемещение = перемещение точки линии; * Ctrl+щелчок левой кнопкой мыши+перемещение = перемещение точки линии близко к существующей точке (обычно она перемещается на бли\-жайшую существующую точку); * щелчок левой кнопкой мыши на контрольной точке+перемещение = пере\-местить контрольную точку. \endlist

{\it Добавление точки линии} \list

* выберите точку, перед которой вы хотите вставить новые точки; вставить необходимые точки; нажмите Esc или щелкните левой кнопкой мыши по выбранной вами точке в начале. \endlist

{\it Удаление точки линии} \list

* выберите точку, которую хотите удалить; нажмите {\it Править линию} $\to$ {\it Удалить точку} в панели {\it Линия}. \endlist

{\it Раздиление линии} \list

* выберите точку, в которой вы хотите разделить линию; нажмите {\it Править линию} $\to$ {\it Разделить линию} в панели {\it Линия}. \endlist

{\it Вставка точек} \list

* Ctrl+P = переход в режим `вставки точки'; * щелчок левой кнопкой мыши = вставка точки в заданной позицию; * Ctrl+щелчок левой кнопкой мыши = вставка точки очень близко к сущест\-вующей точке (обычно она будет вставлена на ближайшую точку); * Esc = выход из режим `вставки точки'. \endlist

{\it Редактирование точки} \list

* щелчок левой кнопкой мыши+перетаскивание = перемещение точки; * Ctrl+щелчок левой кнопкой мыши+перетаскивание = перемещение точки близко к существующей точке (обычно она перемещается на ближайшую существующую точку); * щелчок левой кнопкой мыши+перетаскивание стрелок точки = изменение ориентации и/или размера точки (согласно заданным переключателям в панели управления точки). \endlist

{\it Вставка области} \list

* нажмите Ctrl+A или {\it Команды в файле} $\to$ {\it Вставить} $\to$ {\it область}, чтобы переключиться в режим `вставки границ области'; * щелчок правой кнопкой мыши на линиях, которые окружают желаемую область; * Esc, чтобы закончить ввод границ области. \endlist

{\it Редактирование области} \list

* выберите область, которую вы хотите отредактировать; * нажмите `Вставить' в {\it Область}, чтобы вставить другие границы в текущую позицию курсора; * нажмите `Вставить по ID', чтобы вставить границу с заданным ID в теку\-щую позицию курсора; * нажмите `Delete', чтобы удалить выбранную границу области. \endlist

{\it Выбор существующего объекта} \list

* щелчок левой кнопкой мыши = выбрать верхний объект; * щелчок правой кнопкой мыши = выбрать объект под верхним объектом (полезно, когда несколько точек лежат друг над другом).  \endlist

\subchapter Несколько мыслей о Therion'е. 

Несмотря на то, что все (ну, почти все) о входных файлах Therion'а было сказано, в этой главе приведены некоторые дополнительные советы и под\-сказки. 

\subsubchapter Как ввести нитку хода?. 

Основным блоком построения карт является команда |centreline|. Если пещера больше нескольких метров, неплохо было бы разделить данные в большем количестве файлов и отделить данные нитки хода от данных карты.
 

Обычно мы используем один |*.th| файл содержащий нитку хода для каждой отдельной съемки. Удобно начинать с пустого файла шаблона, как показано ниже, где точки будут заменены соответствующим текстом. 

|encoding ISO8859-1
survey ... -title "..."
	centreline
		team "..."
		team "..."
		date ...
		units clino compass grad
		data normal from to compass clino length
			... ... ... ... ...
	endcentreline
endsurvey| 

Чтобы создать уникальное пространство имен команда |centreline| заключена в команду |syrvey| ... |endsurvey|. Это полезно, если survey имеет то же имя, что и файл, который его содержит. \[Например |survey entrance| в файле |entry.th|.] На точки можно будет ссылаться используя символ |@| -- смотрите описание команды |survey|. 

Для действительно больших пещер можно построить иерархическую струк\-туру каталогов. В этом случае мы создаем один специальный файл с именем |INDEX.th| который включает все остальные |*.th| файлы из данного каталога и содержит команды |equate| для определения связей между съемками. 

\subsubchapter Как рисовать карты?. 

Самое главное -- придумать деление пещеры на скрапы. Скрап является основным блоком карты. Попытка подобрать скрап к соответствующему |*.th| файлу с ниткой хода одной съемки -- это почти всегда {\itплохая\/} идея. Причина в том, что соединения между скрапами должны быть как можно более простыми. Скрапы в целом независимы от иерархии нитки хода, поэтому старайтесь не привязываться к съемке когда рисуете карты и вы\-би\-ра\-ете лучшие объединения скрапов. 

We usually insert maps in the last-but-one level in survey hierarchy.\[Remember that surveys create namespaces, so you may reference only objects in the given survey and all subsurveys.] Each scrap may than contain arbitrary part of any survey in the last level of hierarchy. Например, есть survey |main| который содержит surveys |a|, |b|, |c| и |d|. Surveys |a| -- |d| содержат данные нитки хода от четырех съемок, и каждый из них находится в отдельном файле. Есть карта |main_map| которая содержит скрапы |s1| и |s2|. Если |main_map| находится в survey |main|, скрап |s1| может содержать часть нитки хода из survey |a|, полную нитку хода |b| и часть |c|; |s2| будет содержать часть |a| и |c| и полную нитку |d|. Названия станций survey будут иметь символ |@| (например, |1@a|). \[Если вы подключаете файлы карт в начале survey, вы можете ссылаться на любую станцию в любом скрапе, что представляет собой очень гибким инструмент. С другой стороны вы можете использовать более длинные имена в ссылках на станции, например |3@dno.katakomby.jmn.dumbier|.] 

Скрапы обычно хранятся в |*.th2| файлах. Каждый файл может содержать несколько скрапов. Чтобы данные были хорошо организованы, мы приняли несколько соглашений об именах файлов: в файле |foo.th2| все скрапы име\-ну\-ются |foo_si|, где |i| -- |1|, |2| и так далее. Поперечные сечения именуются |foo_ci|, линии |foo_li| и т.п. Это очень помогает с большими пещерными системами; если упоминается какой-то скрап, вы сразу же знаете в каком файле он был определен. 

Можно создавать один файл |INDEX.th2| на каталог, который подключает все |*.th2| файлы, описывает maps и объединения скрапов. 

При рисовании скрапов вы должны проверить, правильно ли определен контур: все линии создающие внешнюю границу ходов должны иметь опцию |-outline out|; все линии окружающие внутренние колонны опцию |-outline in|. Границы скрапа не могут пересекаться, иначе внутренняя сторона скрапа не может быть определена. Есть два простых теста, которые определяют правильность скрапа: \list

* не выводится предупреждение \MP\  ``|scrap outline intersects itself|''; * когда вы устанавливаете цвет заливки ходов (|color map-fg <номер>| опция в |layout|), вы можете видеть что Therion считает внутренней областью скрапа. \endlist

\subsubchapter Как создавать модели?. 

Модель создается из внешних линий скрапов. Высота и глубина хода вычис\-ля\-ются по символьным точкам |высота хода| (|passage-height|) и |размер хода| (|dimensions|). 

\subchapter Therion in depth. 

\subsubchapter Как карта собирается в единое целое. 

В этой главе объясняется работа опций |-clip|, |-place|, |-visibility| и |-context | команд |point|, |line| и |area|. Также объясняются опции |color|, |transparent |, |symbol-hide| и |symbol-show| команды |layout|. 

При экспорте карты Therion должен определить три атрибута для каждого из символов -- точки, линии или области: видимость, подрезание и упо\-ря\-до\-че\-ние. 

(1) Символ отображается, если верно следующее: 

\list

* он имеет опцию |-visibility| со значением |on| (все символы по умолчанию); * он не был скрыт опцией |-symbol-hide| в layout; * если его опция |-context| установлена, а соответствующий символ не был скрыт опцией |-symbol-hide| в layout. \endlist

Экспортируются только видимые символы. 

(2) Некоторые символы могут подрезаться абрисом скрапа. По умолчанию это все следующие объекты: \list

* {\it точечные символы:} символы наполнения ходов (почва\dots гуано); * {\it линейные символы:} все символы линий, которые не имеют опцию |-outline|, за исключением |section| (|выносная линия сечения|), |arrow| (|стрелка|), |label| (|текстовая метка|), |gradient| (|уклон хода|) и |water-flow| (|водоток|); * {\it символы области:} все. \endlist

Значение по умолчанию может быть изменено с помощью опции |-clip|, если это разрешено для определенного символа. Все остальные символы не под\-ре\-за\-ются границей скрапа. 

Упорядочевание: каждый символ относится к одной из следующих групп, которые последовательно выводятся: 

\list

* bottom = все символы с опцией |-place bottom|; * default-bottom = все символы |области| по умолчанию; * default = символы, которые не принадлежат ни к какой другой группе; * default-top =  |ceiling-step| (|уступ потолка|) и |chimney| (|камин|) по умолчанию; * top = все символы с опцией |-place top|. \endlist

Порядок символов внутри каждой группы соответствует порядку команд во входном файле\[Или в меню {Команды в файле} XTherion'а.]: символы, которые идут первыми, нарисованы последними (т.е. они отображаются в верхней части каждой группы). 

Теперь мы готовы описать как строится карта (или атлас): 

\list\obeyspaces\obeylines * область карты заполняется |color map-bg|; * растровые изображения поверхности отображаются, если |surface| установ\-лен в |bottom|; * ДЛЯ каждого скрапа: абрисы заполняются белым; * рисуется сетка если |grid| установлен в |bottom|; * анонс внизу \[Согласно спецификации опции |preview| в команде |map|.] заполняется |color preview-below|; * ДЛЯ каждого уровня\[Уровень -- это коллекция скрапов не разделенная |break| в команде |map|.]:
      НАЧАЛО отсечения
           ДЛЯ каждого скрапа: абрис заполняется |color map-fg|
           ДЛЯ каждого скрапа: символы |области| заполняются и отсекаются
           до границы скрапа
      КОНЕЦ отсечения
      НАЧАЛО отсечения текстовых меток (для всех текстовых меток на
      этом и верхних уровнях)
            ДЛЯ каждого скрапа:
                  рисуются все символы прошедшие отсечение (за исключе-
                     нием |line survey|), упорядочиваются снизу вверх
                  рисуются |line survey| символы
                  отсекаются границы скрапов
            ДЛЯ каждого скрапа:
                  рисуются все неотсеченные символы (за исключением
                     |point station| и всех текстовых меток), упорядочеваются
                     снизу вверх
                  рисуются |point station| символы
      КОНЕЦ отсечения текстовых меток
      ДЛЯ каждого скрапа: рисуются все (точечные и линейные) текстовые
         метки (в том числе |wall-altitude|); * анонс рисуется поверх с |color preview-above|; * растровые изображения поверхности отображаются если |surface| установ\-лен в |top|; * сетка отображается если |grid| установлен в |top|. \endlist

%%
\endinput

