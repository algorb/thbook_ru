\subchapter {Рисование карт в Therion'е}. 

\fitpic{../samples.doc/000031-rabbit-plan.pdf} 

\fitpic{../samples.doc/000032-rabbit-xelev.pdf} 

\subchapter {Список пещер}. 

При съемке пещер на какой-то большой территории вам часто нужно создать список всех пещер на этой территории. В наборе данных, "пещера" может быть определена несколькими способами, в зависимости от уровня пещерной съемки. 

Если у вас есть станция на входе с известными координатами (например, используя GPS или стандартные методы съемки), все, что вам нужно сделать, это назначить флаг |entrance| (вход) 

|station cave-1 "Не снятая пещера" entrance | 

Если за этим входом есть какой-то разведанный проход, но вы не\break обследовали его должным образом, вы должны добавить также флаги\break |continuation| (продолжение) и |explored| (исследование), за которым следует исследуемая длина. Исследуемые, но не отснятые хода также являются частью сводной статистики. 

|station cave-2 "Не снятая, но исследованная" entrance \continuation explored 80m | 

Если вы как следует отсняли какую-то пещеру, ее данные обычно находятся в некоторых |survey|. Съемка становится пещерой, если у нее есть станция с опцией |-entrance|. Пример: 

|survey small_cave -title "Пещера Туннель" -entrance 0 | 

Если съемка содержит данные, но не указан главный входа, то съемка не считается пещерой, как единица организации данных и, таким образом, не присутствует в списке пещер. В итоговой таблице присутствуют только съемки, содержащие пещеры (т.е. входные станции или съемки с основным входом). 

После того, как пещеры в ваших данных были правильно определены, вы можете создать таблицу, используя 

|export cave-list -o caves.html | 

Итоговая таблица выглядит так: 

\bigskip\begingroup\input etc/TXSruled.tex \LeftJustifyTables\ruledtable {\bf Наименование}&{\bf Длина}&{\bf Глубина}&{\bf Исследовано}&{\bf Высота н.у.м.}\cr Пещера Туннель&25&7& &1244.0\nr Не снятая пещера& &&&1234.0\nr Не снятая, но исследованная& &&80&1256.0\endruledtable\endgroup\bigskip \subchapter {Символы площади}. 

\fitpic{../samples.doc/000011-types.pdf} 

\subchapter {Морфинг эскиза}. 

Оригинальный эскиз съемки: 

\fitpic{../samples.doc/000012-cave1.jpg} 

Изображение после морфинга: 

\fitpic{../samples.doc/000013-cave1.pdf} 

Стены после морфинга: 

\fitpic{../samples.doc/000014-cave2.pdf} 

Другой эскиз съемки: 

\fitpic{../samples.doc/000015-cave.png} 

Это изображение после морфинга: 

\fitpic{../samples.doc/000016-cave1.pdf} 

Эскиз подвергшийся морфингу после вставки точек {\it extra}: 

\fitpic{../samples.doc/000017-cave2.pdf} 

И морфинг стен: 

\fitpic{../samples.doc/000018-cave3.pdf} 

\subchapter {Управление разрез-разверткой}. 

Предположим следующую ситуацию (в плане) -- есть кольцо нитки хода между станциями 1 и 4, небольшая труба возле станции 5 и вход в пещеру находится на станции 6. 

\fitpic{../samples.doc/000019-map1p.pdf} 

По умолчанию разрез-развертка этой ситуации выглядит следующим\break образом: 

\fitpic{../samples.doc/000020-map1x.pdf} 

Очевидно это не то, что мы хотели бы получить. 

Чтобы контролировать процесс развертки существует специальная опция |extend| команды centerline. 

Прежде всего, мы хотели бы начать нашу разрез-развертку на станции 6 (где находится вход). Это можно сделать, указав 

|extend start 6 | 

в centerline. Теперь это выглядит лучше, 

\fitpic{../samples.doc/000021-map2.pdf} 

но по-прежнему существует проблема с ниткой, содержащей станцию 5. 

Если мы хотим начать эту нитку со станции 4, нам необходимо запретить Therion'у разворот станции 5 из станции 1. Это можно сделать, указав 

|extend ignore 1 5 | 

Это означает, что замер со станции 1 на станцию 5 будет проигнорирован, когда генерируется разрез-развертка. 

Если мы хотим развернуть нитку начиная со станции 5 влево, нам нужно указать также 

|extend left 5 | 

Это команда будет разворачивать все станции со станции 5 влево. 

\fitpic{../samples.doc/000022-map3.pdf} 

Как мы уже упоминали ранее, на станции 5 имеется небольшая труба. В этом случае гораздо более естественно сделать этот замер вертикальным (потому что это труба). Чтобы сделать это, используйте 

| extend vertical 5 5' | 

\fitpic{../samples.doc/000023-map6.pdf} 

Или вы можете полностью скрыть этот замер, используя: 

| extend hide 5 5' | 

\fitpic{../samples.doc/000024-map7.pdf} 

\subsubchapter {Станции в скрапах разрез-развертки}. 

Даже если станция 1 присутствует более одного раза на карте, Therion автоматически определяет правильное положение этой станции в каждом скрапе, и они обычно рисуются правильно. 

\fitpic{../samples.doc/000025-map4.pdf} 

Единственное, чего не хватает, это линия соединения между станциями 1 в этих двух нитках. Therion автоматически не генерирует эти линии, потому что их форма обычно зависит от конкретной карты. 

Чтобы нарисовать такую линию, вам нужно всего лишь создать простой скрап с этой линией. Вот пример: 

|scrap sc -proj extended point 0 0 station -name 1 -from 5 -visibility off point 100 0 station -name 1 -from 2 -visibility off line map-connection 0 5 0 15 100 15 100 5 endline endscrap | 

As you can see, even there are two stations with same name, they are distinguished by |-from| option, which specifies previous station in extended elevation. Using this scrap you receive the final map: 

\fitpic{../samples.doc/000026-map5.pdf} 

\subchapter {Dipsplaying overlaying maps in offset}. 

Assume that there are two maps {\it m1} and {\it m2} ({\it m1} is above {\it m2}). By default therion displays {\it m1} overlying {\it m2}. 

\fitpic{../samples.doc/000005-map1.pdf} 

To display map {\it m2} in offset you need to create a map containing {\it m2} and specify offset and preview type for {\it m2} in this map. Пример: 

|map m12 m1 break m2 [0 8 m] below endmap | 

After selecting the {\it m12} in configuration file you receive: 

\fitpic{../samples.doc/000006-map2.pdf} 

Joining arrows are created from {\it map-connection} points specified in scraps that are moved. Otherwise these points are ignored. 

If the situation is more complicated, e.g. there is {\it m3} below {\it m2} 

\fitpic{../samples.doc/000007-map3.pdf} 

you need to create more complicated map structure to handle this. 

|map m23 m2 break m3 [-8 0 m] below endmap 

map m123 m1 break m23 [0 8 m] below endmap | 

Then {\it m123} looks like this: 

\fitpic{../samples.doc/000008-map4.pdf} 

\subchapter {Importing survex .3d files}. 

Therion surveys nearly correspond to station prefixes defined by |*begin|/|*end| pairs in survex source files. Usually there does not exist one-to-one mapping between them. So if you want to keep your centerline in survex files you need to solve the problem how to match survex and therion data structures. This sample shows three different ways, how to deal with station prefixes when importing survex .3d files to therion. 

\subsubchapter {Using surveys specified in .th files}. 

If you will import .3d file with |-surveys use| switch, then therion tries to find the match between {\it survex prefix} and {\it therion survey name}. If this match is found, stations are inserted into survey found. Otherwise prefix is left with station names. Example code: 

|import use.3d -surveys use input use-out.th2 survey use input use-in.th2 endsurvey | 

In this case you should take care where you input your .th2 files containing scraps. In {\it use-out.th2} file you should refer to station names using: 

|point 165.744 176.58 station -name 2@use | 

but in the {\it use-in.th} file using 

|point 321.454 236.22 station -name 1 | 

Map with station names in this case looks like this: 

\fitpic{../samples.doc/000000-use.pdf} 

Station names are before '@' symbol, survey names follow this symbol. 

\subsubchapter {Creating non-existing surveys}. 

If you import your .3d file using 

|import create.3d -surveys create | 

all survex prefixes are taken into account and if surveys with corresponding names do not exist, they are created. In this case, if you do 

|input create.th2 | 

right after |import| command, you refer to stations in .th2 file with names shown on the map. 

\fitpic{../samples.doc/000001-create.pdf} 

\subsubchapter {Ignoring station prefixes}. 

Last possibility is to import your .3d file using 

|import ignore.3d -surveys ignore | 

Also in this case, station references in corresponding .th2 file are same as station names on the next map. 

\fitpic{../samples.doc/000002-ignore.pdf} 

Note that no surveys are created in this case. Station names are taken from .3d files without change. 

\subsubchapter {Managing large projects}. 

Assume a situation when you want to join these three small maps within single large project. Assume that coordinates of cave entrances are specified in the top-level cave.3d file. If your joining code will be 

|import cave.3d -surveys use survey cave input use/use.th input create/create.th input ignore/ignore.th endsurvey | 

not all stations are replaced correctly. The "created" series is placed wrong on the map. 

\fitpic{../samples.doc/000003-cave1.pdf} 

This is because in top level import command, survey {\it create} is imported from file |create/create.3d| with wrong coordinates, and we import top-level .3d file with |-surveys use| switch. This means, cave.create.1 will be imported here as create.1@cave and not 1@create.cave. 

To solve this problem, we need to re-import stations from top-level cave.3d file once more with |-surveys create| switch. 

|import cave.3d -surveys use import cave.3d -surveys create survey cave input use/use.th input create/create.th input ignore/ignore.th endsurvey | 

After this additional |import| final looks as expected. 

\fitpic{../samples.doc/000004-cave2.pdf} 

\subsubchapter {Conclusion}. 

Even if there are several possibilities how to map survex prefix structure to therion survey structure, the most clean solution is to create survey structure to desired depth in .th files using empty |survey|/|endsurvey| pairs and allways use |-surveys use| switch when importing .3d files. 

\subchapter {Question marks handling}. 

Possible continuations are treated special way in therion in both centerline and map files. You may associate text description, explored length (behind this continuation) or any other atribute to it (like Code if you have your own coding standard for continuations). 

\subsubchapter {Question marks in centerline}. 

In the centerline object, you may add a special flags to the station, where continuation is possible. Just use following syntax 

|station 5 "pit" continuation attr Code V explored 20m | 

When you export map and use 

|symbol-show point flag:continuation | 

in your layout, station with continuation flag specified is marked by question mark (continuation symbol is shown above the station). 

\fitpic{../samples.doc/000027-map1.pdf} 

You may redefine continuation symbol to show also continuation description (stored in |_text| attribute) using following layout code 

|code metapost def p_continuation(expr pos,theta,sc,al) = 

% draw default continuation symbol
p_continuation_UIS(pos,theta,sc,al); 

% if text attribute is set
if known(ATTR__text) and picture(ATTR__text): 

% set labeling color to light orange
push_label_fill_color(1.0, 0.9, 0.8); 

% draw filled label with text next to ?
p_label.urt(ATTR__text,(.5u,-.25u) transformed T,0.0,8); 

% restore original labeling color
pop_label_fill_color; 

fi; enddef; endcode | 

Then also continuation description is displayed in the map. 

\fitpic{../samples.doc/000028-map2.pdf} 

\subsubchapter {Question marks in maps}. 

In the scrap (.th2 file), you can use |-text|, |-code| and |-explored| options to continuation symbol. 

|point 796.0 676.0 continuation -attr Code A -explored 50m \-text "water too cold to continue survey" | 

In the map, also the question marks only are displayed by default. 

\fitpic{../samples.doc/000029-map3.pdf} 

When you redefine continuation symbol as mentioned above, you can show also continuation codes and descriptions. 

\fitpic{../samples.doc/000030-map4.pdf} 

\subsubchapter {Exporting question mark lists}. 

You may also export a list of all continuations from your project project using 

|export continuation-list -o questions.html | 

File questions.html then contains following list: 

\bigskip\begingroup\input etc/TXSruled.tex \LeftJustifyTables\ruledtable {\bf Comment}&{\bf Исследовано}&{\bf Survey}&{\bf Station}&{\bf Code}\cr water too cold to continue survey&50.0&Sample cave&7&A\nr strong wind from breakdown& &Sample cave&3&B\nr pit&20.0&Sample cave&5&V\endruledtable\endgroup\bigskip \subchapter {Using user defined symbol types}. 

If therion does not offer any appropriate symbol for the feature you want to draw to the map, you can use user defined symbol type (type |u|, valid for point, line and area objects). 

The syntax is very simple. Assume you want to create "bat" point, line and area. You just use |u:bat| as a type (bat is in fact subtype) of u type. So your code will be like this: 

|point 555.0 480.0 u:bat | 

или 

|line u:bat | 

или 

|area u:bat | 

When you export map without defining the symbols in \MP{}, user defined symbols are highlighted in red without any graphical representation. 

\fitpic{../samples.doc/000009-map1.pdf} 

To display them correctly you need to define symbols for them in \MP{} languge the same way as ordinary symbols are usually redefined. 

Firstly point symbol. In the 

|code metapost | 

section of your layout define point u:bat symbol like this 

|def p_u_bat(expr pos, theta, sc, al) = T := identity shifted pos; thfill (bat_path scaled 2.0) withcolor black; enddef; | 

similarly the line u:bat symbol 

|def l_u_bat(expr P) = T:=identity; cas := 0; dlzka := arclength P; mojkrok:=adjust_step(dlzka, 1.0u); pickup PenD; forever: t := arctime cas of P; thfill bat_path scaled 0.5 shifted (point t of P) withcolor black; cas := cas + mojkrok; exitif cas > dlzka + (mojkrok / 3); endfor; enddef; | 

% for rounding errors
and finally the area u:bat symbol (pattern in this case) 

| beginpattern(pattern_bat); fill bat_path withcolor black; endpattern; 

% bat pattern
% bat area symbol
def a_u_bat (expr Path) = T:=identity; thclean Path; thfill Path withpattern pattern_bat; enddef; | 

These symbols will be included also in the legend. To change the way how they are drawn there just define appropriate macro. Its name should be symbol macro name with |_legend| suffix. 

|def l_u_bat_legend = l_u_bat(((.2,.2) -- (.8,.8)) inscale) enddef; | 

Finally, add description of your new symbols that will be shown in the legend using |text| command anywhere in the configuration file. 

|text en "point u:bat" "bat" text en "line u:bat" "bat path" text en "area u:bat" "lot of bats" | 

After all these definitions you receive bat point, line and area symbols with proper graphical representation and legend boxes. 

\fitpic{../samples.doc/000010-map2.pdf} 

