\subchapter {Рисование карт в Therion'е}. 

\fitpic{../samples.doc/000031-rabbit-plan.pdf} 

\fitpic{../samples.doc/000032-rabbit-xelev.pdf} 

\subchapter {Список пещер}. 

При съемке пещер на какой-то большой территории вам часто нужно создать список всех пещер на этой территории. В наборе данных, "пещера" может быть определена несколькими способами, в зависимости от уровня пещерной съемки. 

Если у вас есть станция на входе с известными координатами (например, используя GPS или стандартные методы съемки), все, что вам нужно сделать, это назначить флаг |entrance| (вход) 

|station cave-1 "Не снятая пещера" entrance | 

Если за этим входом есть какой-то разведанный проход, но вы не\break обследовали его должным образом, вы должны добавить также флаги\break |continuation| (продолжение) и |explored| (исследование), за которым следует исследуемая длина. Исследуемые, но не отснятые хода также являются частью сводной статистики. 

|station cave-2 "Не снятая, но исследованная" entrance \
	continuation explored 80m | 

Если вы как следует отсняли какую-то пещеру, ее данные обычно находятся в некоторых |survey|. Съемка становится пещерой, если у нее есть станция с опцией |-entrance|. Пример: 

|survey small_cave -title "Пещера Туннель" -entrance 0 | 

Если съемка содержит данные, но не указан главный входа, то съемка не считается пещерой, как единица организации данных и, таким образом, не присутствует в списке пещер. В итоговой таблице присутствуют только съемки, содержащие пещеры (т.е. входные станции или съемки с основным входом). 

После того, как пещеры в ваших данных были правильно определены, вы можете создать таблицу, используя 

|export cave-list -o caves.html | 

Итоговая таблица выглядит так: 

\bigskip\begingroup\input etc/TXSruled.tex \LeftJustifyTables\ruledtable {\bf Наименование}&{\bf Длина}&{\bf Глубина}&{\bf Исследовано}&{\bf Высота н.у.м.}\cr Пещера Туннель&25&7& &1244.0\nr Не снятая пещера& &&&1234.0\nr Не снятая, но исследованная& &&80&1256.0\endruledtable\endgroup\bigskip \subchapter {Символы площади}. 

\fitpic{../samples.doc/000011-types.pdf} 

\subchapter {Морфинг эскиза}. 

Оригинальный эскиз съемки: 

\fitpic{../samples.doc/000012-cave1.jpg} 

Изображение после морфинга: 

\fitpic{../samples.doc/000013-cave1.pdf} 

Стены после морфинга: 

\fitpic{../samples.doc/000014-cave2.pdf} 

Другой эскиз съемки: 

\fitpic{../samples.doc/000015-cave.png} 

Это изображение после морфинга: 

\fitpic{../samples.doc/000016-cave1.pdf} 

Эскиз подвергшийся морфингу после вставки точек {\it extra}: 

\fitpic{../samples.doc/000017-cave2.pdf} 

И морфинг стен: 

\fitpic{../samples.doc/000018-cave3.pdf} 

\subchapter {Управление разрез-разверткой}. 

Предположим следующую ситуацию (в плане) -- есть кольцо нитки хода между станциями 1 и 4, небольшая труба возле станции 5 и вход в пещеру находится на станции 6. 

\fitpic{../samples.doc/000019-map1p.pdf} 

По умолчанию разрез-развертка этой ситуации выглядит следующим\break образом: 

\fitpic{../samples.doc/000020-map1x.pdf} 

Очевидно это не то, что мы хотели бы получить. 

Чтобы контролировать процесс развертки существует специальная опция |extend| команды centerline. 

Прежде всего, мы хотели бы начать нашу разрез-развертку на станции 6 (где находится вход). Это можно сделать, указав 

|extend start 6 | 

в centerline. Теперь это выглядит лучше, 

\fitpic{../samples.doc/000021-map2.pdf} 

но по-прежнему существует проблема с ниткой, содержащей станцию 5. 

Если мы хотим начать эту нитку со станции 4, нам необходимо запретить Therion'у разворот станции 5 из станции 1. Это можно сделать, указав 

|extend ignore 1 5 | 

Это означает, что замер со станции 1 на станцию 5 будет проигнорирован, когда генерируется разрез-развертка. 

Если мы хотим развернуть нитку начиная со станции 5 влево, нам нужно указать также 

|extend left 5 | 

Это команда будет разворачивать все станции со станции 5 влево. 

\fitpic{../samples.doc/000022-map3.pdf} 

Как мы уже упоминали ранее, на станции 5 имеется небольшая труба. В этом случае гораздо более естественно сделать этот замер вертикальным (потому что это труба). Чтобы сделать это, используйте 

| extend vertical 5 5' | 

\fitpic{../samples.doc/000023-map6.pdf} 

Или вы можете полностью скрыть этот замер, используя: 

| extend hide 5 5' | 

\fitpic{../samples.doc/000024-map7.pdf} 

\subsubchapter {Станции в скрапах разрез-развертки}. 

Даже если станция 1 присутствует более одного раза на карте, Therion автоматически определяет правильное положение этой станции в каждом скрапе, и они обычно рисуются правильно. 

\fitpic{../samples.doc/000025-map4.pdf} 

Единственное, чего не хватает, это линия соединения между станциями 1 в этих двух нитках. Therion автоматически не генерирует эти линии, потому что их форма обычно зависит от конкретной карты. 

Чтобы нарисовать такую линию, вам нужно всего лишь создать простой скрап с этой линией. Вот пример: 

|scrap sc -proj extended
	point 0 0 station -name 1 -from 5 -visibility off
	point 100 0 station -name 1 -from 2 -visibility off
	line map-connection
		0 5
		0 15
		100 15
		100 5
	endline
endscrap | 

Как вы видите, даже если есть две станции с одинаковым именем, они отличаются друг от друга опцией |-from|, которая указывает\break предыдущую станцию в разрез-развертке. Используя этот скрап, вы\break получаете окончательную карту: 

\fitpic{../samples.doc/000026-map5.pdf} 

\subchapter {Отображение перекрывающихся карт в смещении}. 

Предположим, существует две карты {\it m1} и {\it m2} ({\it m1} выше {\it m2}). По умолчанию Therion отображает {\it m1} поверх {\it m2}. 

\fitpic{../samples.doc/000005-map1.pdf} 

Чтобы отобразить карту {\it m2} в смещении, вам нужно создать карту,\break содержащую {\it m2}, и указать тип смещения и предварительного просмотра для {\it m2} на этой карте. Пример: 

|map m12
	m1
	break
	m2 [0 8 m] below
endmap | 

После выбора {\it m12} в файле конфигурации вы получите: 

\fitpic{../samples.doc/000006-map2.pdf} 

Соединительные стрелки создаются из точек {\it map-connection}, указанных в смещающихся скрапах. В противном случае эти точки игнорируются. 

Если ситуация более сложная, например, существует {\it m3} ниже {\it m2} 

\fitpic{../samples.doc/000007-map3.pdf} 

вам нужно создать более сложную структуру карты, чтобы отобразить это правильно. 

|map m23
	m2
	break
	m3 [-8 0 m] below
endmap 

map m123
	m1
	break
	m23 [0 8 m] below
endmap | 

Тогда {\it m123} выглядит так: 

\fitpic{../samples.doc/000008-map4.pdf} 

\subchapter {Импорт survex .3d файлов}. 

Съемки Therion'а почти соответствуют префиксам станций, определяемым парой |*begin|/|*end| в файлах survex. Обычно между ними не существует взаимно однозначного отображения. Поэтому, если вы хотите сохранить свою нитку хода указанную в файлах survex, вам нужно решить проблему, как совместить структуры данных survex и Therion'а. В этом примере\break показаны три разных способа, как иметь дело с префиксами станций при импорте файлов survex .3d в Therion. 

\subsubchapter {Использование съемки в .th файлах}. 

Если вы импортируете файл .3d с |-surveys use|, то Therion пытается найти совпадение между {\itпрефиксом survex} и {\it названием съемки Therion'а}. Если это совпадение найдено, то станции вставляются в найденную съемку. В противном случае префикс остается с именами станций. Пример кода: 

|import use.3d -surveys use
input use-out.th2
survey use
	input use-in.th2
endsurvey | 

В этом случае вам следует позаботиться о том, где вы вводите ваши файлы .th2, содержащие скрапы. В файле {\it use-out.th2} вы должны ссылаться на имена станций, используя: 

|point 165.744 176.58 station -name 2@use | 

но в файле {\it use-in.th}, используя 

|point 321.454 236.22 station -name 1 | 

Карта с названиями станций в этом случае выглядит так: 

\fitpic{../samples.doc/000000-use.pdf} 

Названия станций перед символом '@', названия съемок после этого символа. 

\subsubchapter {Создание несуществующих съемок}. 

Если вы импортируете файл .3d, используя 

|import create.3d -surveys create | 

все префиксы survex обрабатываются, и если съемки с соответствующими именами не существуют, то они создаются. В этом случае, если вы сделаете 

|input create.th2 | 

прямо после команды |import|, то вы ссылаетесь на станции в файле .th2 с именами, указанными на карте. 

\fitpic{../samples.doc/000001-create.pdf} 

\subsubchapter {Игнорирование префиксов станций}. 

Последняя возможность -- импортировать файл .3d, используя 

|import ignore.3d -surveys ignore | 

Также в этом случае ссылки станций в соответствующем файле .th2\break совпадают с именами станций на следующей карте. 

\fitpic{../samples.doc/000002-ignore.pdf} 

Обратите внимание, что в этом случае не создаются съемки. Названия станций берутся из .3d файлов без изменений. 

\subsubchapter {Управление большими проектами}. 

Предположим ситуацию, когда вы хотите присоединиться к этим трем\break небольшим картам в рамках одного крупного проекта. Допустим, что\break координаты входных пещер указаны в файле верхнего уровня cave.3d. Если ваш код присоединения будет 

|import cave.3d -surveys use
survey cave
	input use/use.th
	input create/create.th
	input ignore/ignore.th
endsurvey | 

не все станции будут заменены правильно. "Created" серия помещается неправильно на карте. 

\fitpic{../samples.doc/000003-cave1.pdf} 

Это происходит потому, что в команде импорта верхнего уровня съемка\break {\it create} импортируется из файла |create/create.3d| с неправильными\break координатами, и мы импортируем файл .3d верхнего уровня с |-surveys use|. Это значит, что cave.create.1 будет импортироваться здесь как create.1@cave, а не 1@create.cave. 

Чтобы решить эту проблему, нам нужно снова импортировать станции из файла cave.3d верхнего уровня с |-surveys create|. 

|import cave.3d -surveys use
import cave.3d -surveys create
survey cave
	input use/use.th
	input create/create.th
	input ignore/ignore.th
endsurvey | 

После этого дополнительного |import| окончательный вариант выглядит так, как ожидалось. 

\fitpic{../samples.doc/000004-cave2.pdf} 

\subsubchapter {Выводы}. 

Даже если есть несколько возможностей, как сопоставить структуру\break префикса карты survex со структурой съемки Therion'а, самым чистым\break решением является создание структуры в .th файлах с использованием\break пустой пары |survey|/|endurvey| и всегда использовать |-surveys use| при импорте файлов .3d. 

\subchapter {Обработка вопросительных знаков}. 

Возможные продолжения обрабатываются особым образом в области как нитки хода, так и в файлах карт. Вы можете связать текстовое описание, исследуемую длину (хода за этим знаком) или любой другой атрибут\break (например, Code, если у вас есть собственный стандарт кодирования для продолжения). 

\subsubchapter {Вопросительные знаки в нитке хода}. 

В объекте centerline вы можете добавить специальные флаги к станции, где возможно продолжение. Используйте следующий синтаксис 

|station 5 "pit" continuation attr Code V explored 20m | 

Когда вы экспортируете карту и используете 

|symbol-show point flag:continuation | 

в вашем layout станция с указанным символом продолжения помечена знаком вопроса (символ продолжения отображается над станцией). 

\fitpic{../samples.doc/000027-map1.pdf} 

Вы можете переопределить символ продолжения, чтобы показать также\break описание продолжения (сохраненное в атрибуте |_text|), используя следующий код в layout 

|code metapost
	def p_continuation(expr pos,theta,sc,al) = 

% draw default continuation symbol
		p_continuation_UIS(pos,theta,sc,al); 

% if text attribute is set
		if known(ATTR__text) and picture(ATTR__text): 

% set labeling color to light orange
			push_label_fill_color(1.0, 0.9, 0.8); 

% draw filled label with text next to ?
			p_label.urt(ATTR__text,(.5u,-.25u) transformed T,0.0,8); 

% restore original labeling color
			pop_label_fill_color; 

		fi;
	enddef;
endcode | 

Таким образом отображается описание продолжения на карте. 

\fitpic{../samples.doc/000028-map2.pdf} 

\subsubchapter {Вопросительные знаки на картах}. 

В скрапе (файл .th2) вы можете использовать опции |-text|, |-code| и |-explored| для символа продолжения. 

|point 796.0 676.0 continuation -attr Code A -explored 50m \
	-text "слишком холодная вода для продолжения съемки" | 

На карте также отображаются только вопросительные знаки по умолчанию. 

\fitpic{../samples.doc/000029-map3.pdf} 

Когда вы переопределяете символ продолжения, как указано выше, вы также можете показать коды продолжения и описания. 

\fitpic{../samples.doc/000030-map4.pdf} 

\subsubchapter {Экспортировать списки вопросительных знаков}. 

Вы также можете экспортировать список всех продолжений из своего\break проекта, используя 

|export continuation-list -o questions.html | 

Файл questions.html содержит следующий список: 

\bigskip\begingroup\input etc/TXSruled.tex \LeftJustifyTables\ruledtable {\bf Комментарий}&{\bf Исследовано}&{\bf Съемка}&{\bf Станция}&{\bf Код}\cr слишком холодная вода&50.0&Пример пещеры&7&A\nr сильная тяга из разлома& &Пример пещеры&3&B\nr понор&20.0&Пример пещеры&5&V\endruledtable\endgroup\bigskip \subchapter {Использование пользовательских типов символов}. 

Если Therion не содержит подходящий символ для ваших функции, вы\break можете нарисовать свой символ на карте, используя определенный тип символа (тип |u|, применяется для объектов точки, линии и области). 

Синтаксис очень прост. Предположим, вы хотите создать точку, линию и область "bat". Вы просто используете |u:bat| как тип (bat -- фактически подтип типа u). Таким образом, ваш код будет выглядеть так: 

|point 555.0 480.0 u:bat | 

или 

|line u:bat | 

или 

|area u:bat | 

Когда вы экспортируете карту без определения символов в \MP{},\break пользовательские символы выделяются красным цветом без какого-либо графического представления. 

\fitpic{../samples.doc/000009-map1.pdf} 

Чтобы правильно отображать их, вам необходимо определить символы для них в языке \MP{}, как обычные символы обычно переопределяются. 

Первым переопределим символ точки. В 

|code metapost | 

в разделе вашего макета укажите символьную точку u:bat, подобный этому 

|def p_u_bat(expr pos, theta, sc, al) =
	T := identity shifted pos;
	thfill (bat_path scaled 2.0) withcolor black;
enddef; | 

аналогично укажите в линейном символе u:bat 

|def l_u_bat(expr P) =
	T:=identity;
	cas := 0;
	dlzka := arclength P;
	mojkrok:=adjust_step(dlzka, 1.0u);
	pickup PenD;
	forever:
		t := arctime cas of P;
		thfill bat_path scaled 0.5 shifted (point t of P) withcolor black;
		cas := cas + mojkrok;
		exitif cas > dlzka + (mojkrok / 3);|\%| для ошибок округления
	endfor;
enddef; | 

% for rounding errors
и, наконец, область символа u:bat (шаблон в этом случае) 

\%| bat pattern| 

% bat pattern
% bat area symbol
|beginpattern(pattern_bat);
	fill bat_path withcolor black;
endpattern;

|\%| bat pattern
def a_u_bat (expr Path) =
	T:=identity;
	thclean Path;
	thfill Path withpattern pattern_bat;
enddef; | 

These symbols will be included also in the legend. To change the way how they are drawn there just define appropriate macro. Its name should be symbol macro name with |_legend| suffix. 

|def l_u_bat_legend =
	l_u_bat(((.2,.2) -- (.8,.8)) inscale)
enddef; | 

Finally, add description of your new symbols that will be shown in the legend using |text| command anywhere in the configuration file. 

|text en "point u:bat" "bat"
text en "line u:bat" "bat path"
text en "area u:bat" "lot of bats" | 

After all these definitions you receive bat point, line and area symbols with proper graphical representation and legend boxes. 

\fitpic{../samples.doc/000010-map2.pdf} 

