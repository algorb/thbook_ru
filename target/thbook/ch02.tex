\eject

\vbox{\rightline{\pic[100mm]{agrippa.jpg}} \kern-20mm \eightit\baselineskip10pt\rightskip105mm\leftskip0mm\parindent1.05cm Только для вас, детей\break доктрины и обучения, мы написали эту работу. Изучите эту книгу, подумайте о том, что мы рассеяли в разных местах и собрались\break снова; что мы скрывали в одном месте, которое мы раскрыли в\break другом, что оно может быть\break понято вашей мудростью.\par \kern-10pt \rightline{\hfil\eightrm -- {\font\tt=fhar6a at 8px \tt Хенрикус С. Агриппа Ноттенсгеймский,} \eightmit 1533} } 

\chapter Создание файлов данных. 

\subchapter Основы. 

Входные файлы для Therion'а имеют текстовый формат. Существует\break несколько правил о том, как должен выглядеть такой файл: 

\list * Есть два типа команд. Однострочные команды и многострочные команды. 

* Однострочная команда завершается символом конца строки. Их синтаксис 

|command arg1 ... argN [-option1 value1 -option2 value2 ...]| 


где {\it arg1 ... argN} являются обязательными аргументами, а пары {\it -option value} являются параметрами, которые вы можете свободно пропустить. Какие аргументы и опции доступны, зависит от конкретной команды. Примером может служить 

|point 643.5 505.0 gradient -orientation 144.7| 

с тремя обязательными аргументами и одной дополнительной парой\break опция/значение. Иногда параметров нет или может быть несколько\break значений. 

* Многострочные команды начинаются аналогично однострочным, но\break продолжаются на последующих строках до явного завершения команды. Эти строки могут содержать либо данные, либо параметры, которые\break применяются к последующим данным. Если строка данных начинается со слова, зарезервированного для опции, вам нужно вставить `|!|' перед ней. Синтаксис: 

|command arg1 ... argN [-option1 value1 -option2 value2 ...]
	...
	optionX valueX
	data
	...
endcommand| 

Опять же, для лучшей иллюстрации приведем пример: 

|line wall -id walltobereferenced
	1174.0 744.5
	1194.0 756.5 1192.5 757.5 1176.0 791.0
	smooth off
	1205.5 788.0 1195.5 832.5 1173.5 879.0
endline| 

Эта команда |line| имеет один обязательный аргумент, тип линии (коренная стена в данном случае), за которой следует одна опция. Следующие две строки содержат данные (координаты кривых Безье). Следующая строка (``|smooth off|'') указывает параметр, который применяется к последующим данным (т.е. не для всей строки, в отличие от опции |-id| в первой строке), и последняя строка содержит еще несколько данных. 

* Если значение параметра или аргумента содержит пробелы, вы должны заключить это значение в \hbox{|" "|} или \hbox{|[ ]|}. Если вы хотите поместить двойную кавычку |"| в текст в \hbox{|" "|} вам нужно вставить его дважды. Кавычки\break используются для строк; скобки для числовых значений и ключевых слов. 

* Каждая строка, заканчивающаяся обратным слэшем (|\|), считается\break продолженной на следующей строке, как будто не было ни разрыва строки, ни зазора. 

* Все, что следует за |#| и до конца строки, даже внутри команды, считается комментарием и игнорируется. 

* \NEW{5.4}Многострочные комментарии внутри |comment|\ ...\ |endcomment| блока\break разрешены в файлах данных и конфигурационных файлах. 

\endlist

\subchapter Типы данных. 

Therion использует следующие типы данных: 

\list

* {\it keyword} = последовательность |A-Z|, |a-z|, |0-9| и |_-/| символов (не\break начинающиеся с `|-|'). * {\it ext\_keyword} = слово, которое также может содержать |+*.,'| символы, но не в первой позиции. * {\it date} = спецификация даты (или временного интервала) в формате \hfil\break |YYYY.MM.DD@HH:MM:SS.SS - YYYY.MM.DD@HH:MM:SS.SS| или `|-|' чтобы указать неопределенную дату. * {\it person} = имя и фамилия человека, разделенные пробельными символами. Используйте `|/|' чтобы отделить имя и фамилию, если есть несколько имен. * {\it string} = последовательность любых символов. \NEW{5.3}Строки могут содержать специальный тег |<lang:XX>| для разделения переводов. В многоязычных строках только текст между |<lang:XX>| (где |XX| - это язык, выбранный в файле инициализации или конфигурации) и следующим тегом |<lang:YY>| отображается на выходе. Если совпадение не найдено, все до появления тега |<lang:ZZ>| отображается. * {\it units} = поддерживаемые единицы длины: meter[s], centimeter[s], inch[es], feet[s], yard[s] (можно сокращать m, cm, in, ft, yd). Поддерживаемые угловые единицы:  degree[s], minute[s] (можно сокращать deg, min), grad[s], mil[s], percent[age] (только для угла наклона). Значение градуса может быть введено в десятичной системе ($x.y$) или в специальной нотации для градусов, минут и секунд ($deg[{:}min[{:}sec]]$). \endlist

\subchapter Системы координат. 

Therion поддерживает преобразования координат в геодезические системы координат. Вы можете указать опцию |cs| в объектах |centreline|, |surface|, |import| и |layout| и ввести XY в выбранной системе координат. Вы также можете указать вывод |cs| в конфигурационном файле. 

Если вы не указали какой-либо |cs| в вашем наборе данных, то\break предполагается, что вы работаете в |local| системе координат, и никакие преобразования не выполняются. Если вы укажете |cs| в любом месте данных, то вы должны указать его для всех данных местоположения (|fix|, |origin| и |layout| и т.д.). 

|cs| применяется ко всем последующим данным местоположения, пока другие |cs| не будут указаны или до конца текущего объекта, в зависимости от того, что наступит раньше. 

Поддерживаются следующие системы координат: 

\list

* |UTM1| -- |UTM60| = Универсальная поперечная проекция Меркатора (Universal Transverse Mercator) в северном полушарии и заданной зоне, WGS84. * |UTM1N| -- |UTM60N| = то же, что и |UTM1| -- |UTM60| * |UTM1S| -- |UTM60S| = UTM в южном полушарии, WGS84. * |lat-long|, |long-lat| = широта (N положительная, S отрицательная) и долгота (E положительная, W отрицательная) в заданном порядке в градусах\break (разрешено $deg[{:}min[{:}sec]]$), WGS84. По умолчанию не поддерживается на выходе. * |EPSG:<number>| =Большинство систем координат EPSG. Почти каждая система координат, используемая во всем мире, имеет собственный номер EPSG. Чтобы найти номер вашей системы, см. |extern/proj4/nad/epsg| файл в дистрибутиве исходников. * |ESRI:<number>| = Аналогично EPSG, но стандарт ESRI. 

%* |EUR79Z30| = UTM zone 30, EUR79 datum.  % ad-hoc addition not worth mentioning??
* |JTSK|, |iJTSK| = Чехословацкая система S-JTSK, используемая с 1920-х годов с южной и западной осью (JTSK) и ее модифицированной версией с осью, указывающей восток и север отрицательными числами (iJTSK). JTSK не поддерживается на выходе (как и iJTSK). * |JTSK03|, |iJTSK03| = новая реализация S-JTSK, введенная в Словакии в 2011 году. * |OSGB:<H, N, O, S или T><A-Z исключая I>| = Британская Национальная Сеть.\NEW{5.4} * |S-MERC| = сферическая проекция Меркатора, используемая различными сайтами онлайн-сопоставления. \endlist

\subchapter Магнитное склонение. 

Therion содержит встроенный IGRF\[См. \www{https://www.ngdc.noaa.gov/IAGA/vmod/}] -- модель геомагнитного поля Земли, действительная для периода 1900--2020 гг\NEW{5.4}. Он автоматически используется, если пещера находится в пространстве с использованием любой из\break поддерживаемых геодезических систем координат, и никакое склонение не определяется пользователем. Вычисленное склонение указано в файле LOG для информации. 

\subchapter Формат данных. 

Синтаксис входных файлов объясняется в описании отдельных команд.\break Изучение примеров файлов, распространяемых вместе с Therion, поможет вам понять основы. Смотрите также примеры в {\it Приложении}. 

В каждом из следующих разделов описывается одна команда Therion,\break использующая следующую структуру: 

{\it Описание:} примечания относительно этой команды. 

{\it Синтаксис:} описание синтаксиса. 

{\it Контекст:} указывает контекст, в котором используется эта команда.\break Контекст {\it survey} означает, что команда должна быть заключена в пару |survey ... endsurvey|. Контекст {\it scrap} означает, что команда должна быть заключена в пару |scrap ... endscrap|. Контекст {\it all} означает, что команда может\break использоваться в любом месте. 

{\it Аргументы:} список обязательных аргументов с пояснениями. 

{\it Опции:} список доступных опций. 

{\it Опции командной строки:} для многострочных команд, которые могут быть указаны среди строк данных. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `encoding'. 

\description

Устанавливает кодировку входного файла. Это позволяет использовать\breakсимволы не ASCII во входных файлах. \enddescription

\syntax

|encoding <имя кодировки>| \endsyntax

\context

Это должна быть самая первая команда в файле. \endcontext

\arguments

* |<имя кодировки>| = чтобы увидеть список всех поддерживаемых имен кодировок, запустите Therion с опцией |--print-encodings|. Кодировки `UTF-8' (Unicode) и `ASCII' (7 бит) всегда поддерживаются. \endarguments

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `input'. 

\description

Вставляет содержимое файла на место команды. Расширение по умолчанию `.th' и его можно не указывать. Для максимальной портабельности\break используйте относительные пути, а для разделения каталогов используйте характерный для Unix `|/|', а не обратный слеш используемый в Windows `|\|'.  \enddescription

\syntax

|input <имя файла>| \endsyntax

\context

all \endcontext

\arguments

* |<имя файла>| \endarguments

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `survey'. 

\description

Survey -- основная структура данных. 

% Each data object must belong to a   survey. 
Survey могут быть вложенными -- это позволяет построить иерархическую структуру. Обычный уровень иерархической структуры survey представлен пещерами, более высокие уровни карстовыми областями, а более низкие уровни, например, ходами пещеры. 

Каждый survey имеет собственное пространство имен, указанное его |<id>| аргументом. Объекты (например станции или скрапы, см. ниже), которые относятся к subsurvey текущего survey, записываются как 

|<object-id>@<subsurvey-id>|, 

или, если есть больше уровней вложения 

|<object-id>@<subsubsurvey-id>.<subsurvey-id>|.\[Примечание: невозможно связать любой объект с survey более высокого уровня.] 

Это означает, что идентификаторы объектов должны быть уникальными только в рамках одного survey. Например, имена станций съемки могут быть одинаковыми, если они находятся в разных survey. Это позволяет делать нумерацию станций с 0 в каждом survey или объединение двух пещер в одну пещерную систему без переименования станций съемки. 

\enddescription

\syntax

|survey <id> [ОПЦИИ]
	... другие объекты ...
endsurvey [<id>]| \endsyntax

\context

|	|none, survey \endcontext

\arguments

* |<id>| = идентификатор \endarguments

\options * |namespace <on/off>| = указывает, создавать ли survey пространство имен (|on| по умолчанию). * |declination <спецификация>| = устанавливает склонение по умолчанию для всех объектов данных в этом survey (которые могут быть переопределены новым склонением в suburveys). The |<спецификация>| имеет три формы: 

1. |[]| пустую строку. Это приведет к сбросу склонения. 

2. |[<значение> <единицы>]| установит одно значение (также для undated survey). 

3. |[<дата1> <начение1> [<дата2> <значение2> ... ] <единицы>]| установит склонение для нескольких дат. Тогда склонение каждого замера будет установлено в соответствии со спецификацией даты объекта данных. Если вы хотите явно указать склонение для данных без даты, используйте `|-|' вместо даты. 

Если не определено склонение и определена какая-либо геодезическая система координат, склонение автоматически вычисляется с\break использованием встроенной геомагнитной модели. 

Обратите внимание: склонение положительно, когда магнитный север\break находится к востоку от истинного севера. 

* |person-rename <старое имя> <новое имя>| = переименовать человека, имя которого было изменено. 

* |title <строка>| = описание объекта. 

* |entrance <имя-станции>| = указывает главный вход в пещеру,\break представленный в этом survey. Если это не указано, и в этом survey есть только одна станция отмеченная входом, он считается также входом в пещеру. Эта информация используется для |cave-list| экспорта. \endoptions

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `centreline'. 

\description

Описание данных survey (нитки хода).  Синтаксис заимствован из Survex с небольшими изменениями; руководство Survex может быть полезно в\break качестве дополнительной справки для использования. Можно использовать синоним `centerline'. \enddescription

\syntax

|centreline [ОПЦИИ]
	date <дата>
	team <персона> [<роли>]
	explo-date <дата>
	explo-team <персона>
	instrument <прибор> <описание>
	calibrate <параметр> <ошибка> [<масштаб>]
	units <параметр> [<фактор>] <единицы>
	sd <параметр> <значение> <единицы>
	grade <grade list>
	declination <значение> <единицы>
	grid-angle <значение> <единицы>
	infer <what> <on/off>
	mark <тип>
	flags <shot flags>
	station <станция> <комментарий> [<flags>]
	cs <система координат>
	fix <станция> [<x> <y> <z> [<std x> <std y> <std z>]]
	equate <station list>
	data <стиль> <readings order>
	break
	group
	endgroup
	walls <auto/on/off>
	vthreshold <число> <единицы>
	extend <spec> [<станция> [<станция>]]
	station-names <префикс> <суффикс>
	...
	[данные съемки]
	...
endcentreline| \endsyntax

\context

|	|none, survey \endcontext

\options

* |id <идентификатор>| = идентификатор объекта. * |author <дата> <персона>| = автор данных и дата их создания. * |copyright <дата> <строка>| = дата и имя авторского права. * |title <строка>| = описание объекта. \endoptions

\comopt

* |date <дата>| = дата съемки. Если указано несколько дат, создается\break временной интервал. * |explo-date <дата>| = дата исследования. Если указано несколько дат,\break создается временной интервал. * |team <персона> [<роли>]| = член съемочного отделения. Первый аргумент -- его имя, остальные описывают роли человека в команде (необязательно -- в настоящее время не используется). Поддерживаются следующие\break зарезервированные слова: station, length, tape, [back]compass,\break [back]bearing, [back]clino, [back]gradient, counter, depth, station, position, notes, pictures, pics, instruments (insts), assistant (dog). * |explo-team <персона>| = член исследовательского отделения. * |instrument <инструмент> <описание>| = описание инструмента, который\break использовался для определения количественных данных (те же значения, что и роль человека в команде). * |infer <что> <on/off>| = `|infer plumbs on|' говорит программе\break интерпретировать угол наклона $\pm90\,^\circ$ как UP/DOWN (это означает, что угол наклона не будет изменяться при раскидывании невязки). `|infer|\break|equates on|' программа будет интерпретировать замеры с длиной 0 в\break качестве команды equate (что означает, что не применяются никакие\break корректировки длины). * |declination <значение> <единицы>| = задает склонение для последующих замеров $$истинный\ азимут = измеренный\ азимут + склонение$$ Склонение положительно, когда магнитный север находится к востоку от истинного севера. Если ни одно cклонение не указано, или cклонение сброшено (|-|), тогда действительная спецификация склонения ищется во всех съемках, в которых находится объект данных. Смотрите опцию declination команды survey. * |grid-angle <значение> <единицы>| = задает угол магнитной сетки\break (склонение от направления на север). * |sd <параметр> <значение> <единицы>| = задает стандартное\break отклонение для данных измерений. |<Параметр>| может содержать\break следующие значения: length, tape, bearing, compass, gradient, clino, counter, depth, x, y, z, position, easting, dx, northing, dy, altitude, dz. * |grade <grade list>| = устанавливает стандартные отклонения для угла\break наклона съемки (смотрите команду grade). Все ранее заданные\break стандартные отклонения или определения теряются. Если вы хотите\break изменить SD, используйте опцию sd после этой команды. Если указано несколько определений, то применяется только последнее. Вы можете указать определения только для позиции или только для съемок. Если вы хотите их комбинировать, вы должны использовать их в одной строке. * |units <параметр> [<фактор>] <единицы>| = устанавливает единицы для снимаемых параметров (так же как и для sd). * |calibrate <параметр> <ошибка> [<масштаб>]| = установка калибровки\break прибора. Измеренное значение рассчитывается по следующей формуле: $измеренное\ значение = (прочитанное\ значение - ошибка) \times масштаб$.\break Поддерживаемые единицы такие же, как в sd. * |break| = может использоваться между данными, чтобы отделить два\break пересечения. * |mark [<список станций>] <тип>| = установить тип именованных станций. |<тип>| может принимать одно из значений: fixed (фиксированным), painted (нарисованный) и temporary (временным) (по умолчанию). Если список станций отсутствует, все последующие станции будут отмечены\break соответствующим типом. * |flags <флаги замеров>| = установить флаги для следующих замеров.\break Поддерживаемые флаги: |surface| (для измерений на поверхности), |duplicate| (для дублированных съемок), |splay| (для коротких боковых замеров, которые по умолчанию скрыты на картах и моделях). Они исключаются из расчетов длины. 

Все замеры, имеющие в названии одной из станций `|.|' или `|-|' по умолчанию имеют тип |splay| (смотрите также команду |data|). 

Если флаг установлен на |approx[imate]|, он включается в вычисления общей длины, но также отображается отдельно в статистике съемки. Он должен использоваться для замеров, которые не были сняты должным образом и нуждаются в пересъемке. 

Также перед флагом допускается приставка ``|not|''. * |station <станция> <комментарий> [<флаги>]| = установить комментарий станции и ее флаги. Если в качестве комментария указан |""|, то он\break игнорируется. 

Поддерживаемые флаги: |entrance| (вход), |continuation| (продолжение), |air-draught[:winter/summer]| (ток воздуха:зима/лето), |sink| (понор), |spring|\break (источник), |doline| (карстовая воронка), |dig| (раскоп), \NEW{5.3}|arch| (свод), |overhang| (нависание потолка). Также приставка |not| может быть использована перед флагом, чтобы удалить ранее добавленный флаг. 

Вы также можете указать пользовательские атрибуты для станции,\break используя флаг |attr|, за которым следуют имя и значение атрибута.\break Пример:\hfil\break |station 4 "колодец для изучения" continuation attr code "V"| 

Если есть ход, который был исследован, но еще не снят, то предполагаемая исследуемая длина этого хода может быть учтена добавлением к станции флага |continuation|. Просто добавьте флаг |explored <исследовательская длинна>| для станции. Исследовательские длины являются частью\break статистики съемки/пещеры, отображаемой отдельно. Пример:\hfil\break |station 40 "ужасная прогулка" continuation explored 100m| 

* |cs <система координат>| = система координат для станций с\break фиксированными координатами. * |fix <станция> [<x> <y> <z> [<std x> <std y> <std z>]]| = фиксировать координаты станции (с указанными ошибками -- к ним применяется только преобразование единиц, а не калибровка). * |equate <список станций>| = эквивалентность заданных точек. * |data <стиль> <порядок считывания>| = установить стиль данных (normal, topofil, diving, cartesian, cylpolar, dimensions, nosurvey) и порядок\break считывания. Считывание может принимать одно из следующих ключевых слов: station, from, to, tape/length, [back]compass/[back]bearing, [back]clino/\penalty0[back]gradient, depth, fromdepth, todepth, depthchange, counter, fromcount, tocount, northing, easting, altitude, up/ceiling\[Размер может быть задан как пара |[<from> <to>\char"5D|, что означает размер в начале и в конце замера.], down/floor, left, right, ignore, ignoreall. 

Смотрите руководство к Survex для подробностей. 

Для разноуровневых данных поддерживаются ключевые слова новой\break строки и направления. Если есть прямые и обратные данные азимута или угла, то вычисляется среднее из них. 

\NEW{5.3} Если в замере одна из станций имеет название `|.|' или `|-|', то у замера устанавливается атрибут |splay|. {\it Dot} следует использовать для замеров, заканчивающихся внутри хода, {\it dash} для замеров, заканчивающихся на стенах хода, на полу или потолке. Хотя Therion еще не делает различий между ними, его следует использовать для улучшения 3D-моделирования в будущем. 

* |group| * |endgroup| = |group/endgroup| пара позволяет пользователю делать\break временные изменения практически в любых настройках (калибровка,\break единицы, sd, данные, флаги...). * |walls <auto/on/off>| =включение/выключение генерации формы хода из данных LRUD для последующих замеров. Если установлен |auto|, то ход генерируется только в том случае, если отсутствует скрап содержащий данную нитку хода. * |vthreshold <число> <единицы>| = пороговое значение для интерпретации показаний LRUD как показания лево-право-верх-низ, перпендикулярное замеру. 

Если ходы горизонтальны (|наклон < vthreshold|), LR считается\break перпендикулярным к замеру, а UD вертикальными. 

Если ходы более или менее вертикальные (|наклон > vthreshold|), тогда даже UD становится перпендикулярным к замеру, в противном случае ходы выглядят не очень хорошо. В случае вертикальных замеров UD интерпретируется как измерение с севера на юг от станции, чтобы\break построить вертикальные участки модели. 

* |extend <spec> [<станция> [<станция>]]| = определение развертки нитки хода. |<spec>| принимает следующие значения: 

|normal/reverse| = развернуть данную и следующие станции в таком же/\breakобратном направлении по отношению к предыдущей станции. Если заданы две станции -- направление применяется только к данному замеру; 

|left/right| =как указано выше, но направление указано явно; 

|vertical| = не перемещает станцию (замер) в направлении $X$, использует только $Z$ компонент замера; 

|start| = указать начальную станцию (замер); 

|ignore| = игнорирует указанную станцию (замер), продолжает развертку как у другой станции (замера), если возможно; 

|hide| = не показывает указанную станцию (замер) в развертке. 

Если ни одна из станций не указана, |<spec>| действует для следующих указанных замеров. 

* |station-names <префикс> <суффикс>| = добавляет данный префикс/\breakсуффикс для всех станций съемки в текущей нитки хода. Для сохранения типизации. 

\endcomopt

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubchapter `scrap'. 

\description

Скрап -- это часть 2D-карты, которая не содержит пересекающихся ходов (т.е. все хода могут быть нарисованы на бумаге не пересекаясь). Для небольших и простых пещер вся пещера может поместиться в одном скрапе. В сложных системах скрап обычно представляет собой один грот или один ход. В идеале скрап содержит около 100 м пещеры.\[Если необходимо, скрапы могут быть намного меньше, несколько метров пещеры. {При определении размера скрапа учитывайте следующее:} Использование небольших скрапов может потребовать больше времени для их обрисовки и для оптимизации их\break объединения. С другой стороны, маленькие скрапы, вероятно, будут менее искажены алгоритмами преобразования карт, чем более крупные скрапы. Слишком большие скрапы могут исчерпать память \MP, если часто используются заливки хода. Кроме того, редактор карт в XTherion'е медленнее реагирует при редактировании\break больших скрапов.] Каждый скрап\break обрабатывается отдельно \MP; слишком большие скрапы могут\break превысить размер памяти \MP\ и вызвать ошибки. 

Скрап состоит из точечных, строковых и областных символов. Смотрите главу {\itКак карта собирается в единое целое} для объяснения, как и в котором порядке они выводятся при отображении. 

Граница скрапа состоит из линий с опцией |-outline| или |-outline in| (стены хода по умолчанию имеют опцию |-outline out|). Эти линии не должны\break пересекаться, иначе, Therion (\MP) не может определить внутреннюю часть скрапа и \MP\ выдает предупреждение ''|scrap outline intersects itself|''. 

У каждого скрапа есть своя собственная локальная декартова система\break координат, которая обычно соответствует миллиметровой бумаге (если Вы определяете координаты символов карты вручную) или пикселям\break отсканированного изображения (если Вы используете XTherion). Therion делает преобразование этой локальной системы координат в реальные\break координаты, используя позиции станций съемки, которые определены в\break скрапе как символы точки на карте и определены в нитке хода. Если скрап не содержит по крайней мере две станции съемки с определением |-name|, тогда Вы должны использовать опцию |-scale| для калибровки скрапа (это обычно используется для сечений). 

Трансформация состоит из следующих шагов: \list * линейное преобразование (смещение, масштабирование и вращение),\break которые 'лучше всего' соответствуют станциям. 'Лучше всего' означает, что сумма квадратов расстояний между соответствующими станциями до и после трансформации минимальна. Результат отображается красный, если опция |debug| в команде |layout| установлена в |on|. * Non-linear transformation of the scrap which (1) moves survey stations to their correct position, (2) is continuous. Отображается синим в режиме |debug|. * Non-linear transformation of the scrap which (1) moves joined points together, (2) doesn't move survey stations, (3) is continuous. В конце положение контрольных точек кривых корректируется, чтобы сохранить гладкость. Результат -- готовая карта. \endlist

\enddescription

\syntax 

|scrap <id> [ОПЦИИ]
	... команды точек, линий и областей ...
endscrap [<id>]| \endsyntax

\context

|	|none, survey \endcontext

\arguments

*|<id>| = идентификатор скрапа. \endarguments

\options

* |projection <спецификация>| = указывает проекцию чертежа. Каждая\break проекция идентифицируется типом и дополнительно индексом в форме |тип[:индекс]|. Индекс может быть любым ключевым словом.\break Поддерживаются следующие типы проекций: 

1. |none| = нет проекции, используется для сечений или карт, которые не зависят от данных съемки (например, оцифровка старых карт, где нет нитки хода). Для этой проекции не указывается индекс. 

2. |plan| = проекция основного плана (по умолчанию). 

3. |elevation| = ортогональная проекция (проецируемый профиль a.k.a.), которая опционально принимает в качестве аргумента азимут сечения (например, |[elevation 10]| или |[elevation 10 deg]|). 

4. |extended| = разрез-развертка (развертка a.k.a.). 

* |scale <спецификация>| = используется для предварительного\break масштабирования (преобразования координат пикселей в метры) данных скрапа. Если проекция скрапа установлена в none, то это единственное преобразование, которое выполняется с координатами. |<Спецификация>| имеет четыре формы: 

1. |<число>| = |<число>| метров на единицу чертежа. 

2. |[<число> <единица длины>]| = |<число> <единиц длины>| на единицу чертежа. 

3. |[<число1> <число2> <единица длины>]| = |<число1>| чертежных единиц соответствует |<число2> <единиц длины>| в действительности. 

4. |[<число1> ... <число8> [<единица длины>]]| = это самый общий формат, где вы указываете по порядку координаты $x$ и $y$ двух точек в скрапе и две точки в действительности. При желании вы также можете указать единицы для координат `точек в действительности'. Эта форма позволяет применять как масштабирование, так и поворот скрапа. * |cs <система координат>| = предполагается, что (калиброванные) локальные координаты скрапа приведены к заданной системе координат. Это полезно для абсолютного размещения импортированных эскизов, где не указана ни одна станция съемки\[Если в скрапе есть несколько станций съемки, |cs| игнорируется.]. * |stations <список имен станций> | = станции, которые вы хотите\break использовать в скрапе, но которые не используются для его  трансформации. Вам не нужно указывать (рисовать) их с помощью команды |point station|. * |sketch <имя файла> <x> <y>| = определение растрового рисунка в качестве эскиза/подложки (координаты нижнего левого угла). * |walls <on/off/auto>| = указывает, следует ли использовать скрап в создании 3D-модели. * |flip (none)/horizontal/vertical| = зеркально отображает скрап после трансформации масштаба. * |station-names <префикс> <суффикс>| = добавляет префикс/суффикс всем станциям скрапа в текущей съемки. Для сохранения типизации. 

* |author <дата> <персона>| = автор данных и дата их создания.  * |copyright <дата> <текст>| = авторские права и их дата. * |title <текст>| = описание объекта. \endoptions

\subsubchapter `point'. 

\description

Точка -- это команда для рисования символа точки. \enddescription

\syntax

|point <x> <y> <тип> [ОПЦИИ]| \endsyntax

\context

scrap \endcontext

\arguments

* |<x>| и |<y>| являются координатами чертежа объекта. * |<тип>| определяет тип объекта. Поддерживаются следующие типы: 

{\it специальные объекты:} |station|\[Станция съемки. Для каждого скрапа (за исключением скрапов с проекцией `none') должна быть указана хотя бы одна станция с опцией |-name|.], |section|\[|section| является местом для размещения поперечного сечения в этой точке. Этот символ не имеет визуального представления. Поперечное сечение должно быть в отдель\-ном скрапе с проекцией `none'. Вы можете указать ее через опцию |-scrap|.], |dimensions|\[Используя опцию |-value| можно указать размеры хода выше/ниже плоскости нитки хода, используемой при создании 3D-модели.]; 

{\it метки:} |label|, |remark|, |altitude|\[Знак общей высоты. Все высоты экспортируются как разница от $Z$ сетки (по умолчанию 0). Чтобы отобразить высоту на стене прохода, используйте опцию |altitude| для любой точки линии стены хода.], |height|\[Высота внутри хода (например, яма и т. д.); смотрите ниже подробнее.], |passage-height|\[Высота хода; смотрите ниже.], |station-name|\[Если текст не указан, используется имя ближайшей станции.], \penalty-100 |date|; 

{\it символы заполнения хода}\[В отличие от других точечных символов, они подрезаются границей скрапа. Смотрите главу {Как карта собирается в единое целое}.]{\it:} |bedrock|, |sand|, |raft|, |clay|, |pebbles|, |debris|, |blocks|, |water|, |ice|, |guano|, |snow|; 

{\it спелео-формы:} |flowstone|, |moonmilk|, |stalactite|, |stalagmite|, |pillar|, |curtain|, |helictite|, |soda-straw|, |crystal|, |wall-calcite|, |popcorn|, |disk|, |gypsum|, |gypsum-flower|, |aragonite|, |cave-pearl|, |rimstone-pool|, |rimstone-dam|, |anastomosis|, |karren|, |scallop|, |flute|, |raft-cone|, \NEW{5.4}|clay-tree|; 

{\it оборудование:} |anchor|, |rope|, |fixed-ladder|, |rope-ladder|, |steps|, |bridge|, |traverse|, |camp|, |no-equipment|; 

{\it окончание ходов:} |continuation|, |narrow-end|, |low-end|, |flowstone-choke|, |breakdown-choke|, \NEW{5.4}|clay-choke|, |entrance|; 

{\it другие:} |dig|, |archeo-material|, |paleo-material|, |vegetable-debris|, |root|, |water-flow|, |spring|\[Всегда используйте символы |spring| и |sink| со стрелкой |water-flow|.], |sink|, \NEW{5.4}|ice-stalactite|, |ice-stalagmite|, |ice-pillar|, |gradient|, |air-draught|\[Number of ticks is set according to |-scale| option.], |map-connection|\[Виртуальная точка, используемая для указания соединения между выносками карт (раз\-рез-развертка, смещение карты).], |extra|\[Точка морфинга.], |u|\[Пользовательские точечные символы.]. 

\endarguments

\options

* |subtype <подтип>| = определяет подтип объекта. Поддерживаются следующие подтипы для заданных типов: 

{\it station (станция)}\[Если подтип станции не указан, Therion считает ее пикетом, если она указана в нитке хода.]{\it:} |temporary| (default), |painted|, |natural|, |fixed|; 

{\it air-draught (ток воздуха):} |winter| (зимой), |summer| (летом), |undefined| (не опреде\-лено) (по умолчанию); 

{\it water-flow (водоток):} |permanent| (по умолчанию), |intermittent|, |paleo|. 

Подтип может быть указан также непосредственно в |<type>| с использова\-нием `|:|' в качестве разделителя\[Например, |station:fixed|.]. 

Любой подтип может использоваться с пользовательским типом (|u|). В этом случае вам также необходимо определить соответствующий метапост символ (смотрите главу {\it Новые символы карты}). 

* |orientation/orient <число>| = определяет ориентацию символа. Если не указано, то ориентировано на север. 0 $\le$ |число| $<$ 360. * |align| = выравнивание символа или текста. Принимает следующие значения: center, c, top, t, bottom, b, left, l, right, r, top-left, tl, top-right, tr, bottom-left, bl, bottom-right, br. * |scale| = масштаб символа, может принимать значения: tiny (xs), small (s), normal (m), large (l), huge (xl) или числовое значение. По умолчанию normal. Именованные масштабы кратны $\sqrt 2$, и имеют следующие значения -- $xs \equiv 0.5$, $s \equiv 0.707$, $m \equiv 1.0$, $l \equiv 1.414$ и $xl \equiv 2.0$. * |place <bottom/default/top>| = порядок отображения изменений на карте. * |clip <on/off>| = указывает, подрезать ли символ границей скрапа. Вы не можете указать этот параметр для следующих символов: station, station-name, label, remark, date, altitude, height, passage-height. * |dist <дистанция>| = применяется для дополнительных точек, указывает рас\-стояние до ближайшей станции (или станции, указанной с помощью опции |-from|. Если не указано, используется соответствующее значение из данных LRUD. * |from <станция>| = применяется для дополнительных точек, указывает опор\-ную станцию. * |visibility <on/off>| = отображает/скрывает символ. * |context <point/line/area> <тип символа>| = (для использования с опциями |symbol-hide| и |symbol-show| в layout) символ будет скрыт/показан в соответствии с правилами для указанного |<типа символа>|\[Пример: если вы укажете |-context point air-draught| текстовую метку, на которой отображается дата наблюдения, команда |symbol-hide point air-draught| скроет стрелку ток воздуха и соответствующую ей текстовую метку.]. * |id <идентификатор>| = идентификатор символа. 

{\it Специальные параметры:}\Nobreak 

* |name <ссылка>| = если тип точки -- это station (станция), то эта опция дает ссылку на реальную станцию съемки. * |extend [prev[ious] <станция>]| = если тип точки -- это station (станция), а скрап является extended elevation (разрез-разверткой), то вы можете регулиро\-вать развертку нитки хода, используя эту опцию. * |scrap <сноска>| = если тип точки -- это section (сечение), то эта сноска ссыла\-ется на скрап поперечного сечения. * |explored <длина>| = если тип точки -- это continuation (продолжение), то вы можете указать длину ходов, исследованных, но пока не снятых. Это значение впоследствии отображается в статистике съемки/пещеры. * |text| = текст label (метки), remark (примечания) или continuation (продолже\-ния). Он может содержать следующие зарезервированные слова для фор\-матирования\[Для вывода SVG учитываются только зарезервированные слова |<br>|, |<thsp>|, |<it>|, |<bf>|, |<rm>| и |<lang:XX>|; все остальные игнорируются.]: 

|<br>| = разрыв строки; 

|<center>|/|<centre>|, |<left>|, |<right>| = выравнивание строк для многострочных меток. Игнорируется, если нет тега |<br>|; 

|<thsp>| = тонкий пробел; 

|<rm>|, |<it>|, |<bf>|, |<ss>|, |<si>| = переключают шрифты; 

\NEW{5.3} |<rtl>| и |</rtl>| = отмечает начало и конец вывода текста справа налево; 

\NEW{5.3}|<lang:XX>| = создает многоязычную текстовую метку (подробнее смотрите описание типа |string|). 

* |value| = значение точек height (высота уступа/камина/колодца), passage-height (высота хода), altitude (высотная отметка) или dimensions (размеры хода). 

{\it height (высота уступа/камина/колодца):} в зависимости от знака значения (положительный, отрицательный или без знака), этот тип символа предста\-вляет собой высоту трубы, глубину колодца или высоту уступа. Числовое значение может сопровождаться необязательным символом `|?|', чтобы доба\-вить единицы измерения (напри\-мер~|-value [40? ft]|). 

{\it passage-height (высота хода):} поддерживаются следующие четыре формы значения: |+<число>| (высота потолка), |-<число>| (глубина этажа или глубина воды), |<число>| (расстояние между потолком и полом) и |[+<число> -<число>]| (расстояние до потолка и расстояние до пола). 

{\it altitude (высотная отметка):} указанное значение представляет собой раз\-ницу высот по сравнению с ближайшей станции. Если значение altitude (высотная отметка) имеет префикс ``|fix|'' (например |-value [fix 1300]|), то это значение используется как абсолютная высота. Значение может сопровождаться единицами измерения. 

{\it dimensions (размеры хода):} |-value [<выше> <ниже> [<единицы>]]| определяет размеры ходов выше/ниже плоскости нитки хода, используется в 3D-мо\-дели. \endoptions

\subsubchapter `line'. 

\description

Line -- это команда для рисования символа линии на карте. Каждый символ линии ориентирован, и его визуализация может зависеть от его ориентации (например, галочка на границе линии). Главное правило заключается в том, что свободное пространство хода находится слева, а порода справа. Examples: the lower side of a pitch, higher side of a chimney and interior of a passage are on the left side of pitch, chimney or wall symbols, respectively. \enddescription

\syntax

|line <тип> [ОПЦИИ]
	[ОПЦИИ]
	...
	[ДАННЫЕ ЛИНИИ]
	...
	[ОПЦИИ]
	...
	[ДАННЫЕ ЛИНИИ]
	...
endline| \endsyntax

\context

scrap \endcontext

\arguments

* |<тип>| это зарезервированное слово, которое определяет тип линии.\break  Поддерживаются следующие типы: 

{\it символы ходов:} |wall| (стена), |contour| (контур), |slope| (склон)\[Линия склона обозначает верхнюю границу области склона. Необходимо указать |l-size| по меньшей мере для одной точки. Длина и ориентация уклона определяется указанными |l-size| и |orientation| (ориентация) в ближайших точках. Если ориентация отсутствует, то градиентные метки перпендикулярны линии наклона.], |floor-step| (уступ пола), |pit| (колодец), |ceiling-step| (уступ потолка), |chimney| (камин), |overhang| (нависание потолка), |ceiling-meander| (меандр, канал в потолке), |floor-meander| (меандр, канал в потолке); 

{\it заливка ходов:} |flowstone| (натечный каскад), |moonmilk| (мондмильх),\break |rock-border| (внешняя кромка глыбы)\[Внешние границы крупных валунов. Если линия замкнута, она заполняется цветом фона.], |rock-edge| (внутренняя кромка\break глыбы)\[Внутренние края больших валунов.], |water-flow| (водоток); 

{\it текстовые метки:} |label| (текстовая метка); 

{\it специальные:} |border| (граница), |arrow| (стрелка), |section| (выносная линия сече\-ния)\[Линия показывает положение поперечного сечения.\NEW{5.3}\  If both control points (red dots) of a B\'ezier curve (grey line) are given then the section line (blue) is drawn up to the perpendicular projection (dotted) of the first control point and from the projection (dotted) of the section control point. Кривая сечения не отображается.\hfil\break\MPpic{xsect.1}], |survey| (нитка хода)\[Нитка хода автоматически рисуется Therion'ом.], |map-connection| (линия выноса)\[Используется для указания соединения между картами (при смещении или же точками в разрез-развертке).], |u|\[Для определенных пользователем линейных символов.]. \endarguments

\comopt

* |subtype <подтип>| = определяет подтип линии. Для данных типов\break поддерживаются следующие подтипы: 

{\it wall (стена):} |invisible| (неотображаемая), |bedrock| (коренная порода) (по умол\-чанию), |sand| (песчаная), |clay| (глинистая), |pebbles| (из крупной гальки), |debris| (из щебня), |blocks| (из блоков), |ice| (ледяная), |underlying| (лежащая ниже), \NEW{5.4}|overlying| (лежащая выше), |unsurveyed| (не привязанная к опорным точкам), |presumed| (предполагаемая), |pit| (стены колодца)\[Обычно открытые с поверхности.], |flowstone|\break (глыбовые), |moonmilk| (покрытые мондмильхом); 

{\it border (граница):} |visible| (видимая) (по умолчанию), |invisible|\break (неотображаемая), |temporary| (временная), |presumed| (предполагаемая); 

{\it water-flow (водоток):} |permanent| (постоянный) (по умолчанию),\ \ |conjectural| (предполагаемый), |intermittent| (временный); 

{\it survey (нитка хода):} |cave| (пещерная) (по умолчанию), |surface|\break (поверхностная) (по умолчанию, если нитка хода имеет флаг surface). 

Подтип может быть указан также непосредственно в |<типе>| с использова\-нием `|:|' в качестве разделителя\[Например, |border:invisible|.]. 

Любой подтип может использоваться с пользовательским типом (|u|). В этом случае вам также необходимо определить соответствующий метапост символ (смотрите главу {\it Новые символы карты}). 

* |[ДАННЫЕ ЛИНИИ]| указывает либо координаты отрезка |<x> <y>|, либо\break координаты кривой Безье |<c1x> <c1y> <c2x> <c2y> <x> <y>|, где |c|\break указывает контрольную точку. * |close <on/off/auto>| = определяет, закрыта ли линия или нет. * |mark <keyword>| = используется для маркировки точки на линии (см.\break команду |join|). * |orientation/orient <число>| = ориентация символов на линии. Если не\break указано, она перпендикулярна линии с левой стороны. 0 $\le$ |число| $<$ 360. * |outline <in/out/none>| = определяет, служит ли линия границ для скрапа. Значение по умолчанию -- `|out|' для стен, `|none|' для всех других линий. Использовать |-outline in| для больших колонн и т.п. * |reverse <on/off>| = точки указаны в обратном порядке. * |size <число>| = ширина строки (размеры слева и справа установлены\break половине этого значения). * |r-size <число>| = размер строки справа. * |l-size <число>| = размер строки слева. Требуется для типа |slope|. * |smooth <on/off/auto>| = сглаживание линии в данной точке. По умолчанию `auto'. * |adjust <horizontal/vertical>| = сдвигает точку линии, которая должна быть выровнена по горизонтали/вертикали с предыдущей точкой (или\break следующей точкой, если нет предыдущей точки). Результат --\break горизонтальный/вертикальный сегмент линии). Если у всех точек линии есть этот параметр, они выравниваются посередине координаты $y$ или $x$, соответственно. Этот параметр не используется в проекции |plan|. * |place <bottom/default/top>| = порядок отображения изменений на карте. * |clip <on/off>| = указывает, подрезать ли символ границей скрапа. * |visibility <on/off>| = отображает/скрывает символ. * |context <point/line/area> <тип символа>| = (для использования с опциями |symbol-hide| и |symbol-show| команды |layout|) будет скрыт/показан в\break соответствии с правилами для указанного |<типа символа>|. 

{\it Специальные параметры:}\Nobreak 

* |altitude <значение>| = могут быть указаны только с типом |wall| (стена). Этот параметр создает метку высоты на стене. Все высоты экспортируются как разница от $Z$ сетки (по умолчанию 0). Если значение указано, оно дает разность высот точки на стене относительно ближайшей станции. Значение может иметь префикс с ключевым словом ``|fix|'', тогда никакая ближайшая станция не будет принята во внимание; вместо этого\break используется абсолютное заданное значение. За значением можно указать единицы измерения. Например: |+4|, |[+4 m]|, |[fix 1510 m]|. * |border <on/off>| = эта опция может быть указана только с типом символа `slope' (склон). Он включает/выключает границу линии наклона. * |direction <begin/end/both/none/point>| = может использоваться только с типом `section' (сечение). Он указывает, куда следует поместить стрелку направления на линию сечения. По умолчанию `none'. * |gradient <none/center/point>| = может использоваться только с типом\break `contour' (контур) и указывает, где расположить градиентную метку на контурной линии. Если спецификация градиента отсутствует, то\break поведение зависит от набора символов (например, без галочки в UIS,\break галочка посередине в SKBB). * |head <begin/end/both/none>| = может использоваться только с типом\break `arrow' (стрелка) и указывает, куда поставить стрелу. По умолчанию `end' (в конце линии). * |text <строка>| = действует только для линий надписей. * \NEW{5.4}|height <значение>| = высота pit (колодца) или wall:pit (входного колодца); доступная в \MP\ как числовая переменная |ATTR__height|. \endcomopt

\options

* |id <идентификатор>| = идентификатор символа. \endoptions

\subsubchapter `area'. 

\description

Area (область) определяется окружающими граничными линиями. Они\break могут быть любого типа, но должны быть перечислены друг за другом, и каждая пара последовательных линий должны пересекаться. Чтобы\break убедиться, что линии пересекаются даже после преобразования скрапа, вы можете продолжить границу на 1 см за стену хода -- эти выступы будут автоматически обрезаны по границе скрапа. Вы можете использовать\break невидимую (invisible) границу для расположения внутри хода. 

\enddescription

\syntax

|area <тип>
	place <bottom/default/top>
	clip <on/off>
	visibility <on/off>
	... ссылки на границы ...
endarea| \endsyntax

\context

scrap \endcontext

\arguments

* |<тип>| является одним из следующих: |water| (вода), |sump| (сифон), |sand| (песок), |debris| (щебень), |blocks| (навал глыб), |flowstone| (натечный каскад), |moonmilk| (мондмильх), |snow| (снег), |ice| (лед), |clay| (глина), |pebbles| (галька), |bedrock| (коренная порода)\[Пустая область, которая может быть использована для очистки фона.], |u|\[Для пользовательских символов области, может иметь произвольный подтип.]. \endarguments

\comopt

* строки данных состоят из ссылок на линии границы (ID). * |place <bottom/default/top>| = изменяет порядок отображения на карте. * |clip <on/off>| = указывает, подрезать ли символ границей скрапа. * |visibility <on/off>| = отображает/скрывает символ. * |context <point/line/area> <тип символа>| = (для использования с опциями |symbol-hide| и |symbol-show| команды |layout|) будет скрыт/показан в\break соответствии с правилами для указанного |<типа символа>|. \endcomopt

\options

* |id <идентификатор>| = идентификатор символа. \endoptions

\subsubchapter `join'. 

\description

Соединение работает в двух режимах: оно объединяет либо два скрапа, либо две или несколько точек или строк на карте вместе. 

При объединении более двух точек или строк используйте одну команду `join' для всех из них, а не последовательность команд\[Например, использовать |join a b c|, а не |join a b|, а затем |join b c|.]. 

При соединении скрапов соединяются только ходы. Лучше всего размещать соединения скрапов в ходе, которое будет как можно более простым, иначе вам нужно будет указать соединение для каждой пары объектов, которые должны быть соединены \[Если вам нужен какой-либо объект, который отсекается границей скрапа, чтобы\break продолжить соседний скрап, используйте опцию |-clip off| для этого объекта.]. \enddescription

\syntax

|join <точка1> <точка2> ... <точкаN> [ОПЦИИ]| \endsyntax

\context

none, scrap, survey \endcontext

\arguments

* |<точкаX>| может быть идентификатором точечного символа или символа линии, необязательно сопровождаемый меткой символа линии\break |<идентификатор>:<метка>| (например,~|podangl_l31@podangl:mark1|).\break |<метка>| может быть также `|end|' (конец линии) или индекс точки линии (где 0 это первая точка). 

Частным случаем |<точка1>| и |<точка2>| могут быть идентификаторами скрапов, более близкие концы скрапов соединяются вместе. \endarguments

\options

* |smooth <on/off>| = указывает, должны ли две линии соединяться плавно. * |count <N>| (при использовании со скрапами) = Therion попытается\break подсоединиться к скрапам, которые соединяются в |N| месте/хода. \endoptions

\subsubchapter `equate'. 

\description

Устанавливает эквивалентность станций съемки. \enddescription

\syntax

|equate <список станций>| \endsyntax

\context

|	|none, survey \endcontext

\subsubchapter `map'. 

\description

Карта представляет собой набор либо скрапов, либо других карт одного и того же типа проекции. На карте можно включить съемку, тогда на карте будет отображаться нитка хода. Объект карты упрощает управление данными при выборе данных для вывода. Смотрите главу {\it Как собрать карту} для более подробного объяснения. \enddescription

\syntax

|map <id> [ОПЦИИ]
	... скрап, съемка или другие карты ...
	break
	... скрап, съемка или другие карты (следующий уровень)...
	preview <above/below> <other map id>
endmap| \endsyntax

\context

|	|none, survey \endcontext

\arguments

*|<id>| = идентификатор скрапа. \endarguments

\comopt

* строки данных состоят из названий скрапа или карты. Обратите внимание, что вы не можете указывать их вместе. * если вы указываете название карты, то вы можете указать смещение, в месте которого эта подкарта будет отображаться. Синтаксис следующий:\hfil\break |<название карты> [<смещение X> <смещение Y> <единиц>]|\break|<above/below/none>|. * скрапы после |break| будет размещен на другом уровне. * |preview <above/below> <other map id> | поместит контур другой карты в указанную позицию относительно текущей карты. 

Карта отображается, только если она находится на уровне |map-level|,\break заданный командой |select|. 

Используйте команду |revise|, если вы хотите добавить карты с более\break высоких уровней для отображения. * |colo[u]r <цвет>| = установить цвет карты; эта опция отменяет\break автоматический выбор, когда макет определяет |colour map-fg [map]|. \endcomopt

\options

* |projection/proj <plan/elevation/extended/none>| = требуется, если карта\break содержит съемки. * |title <строка>| = описание объекта. * |survey <идентификатор>| = \NEW{5.4} связывает съемку с картой (например,\ все\break статистические данные из этой съемки  будут использоваться, когда эта карта будет выбрана для вывода). \endoptions

\subsubchapter `surface'. 

\description

Спецификация поверхности (рельефа). Его можно отобразить двумя\break способами: в качестве отсканированной топографической карты (как в 2D-карте, так и в 3D-модели \[Вам нужно ввести данные о высоте, чтобы отобразить топографическую карту в 3D-модели. В настоящее время поддерживаются только карты JPEG в 3D.]) или поверхностная сетка -- цифровая модель рельефа (только в 3D-модели). \enddescription

\syntax

|surface [<name>]
	cs <система координат>
	bitmap <имя файла> <калибровка>
	grid-units <единицы>
	grid <origin x> <origin y> <x spacing> <y spacing> <x count> <y count>
	grid-flip (none)/vertical/horizontal
	[grid data]
endsurface| \endsyntax

\context

|	|none, survey \endcontext

\comopt

* |cs <coordinate system>| = система координат для калибровки растровой карты и определения начала сетки. * |bitmap <имя файла> <калибровка>| = сканированная топографическая\break карта. 

|Калибровка| может иметь две формы: 

1. |[X1 Y1 x1 y1 X2 Y2 x2 y2 [единицы]]|, где верхние регистры X/Y являются координатами изображения (пиксели, нижний левый угол равен |0 0|), нижние регистры x/y -- реальные координаты. Необязательный параметр единицы применяется к реальным координатам (метры по\break умолчанию). 

2. |[X1 Y1 станция1 X2 Y2 станция2]|,  где верхние регистры X/Y\break представляют собой координаты изображения, а |станция1| и |станция2|\break являются именами станций съемки. 

* |grid-units <единицы>| = единицы, в которых задана сетка. Метры по умолчанию. 

* |grid <origin x> <origin y> <x spacing> <y spacing> <x count> <y count>| 

|<origin x> <origin y>| = указывают координаты нижнего левого (Ю-З) угла сетки. 

|<x spacing> <y spacing>| = расстояние между узлами сетки в направлениях З-В и Ю-С. 

|<x count> <y count>| = количество узлов в строке и количество строк, которые образуют сетку (см. ниже). 

* |[grid data]| = поток чисел, дающий высоту a.s.l. в узлах сетки. Начинается с начала сетки и заполняет сетку строками (в строке от З до В, строки от Ю до С). 

* |grid-flip (none)/vertical/horizontal| = полезно, если ваша сетка\break (экспортированная из другой программы) должна быть перевернута. 

\endcomopt

\subsubchapter `import'. 

\description

Считывает данные съемки в разных форматах (в настоящее время\break обрабатывается нитка хода в форматах *.3d, *.plt и *.xyz). На станции съемки можно ссылаться в скрабах и т.д. При импорте 3D-файла Survex'а станции вставляются в иерархии съемки, если в 3D-файле существует идентичная иерархия. \enddescription

\syntax

|import <имя файла> [ОПЦИИ]| \endsyntax

\context

survey / all\[Только с .3d-файлами, в которых задана структура съемки.] \endcontext

\options

* |filter <префикс>| = если указано, то будут импортированы только станции с заданным префиксом и замеры между ними. Префикс будет удален из имен станций. * |surveys (create)/use/ignore| = указывает, как импортировать структуру\break съемки (работает только с файлами .3d). 

|create| = сплит-станции в подсъемки, если подсъемок не существуют, то создайет их. 

|use| = разделенные станции в существующие подсъемки. 

|ignore| = не разбивать станции на подсъемки. * |cs <система координат>| = система координат для станций с\break фиксированными координатами. * |calibrate [<x> <y> <z> <X> <Y> <Z>]| = координаты в импортированном файле смещаются от координат в нижнем регистре к координатам\break верхнего регистра. \endoptions

\subsubchapter `grade'. 

\description

Эта команда используется для сохранения предопределенных точных\break данных нитки хода. Смотрите опцию |sd| в описании команды |centreline|. \enddescription

\syntax|grade <id>
	...
	[<quantity list> <value> <units>]
	...
endgrade| \endsyntax

\context

all \endcontext

\subsubchapter `revise'. 

\description

Эта команда используется для установки или изменения свойств уже\break существующего объекта. \enddescription

\syntax

Синтаксис этой команды для объекта, созданного с помощью команды ``single line'': 

|revise id [-option1 value1 -option2 value2 ...]| 

Для объектов, созданных с помощью команд ``multi line'' используется\break синтаксис: 

|revise id [-option1 value1 -option2 value2 ...]
	...
	optionX valueX
	data
	...
endrevise| \endsyntax

\context

all \endcontext

\arguments

Id означает идентификатор объекта (всегда должен указываться\break идентификатор объекта, который вы хотите изменить). \endarguments

\subchapter Пользовательские атрибуты. 

Объекты {\it survey}, {\it centreline}, {\it scrap}, {\it point}, {\it line}, {\it area}, {\it map} и {\it surface} могут\break содержать пользовательские атрибуты в форме |-attr <имя> <значение>|.\break  |<Имя>| может содержать буквенно-цифровые символы, |<значение>| -- строку. 

Пользовательские атрибуты используются при экспорте карты в\break зависимости от формата вывода: \list

* при экспорте в {\it shapefile} они записываются непосредственно в файл dbf; * в картах, сгенерированных с использованием \MP\ (PDF, SVG)\break атрибуты записываются в исходный файл \MP\ как строки\break (именуемые |ATTR_<имя>|) и могут быть оценены и использованы\break пользователем в макросах определения символов. 

Вы можете проверить наличие такой переменной, используя:\break |if known ATTR_<имя>: ... fi|. 

\endlist

\subchapter XTherion. 

XTherion -- графический пользовательский интерфейс для Therion. Он помо\-гает в создании файлов входных данных. В настоящее время он работает в трех основных режимах: текстовый редактор, редактор карт и компилятор. \[Здесь мы обсуждаем созданием данных, поэтому в этом разделе описаны только два первых режима. Функции компилятора смотрите в главе Обработка данных.] 

Его не обязательно использовать для Therion -- вы можете редактировать входные файлы в своем любимом текстовом редакторе и запускать Therion из командной строки. XTherion также не является единственным гра\-фи\-чес\-ким интерфейсом, который можно использовать с Therion.
 Можно написать лучшую, более удобную для пользователя, более WYSIWYG, быструю, более надежную и удобную в использовании. Есть желающие? 

В этом руководстве не описываются такие знакомые вещи, как `если вы хотите сохранить файл, перейдите в меню Файл и выберите Сохранить или нажмите Ctrl-s'. Просмотрите верхнее меню, чтобы почувствовать XTherion. 

Для каждого режима работы есть дополнительное меню справа или слева. Подменю могут быть свернуты; вы можете развернуть их, нажав кнопку меню. Для большинства меню и кнопок в строке состояния есть короткое описание, поэтому нетрудно догадаться о значении каждого из них. Показ подменю сбоку может быть настроен пользователем. Right-click on the menu button and select in the menu which of the other menus it should be swapped with. 

\subsubchapter XTherion -- текстовый редактор. 

Текстовый редактор XTherion предлагает некоторые интересные функции, которые могут помочь в создании текстовых входных файлов: поддержка кодировки Unicode и возможность открытия нескольких файлов. \[Кодировка файла указана в первой строке файла. Эта строка скрыта XTherion'ом и может быть доступна только косвенно, используя правое меню.]
 

Чтобы упростить ввод данных, он поддерживает форматирование таблиц нитки хода. Для ввода данных существует меню {\it Таблица данных}. Она может быть настроена на ввод данных пользователя, нажав кнопку {\it Определить формат данных}, когда курсор находится под спецификацией данных (опция `дата' в команде `centreline').
 

\subsubchapter XTherion -- редактор карт. 

Редактор карт позволяет вам рисовать и редактировать карту полностью в интерактивном режиме. Но не ожидайте слишком многого. XTherion не является редактором WYSIWYG. Он отображает только позицию, а не фактическую форму, нарисованных точек или линий. Визуально нет ника\-кой разницы между геликтитом и текстовой меткой -- оба они отображаются как простые точки.
 Тип и другие атрибуты любого объекта указываются только в меню {\it Точка} и {\it Линия}. 

\ifx\pdfoutput\undefined\else \leavevmode\llap{\smash{\raise10pt\hbox{\pdfannot width 6cm height 0cm depth 4cm {/Subtype /Text /Name /Help /Contents (Hints: 1. What does loop closure do? 2. Why do we use MetaPost?) }}} \qquad}\fi {\it Упражнение:} Найдите две существенные причины, почему карта, нари\-со\-ван\-ная в XTherion, не может быть идентична выходу Therion. (Если вы ответите на это, вы узнаете, почему XTherion никогда не будет истинным редактором WYSIWYG. Лень авторов -- не правильный ответ.) 

Начнем с описания типичного использования редактора карт. Во-первых, вам нужно решить, какую часть пещеры (какой скрап) вы рисуете. \[В одном файле можно нарисовать несколько скрапов, в этом случае все неактивные скрапы отображаются желтым.] 

После создания нового файла в редакторе карт вы можете загрузить одно или несколько {\bf изображений} -- сканированные эскизы съемки пещеры\[XTherion не может масштабировать и поворачивать отдельные изображения, поэтому используйте ту же ориентацию, масштаб и DPI для всех изображений, используемых в одном и том же скрапе.] -- в качестве подложки для рисования. Нажмите кнопку {\it Вставка} в меню {\it Фоновые изображения}. К сожалению, из-за ограничений языка Tcl/Tk, под\-дер\-жи\-ва\-ются только изображения в форматах GIF, PNM и PPM (плюс PNG и JPEG, если вы установили расширение tkImg). Кроме того, XTherion поддерживает XVI (XTherion vector image), в котором отображается нитка хода и LRUD, и данные PocketTopo экспортируются в формат Therion'а (см. ниже). Все добавленные изображения помещаются в верхний левый угол рабочей области. Переместите их можно двойным щелчком правой кнопкой мыши на изображении и перетаскиванием или через меню. Для повышения про\-из\-во\-ди\-тель\-ности на более медленных компьютерах можно временно вы\-гру\-зить неиспользуемое изображение из памяти, сняв флажок {\it показать}. Можно открыть существующий файл без загрузки фоновых изображений с по\-мощью меню {\it Открыть (без картинок)}. \[{Примечание:} Therion никак не использует фоновые изображения, если вы не назначили их для определенного скрапа с помощью опции |-sketch|.] 

Размер и масштабирование {\bf области рисования} настраивается в соот\-вет\-ству\-ющем меню.
 {\it Авто} вычисляет оптимальный размер рабочей области в соот\-вет\-ствии с размерами и позициями загруженных фоновых изображений. 

После этих этапов подготовки вы готовы к рисованию или, точнее, для {\bf создания файла данных карты}. Важно помнить, что вы на самом деле создаете текстовый файл, который должен соответствовать синтаксису, опи\-сан\-ному в главе {\it Формат данных}. На самом деле в редакторе карт исполь\-зу\-ются только несколько команд Therion'а: многострочная команда |scrap ... endscrap| может содержать команды |point|, |line| и |area|. (См. главу {\it Формат данных}). Это соответствует этапу ручного рисованния карты, которая стро\-ится из точек, линий и заполненных областей.
 

Итак, первым шагом является определение {\bf скрапа} с помощью |scrap ... endscrap| многострочной команды. В меню {\it Команды в файле} выберите подменю {\it Действие} и выберите {\it Вставить скрап}. Это изменит кнопку {\it Действие} на {\it Вставить скрап}, если у нее было другое значение. После нажатия этой кнопки в начало файла будет вставлен новый скрап. Вы должны видеть строки 

|scrap - scrap1
endscrap
end of file| 

в окне предварительного просмотра над кнопкой {\it Вставить скрап}. Это окно представляет собой упрощенный вывод текстового файла, который будет сохранен XTherion'ом. Показаваются только команды (|scrap|, |point|, |line|, |text| -- почему так, смотрите ниже) и их типы (для |point| и |line|) или ID (для |scrap|).
 

Полное содержимое любой команды отображается в меню {\it Просмотр коман\-ды}. 

Для изменения ранее созданных команд есть дополнительные меню -- напри\-мер {\it Скрап} для команды |scrap|. Здесь вы можете изменить ID (очень важно!) и другие опции. Подробнее смотрите главу {\it Формат данных}. 

Теперь можно вставить некоторые {\bf точечные символы}. Как и в случае встав\-ки скрапа, перейдите в меню {\it Команды в файле}, нажмите подменю {\it Действие} и выберите {\it Вставить точку}; затем нажать кнопку с изменившимся наз\-ва\-нием на {\it Вставить точку}. Сочетание клавишь для этого -- Ctrl-p. Затем нажмите на нужное место в рабочей области, и вы увидите синюю точку, представляющую символ точки. Ее атрибуты можно настроить в меню {\it Точка}. Вы останетесь в режиме `вставки' -- каждый щелчок по рабочей области добавляет новый символ точки. Старайтесь не нажимать дважды в одном месте -- тогда вы вставите два точечных символа в одном и том же месте!
 Чтобы выйти из режима `вставить', нажмите клавишу {\it Esc} на клавиатуре или кнопку {\it Выбрать} в меню {\it Команды в файле}. 

Каков порядок команд в выходном файле? Точно такой же, как в меню {\it Команды в файле}. Вновь созданные точечные, линейные и текстовые объ\-екты добавляются перед текущей выделенной строкой. Можно изменить порядок, выбрав строку и нажав кнопки {\it Вниз}, {\it Вверх} или {\it Переместить} в меню {\it Команды в файле}. Таким образом вы также можете перемещать объекты между скрапами. 

{\bf Рисование линий} аналогично рисованию в других программах редактирова\-ния векторной графики, которые работают с кривыми Безье. (Угадайте, как войти в режим вставки линии кроме использования сочетания Ctrl-l.) Нажмите, где должна быть первая точка, затем перетащите мышь с нажатой левой кнопкой и отпустите ее в том месте, где должна быть первая контрольная точка. Затем нажмите где-нибудь еще (эта точка будет второй точкой кривой) и перетащите мышь (отрегулируйте вторую контрольную точку предыдущей дуги и первую контрольную точку следующего дуги, одновременно). Если это объяснение кажется слишком неясным, вы может поработать в некоторых стандартных векторных редакторах. Линия будет завершена после выхода из режима вставки. Начало и ориентация линии отмечены небольшой оранжевой галочкой в первой точке. 

Для символов линии существуют два управляющих меню: {\it Линия} и {\it Точка линии}. Сначала устанавливаются атрибуты для всей кривой, такие как тип или имя. Важным является чек-бокс {\it обратная}: Therion требует ори\-ен\-ти\-ро\-ван\-ных кривых, и нет ничего необычного в том, что вы начинаете рисовать с неправильного конца. Меню {\it Точка линии} позволяет вам отрегулировать атрибуты любой выбранной точки на линии, например, сглаживание кривой в этой точке (которая включена по умолчанию) или наличие соседних кон\-троль\-ных точек (`|<<|' и `|>>|').
 

{\bf Области} определяются окружающими их линиями. Нажмите {\it Вставить об\-ласть}, а затем щелкните строки окружающие нужную область. Они авто\-ма\-ти\-чески вставляются в {\it Область} и называются (если они еще не названы). Альтернативный способ вставить их как |text| \[ВНИМАНИЕ! Команда |text| -- это не команда Therion'а! Это всего лишь псевдоним для блока произвольного текста в XTherion. В файле, сохраненном XTherion'ом, будет только то, что вы введете в {Редакторе} или смотрите в {Просмотре команд}. Это может быть определение области или что угодно, например комментарий, начинающийся с символа `|\#|'.], содержимое которого (вве\-ден\-ное в меню {\it Редактор} в редакторе карты) обычно многострочная команда |area ... endarea| (см. раздел {\it Формат данных}.)
 

%
Если вы нарисуете несколько скрапов с |none| проекцией, необходимо {\bf отка\-либ\-ро\-вать} область рисования. Масштаб можно определить только одним способом в XTherion -- используя координаты двух точек (заданных как в системе координат изображения, так и в `реальной' системе координат). 

После выбора скрапа (щелкните по его заголовку в меню {\it Команды в файле}) появятся два небольших красных квадрата, соединенных красной стрелкой (по умолчанию они будут в нижних углах области рисования). Вы должны перетащить их в точки с известными координатами -- обычно пересечения линий сетки на миллиметровке на отсканированном чертеже. Если вы не видите их, вы можете: \list

* нажать кнопку {\it Масштаб} в меню {\it Скрап} и щелкнуть два разных места на изображении, где должны быть конечные точки калибровочной стрелки, или * переместить указатель мыши в нужную позицию, прочитать координаты указателя и ввести эти координаты в {\it масштабирующие точки для кар\-тинки} в меню {\it Скрап}.
 После заполнения пар координат X1, Y1 и X2, Y2 стрелка калибровки будет перемещаться соответственно. \endlist

Затем вам нужно ввести реальные координаты этих точек (X1, Y1, X2, Y2). 

В {\bf режиме выбора} вы можете выбрать существующие линейные или точеч\-ные объекты и установить их атрибуты в соответствующих меню, пере\-мес\-тить их или удалить их (Ctrl-d или {\it Кнопка действия} в меню {\it Команды в файле} после установки {\it Действие} на {\it Удалить}). 

% [adding or deleting a point on the curve]
Существует меню {\it Поиск и выделение}, которое позволяет легко переклю\-чаться между объектами и показывать элементы, которые вы не видите при взгляде на изображение. Например, если вы введете слово `station' и нажмите {\it Показать все}, все станции на экране станут красными. 

XTherion не выполняет проверку синтаксиса; он только записывает объекты с атрибутами в текстовый файл. Любые ошибки обнаруживаются только при обработке этих файлов с помощью Therion. 

СОВЕТ. Ввод символов одного и того же типа одновременно экономит вам много времени, потому что вам не нужно менять тип символа и параметры заполнения для каждого нового символа. Поле {\it Опции} сохраняет старое значение, и достаточно изменить всего несколько символов. \[В случае станций съемки XTherion автоматически увеличивает номер станции для сле\-дую\-щего вставленного символа.] Рекомендуется начать с рисования всех станций съемки (не забудьте дать им имена (номера) в соответствии с настоящими именами в команде centreline), далее все хода, за которыми следуют все остальные точечные символы, линии и области. В конец рисуем поперечные сечения. 

\subsubchapter Дополнительные инструменты. 

\NEW{5.3}{\bf Помощь/Привязать изображение} создает файл MAP совместимый с OziExplorer на основе геоданных включенных в карту PDF\[Может присутствовать до девяти калибровочных точек в виде фиксированных станций в нитке хода с использованием геодезической системы координат.].
 

Если карта в формате PDF была преобразована в растровое изо\-бра\-же\-ние с использованием внешней программы, конвертер использует растровое изо\-бра\-же\-ние {\it и} pdf-карту с тем же базовым именем, расположенным в том же каталоге, для вычисления калибровочных данных.
 

Если используется непосредственно файл PDF, то вам необходимо уста\-но\-вить DPI и формат вывода перед автоматическим преобразованием \[|Ghostscript| и |convert| должны быть установлены в вашей системе. Обратите внимание, что установщик Windows не содержит |ghostscript|.] в растровый формат. 

\NEW{5.3}{\bf Данные PocketTopo} экспортированные в формате Therion'а\[Это специальный текстовый формат, который нужно импортировать с помощью XTherion'а и не может обрабатываться непосредственно Therion'ом.] из приложения PocketTopo можно импортировать в текстовом редакторе, а также в редак\-торе карт ({\it Файл $\to$ Импорт $\to$ PocketTopo therion export} и {\it Фоновые изоб\-ра\-же\-ния $\to$ Вставить $\to$ PocketTopo therion export}). Тот же файл используется для обоих импортов. Импорт эскиза напрямую не создает данные скрапа. Рисунок просто отображается на фоне как сканированное растровое изобра\-жение, и должен быть оцифрован вручную. 

\subsubchapter Сочитания клавишь и мыши в редакторе карт. {\it Общие} \list

* Ctrl+Z = отменить изменения; * Ctrl+Y = вернуть изменения; * F9 = компилировать текущий проект; * для выбора объекта в списке с помощью клавиатуры: переключайтесь с помощью `Tab' в желаемый список; перемещаться на нужный объект (объект подчеркивается); нажмите `Пробел'; * PageUp/PageDown = скролинг вверх/вниз в боковой панели; * Shift+PageUp/PageDown = скролинг вверх/вниз в окне Команды в файле. \endlist

{\it Область рисования и фоновые изображения} \list

* клик правой кнопкой мыши = скролинг области рисования; * двойной щелчок правой кнопкой мыши по изображению = перемещение изображения. \endlist

{\it Вставка скрапа} \list

* Ctrl+R = вставить скрап. \endlist

{\it Вставка линии} \list

* Crtl+L = вставить новую линию и войти в режим `вставка точек линии'; * щелчек левой кнопкой мыши = вставить точку линии (без контрольных точек) * Ctrl+щелчек левой кнопкой мыши = вставить точку линии очень близко к существующей точке (обычно она вставляется на ближайшую существую\-щую точку); * щелчек левой кнопкой мыши+тянуть = вставить точку линии (с контроль\-ными точками); * удерживать Ctrl при перемещении = изменить расстояние предыдущей контрольной точки; * щелчек левой кнопкой мыши+переместить контрольную точку = перемес\-тить ее положение; * щелчек правой кнопкой мыши на одной из предыдущих точек = выбирает предыдущую точку в режиме вставки (полезно, если вы хотите изменить также направление предыдущей контрольной точки); * Esc или щелчек левой кнопкой мыши на последней точке = завершение вставки линии; * щелчек левой кнопкой мыши на первой точке линии = замкнуть линию и завершить вставку линии. \endlist

{\it Редактирование линии} \list

* щелчок левой кнопкой мыши+перемещение = перемещение точки линии; * Ctrl+щелчок левой кнопкой мыши+перемещение = перемещение точки линии близко к существующей точке (обычно она перемещается на бли\-жайшую существующую точку); * щелчок левой кнопкой мыши на контрольной точке+перемещение = пере\-местить контрольную точку. \endlist

{\it Добавление точки линии} \list

* выберите точку, перед которой вы хотите вставить новые точки; вставить необходимые точки; нажмите Esc или щелкните левой кнопкой мыши по выбранной вами точке в начале. \endlist

{\it Удаление точки линии} \list

* выберите точку, которую хотите удалить; нажмите {\it Править линию} $\to$ {\it Удалить точку} в панели {\it Линия}. \endlist

{\it Раздиление линии} \list

* выберите точку, в которой вы хотите разделить линию; нажмите {\it Править линию} $\to$ {\it Разделить линию} в панели {\it Линия}. \endlist

{\it Вставка точек} \list

* Ctrl+P = переход в режим `вставки точки'; * щелчок левой кнопкой мыши = вставка точки в заданной позицию; * Ctrl+щелчок левой кнопкой мыши = вставка точки очень близко к сущест\-вующей точке (обычно она будет вставлена на ближайшую точку); * Esc = выход из режим `вставки точки'. \endlist

{\it Редактирование точки} \list

* щелчок левой кнопкой мыши+перетаскивание = перемещение точки; * Ctrl+щелчок левой кнопкой мыши+перетаскивание = перемещение точки близко к существующей точке (обычно она перемещается на ближайшую существующую точку); * щелчок левой кнопкой мыши+перетаскивание стрелок точки = изменение ориентации и/или размера точки (согласно заданным переключателям в панели управления точки). \endlist

{\it Вставка области} \list

* нажмите Ctrl+A или {\it Команды в файле} $\to$ {\it Вставить} $\to$ {\it область}, чтобы переключиться в режим `вставки границ области'; * щелчок правой кнопкой мыши на линиях, которые окружают желаемую область; * Esc, чтобы закончить ввод границ области. \endlist

{\it Редактирование области} \list

* выберите область, которую вы хотите отредактировать; * нажмите `Вставить' в {\it Область}, чтобы вставить другие границы в текущую позицию курсора; * нажмите `Вставить по ID', чтобы вставить границу с заданным ID в теку\-щую позицию курсора; * нажмите `Delete', чтобы удалить выбранную границу области. \endlist

{\it Выбор существующего объекта} \list

* щелчок левой кнопкой мыши = выбрать верхний объект; * щелчок правой кнопкой мыши = выбрать объект под верхним объектом (полезно, когда несколько точек лежат друг над другом).  \endlist

\subchapter Несколько мыслей о Therion'е. 

Несмотря на то, что все (ну, почти все) о входных файлах Therion'а было сказано, в этой главе приведены некоторые дополнительные советы и под\-сказки. 

\subsubchapter Как ввести нитку хода?. 

Основным блоком построения карт является команда |centreline|. Если пещера больше нескольких метров, неплохо было бы разделить данные в большем количестве файлов и отделить данные нитки хода от данных карты.
 

Обычно мы используем один |*.th| файл содержащий нитку хода для каждой отдельной съемки. Удобно начинать с пустого файла шаблона, как показано ниже, где точки будут заменены соответствующим текстом. 

|encoding ISO8859-1
survey ... -title "..."
	centreline
		team "..."
		team "..."
		date ...
		units clino compass grad
		data normal from to compass clino length
			... ... ... ... ...
	endcentreline
endsurvey| 

Чтобы создать уникальное пространство имен команда |centreline| заключена в команду |syrvey| ... |endsurvey|. Это полезно, если survey имеет то же имя, что и файл, который его содержит. \[Например |survey entrance| в файле |entry.th|.] На точки можно будет ссылаться используя символ |@| -- смотрите описание команды |survey|. 

Для действительно больших пещер можно построить иерархическую струк\-туру каталогов. В этом случае мы создаем один специальный файл с именем |INDEX.th| который включает все остальные |*.th| файлы из данного каталога и содержит команды |equate| для определения связей между съемками. 

\subsubchapter Как рисовать карты?. 

Самое главное -- придумать деление пещеры на скрапы. Скрап является основным блоком карты. Попытка подобрать скрап к соответствующему |*.th| файлу с ниткой хода одной съемки -- это почти всегда {\itплохая\/} идея. Причина в том, что соединения между скрапами должны быть как можно более простыми. Скрапы в целом независимы от иерархии нитки хода, поэтому старайтесь не привязываться к съемке когда рисуете карты и вы\-би\-ра\-ете лучшие объединения скрапов. 

We usually insert maps in the last-but-one level in survey hierarchy.\[Remember that surveys create namespaces, so you may reference only objects in the given survey and all subsurveys.] Each scrap may than contain arbitrary part of any survey in the last level of hierarchy. Например, есть survey |main| который содержит surveys |a|, |b|, |c| и |d|. Surveys |a| -- |d| содержат данные нитки хода от четырех съемок, и каждый из них находится в отдельном файле. Есть карта |main_map| которая содержит скрапы |s1| и |s2|. Если |main_map| находится в survey |main|, скрап |s1| может содержать часть нитки хода из survey |a|, полную нитку хода |b| и часть |c|; |s2| будет содержать часть |a| и |c| и полную нитку |d|. Названия станций survey будут иметь символ |@| (например, |1@a|). \[Если вы подключаете файлы карт в начале survey, вы можете ссылаться на любую станцию в любом скрапе, что представляет собой очень гибким инструмент. С другой стороны вы можете использовать более длинные имена в ссылках на станции, например |3@dno.katakomby.jmn.dumbier|.] 

Скрапы обычно хранятся в |*.th2| файлах. Каждый файл может содержать несколько скрапов. Чтобы данные были хорошо организованы, мы приняли несколько соглашений об именах файлов: в файле |foo.th2| все скрапы име\-ну\-ются |foo_si|, где |i| -- |1|, |2| и так далее. Поперечные сечения именуются |foo_ci|, линии |foo_li| и т.п. Это очень помогает с большими пещерными системами; если упоминается какой-то скрап, вы сразу же знаете в каком файле он был определен. 

Можно создавать один файл |INDEX.th2| на каталог, который подключает все |*.th2| файлы, описывает maps и объединения скрапов. 

При рисовании скрапов вы должны проверить, правильно ли определен контур: все линии создающие внешнюю границу ходов должны иметь опцию |-outline out|; все линии окружающие внутренние колонны опцию |-outline in|. Границы скрапа не могут пересекаться, иначе внутренняя сторона скрапа не может быть определена. Есть два простых теста, которые определяют правильность скрапа: \list

* не выводится предупреждение \MP\  ``|scrap outline intersects itself|''; * когда вы устанавливаете цвет заливки ходов (|color map-fg <номер>| опция в |layout|), вы можете видеть что Therion считает внутренней областью скрапа. \endlist

\subsubchapter Как создавать модели?. 

Модель создается из внешних линий скрапов. Высота и глубина хода вычис\-ля\-ются по символьным точкам |высота хода| (|passage-height|) и |размер хода| (|dimensions|). 

\subchapter Therion in depth. 

\subsubchapter Как карта собирается в единое целое. 

В этой главе объясняется работа опций |-clip|, |-place|, |-visibility| и |-context | команд |point|, |line| и |area|. Также объясняются опции |color|, |transparent |, |symbol-hide| и |symbol-show| команды |layout|. 

При экспорте карты Therion должен определить три атрибута для каждого из символов -- точки, линии или области: видимость, подрезание и упо\-ря\-до\-че\-ние. 

(1) Символ отображается, если верно следующее: 

\list

* он имеет опцию |-visibility| со значением |on| (все символы по умолчанию); * он не был скрыт опцией |-symbol-hide| в layout; * если его опция |-context| установлена, а соответствующий символ не был скрыт опцией |-symbol-hide| в layout. \endlist

Экспортируются только видимые символы. 

(2) Некоторые символы могут подрезаться абрисом скрапа. По умолчанию это все следующие объекты: \list

* {\it точечные символы:} символы наполнения ходов (почва\dots гуано); * {\it линейные символы:} все символы линий, которые не имеют опцию |-outline|, за исключением |section| (|выносная линия сечения|), |arrow| (|стрелка|), |label| (|текстовая метка|), |gradient| (|уклон хода|) и |water-flow| (|водоток|); * {\it символы области:} все. \endlist

Значение по умолчанию может быть изменено с помощью опции |-clip|, если это разрешено для определенного символа. Все остальные символы не под\-ре\-за\-ются границей скрапа. 

Упорядочевание: каждый символ относится к одной из следующих групп, которые последовательно выводятся: 

\list

* bottom = все символы с опцией |-place bottom|; * default-bottom = все символы |области| по умолчанию; * default = символы, которые не принадлежат ни к какой другой группе; * default-top =  |ceiling-step| (|уступ потолка|) и |chimney| (|камин|) по умолчанию; * top = все символы с опцией |-place top|. \endlist

Порядок символов внутри каждой группы соответствует порядку команд во входном файле\[Или в меню {Команды в файле} XTherion'а.]: символы, которые идут первыми, нарисованы последними (т.е. они отображаются в верхней части каждой группы). 

Теперь мы готовы описать как строится карта (или атлас): 

\list\obeyspaces\obeylines * область карты заполняется |color map-bg|; * растровые изображения поверхности отображаются, если |surface| установ\-лен в |bottom|; * ДЛЯ каждого скрапа: абрисы заполняются белым; * рисуется сетка если |grid| установлен в |bottom|; * анонс внизу \[Согласно спецификации опции |preview| в команде |map|.] заполняется |color preview-below|; * ДЛЯ каждого уровня\[Уровень -- это коллекция скрапов не разделенная |break| в команде |map|.]:
      НАЧАЛО отсечения
           ДЛЯ каждого скрапа: абрис заполняется |color map-fg|
           ДЛЯ каждого скрапа: символы |области| заполняются и отсекаются
           до границы скрапа
      КОНЕЦ отсечения
      НАЧАЛО отсечения текстовых меток (для всех текстовых меток на
      этом и верхних уровнях)
            ДЛЯ каждого скрапа:
                  рисуются все символы прошедшие отсечение (за исключе-
                     нием |line survey|), упорядочиваются снизу вверх
                  рисуются |line survey| символы
                  отсекаются границы скрапов
            ДЛЯ каждого скрапа:
                  рисуются все неотсеченные символы (за исключением
                     |point station| и всех текстовых меток), упорядочеваются
                     снизу вверх
                  рисуются |point station| символы
      КОНЕЦ отсечения текстовых меток
      ДЛЯ каждого скрапа: рисуются все (точечные и линейные) текстовые
         метки (в том числе |wall-altitude|); * анонс рисуется поверх с |color preview-above|; * растровые изображения поверхности отображаются если |surface| установ\-лен в |top|; * сетка отображается если |grid| установлен в |top|. \endlist

%%
\endinput

