\eject

\vbox{\pic[93.2mm]{thom.jpg}} \vskip-3cm {\tenitbx\baselineskip15pt\leftskip2mm\rightskip6.8cm\parindent4.6cm Jesus said, `Let him who seeks continue seeking until he finds. When he finds, he will become troubled. When he becomes troubled, he will be astonished, and he will rule over the all.' \hfill\eightrm ---Gospel according to Thomas, {\eightmit 2}nd century\par } 

%-2.35cm
\chapter Изменение макета PDF-карт. 

Эта глава чрезвычайно полезна, если вас не устраивает предопределенный макет символов карты и ее предоставление, и вы хотите адаптировать их к вашим желаниям. Тем не менее, вам нужно знать, как писать простые макросы \TeX\ и \MP, чтобы добиться этого. 

\subchapter Макет страницы в режиме атласа. 

Команда |layout| позволяет произвести базовую настройку страницы в режиме атласа. Это делается с помощью таких опций, как |page-setup| или |overlap|. Но нет никаких опций, которые указывали бы положение карты, навигатора и других элементов внутри области, определяемой |page-width| и |page-height|; например, почему навигатор находится ниже карты, а не справа или слева? 

Существует много возможных вариантов для страницы. Вместо того, чтобы использовать еще больше опций для команды |layout|, Therion использует язык \TeX\  для описания других макетов страниц. 

%(See the section `layout' where to put \TeX\ commands.) 
Преимущество такого подхода состоит в том, что пользователь имеет прямой доступ к расширенному механизму набора текста, не делая язык Therion сверхсложным. 

Therion использует pdf\TeX\  с форматом {\it plain} для типографского набора.\break  Поэтому вы должны быть знакомы с plain \TeX, если хотите определить новые макеты. 

Подробнее о plain \TeX\  смотрите в \list

Knuth, D. E.: {\it The \TeX book}, Reading, Massachusetts, Addison-Wesley $^1$1984 \endlist

%[...]
Для освоения Pdf\TeX\ имеется краткое руководство \list

Th\`anh, H. T.---Rahtz, S.---Hagen, H.: {\it The pdf\TeX\ user manual}, доступное на \hfil\break \www{http://www.pdftex.org} \endlist

\TeX\  макросы используются внутри |code tex-atlas| команды |layout| (подробнее смотрите главу {\it Обработка данных}). Основным определением Therion'а явля\-ется макрос 

|\dopage| 

 Идея проста: для каждой страницы Therion определяет переменные \TeX\  (count, token и box registers), которые содержат элементы страницы (карта, навигатор, название страницы и т.д.). В конце каждой страницы вызывается макрос |\dopage|. Это определяет положение каждого элемента на странице. Переопределив этот макрос, вы получите желаемый макет страницы. Без этого переопределения вы получите стандартный макет. 

Ниже приведен список переменных, определенных для каждой страницы: 

\list

{\it Боксы:} 

* |\mapbox| = бокс содержащий карту. Его ширина (высота) устанавливается в соответствии с опциями |size| и |overlap| команды |layout|. 

|size_width + 2*overlap| или 

|size_height + 2*overlap|, соответственно. 

* |\navbox| = бокс содержащий навигатор, с размерами 

|size_width * (2*nav_size_x+1) / nav_factor| или 

|size_height * (2*nav_size_y+1) / nav_factor|, соответственно. 

Оба бокса, |\mapbox| и |\navbox|, также содержат гиперссылки. 

{\it Регистровые счетчики:} 

* |\pointerE|, |\pointerW|, |\pointerN|, |\pointerS| содержат номер страницы сосед\-них страниц в направлениях E, W, N и S. Если такой страницы нет, номер ее страницы равен 0. 

* |\pagenum| содержит номер текущей страницы. 

{\it Регистры токенов:} 

* |\pointerU|, |\pointerD| содержат информацию о страницах выше и ниже текущей страницы. Они состоят из одной или нескольких конкатенирован\-ных записей. Каждая запись имеет специальный формат 

{\tt|page-name|\char124|page-number|\char124|destination|\char124\char124} 

Если таких страниц нет, то значение устанавливается в |notdef|. 

Смотрите описание макроса |\processpointeritem| ниже, чтобы знать, как извлечь и использовать эту информацию. 

* |\pagename| = имя текущей карты в соответствии с опциями команды |map|. 

* |\pagelabel| = метка страницы, указанная опциями |origin| и |origin-label| в команде |layout|. \endlist

Следующие переменные задаются в начале документа: 

\list

* |\hsize|, |\vsize| = \TeX\ размеры страницы, заданные в соответствии с парамет\-рами |page-width| и |page-height| опции |page-setup| команды |layout|. Они устанавливают нашу площадку при определении макета страницы исполь\-зуя макрос |\dopage|. 

* |\ifpagenumbering| = это значение установлено в true или false в соответ\-ствии с опцией |page-numbers| команды |layout|. \endlist

Существуют также некоторые предопределенные макросы, которые помо\-гают с обработкой |\pointer*| переменных: 

\list

* |\showpointer| с одним из |\pointerE|, |\pointerW|, |\pointerN| или |\pointerS| в качестве аргумента отображает значение аргумента. Если значение равно 0, тогда ничего не отображается. Это полезно, потому что нулевое значе\-ние (нет соседней страницы) не должно отображаться. 

* |\showpointerlist| с одним из аргументов |\pointerU| или |\pointerD| представ\-ляет содержание этого аргумента. Содержимое |\pointerU| и |\pointerD| смо\-трите выше. Для каждой записи |\showpointerlist| вызывает макрос |\processpointeritem|, который отвечает за форматирование данных. 

Макрос |\showpointerlist| следует использовать без переопределения в том месте, где вы хотите отобразить содержимое своего аргумента; для форма\-тирования пользовательских данных переопределите макрос |\processpointeritem|. 

* |\processpointeritem| имеет три аргумента -- page-name (название страницы), page-number (номер страницы), destination (место отображения), и выводит эти данные. Аргументы разделяются следующим образом: 

{\tt|\def\processpointeritem#1|\char124|#2|\char124|#3\endarg{...}|} 

Пример может быть следующим: 

{\tt|\def\processpointeritem#1|\char124|#2|\char124}|#3\endarg{|\%|
	\hbox{\pdfstartlink attr {/Border [0 0 0]}|\%|
		goto name {#3} #2 (#1)\pdfendlink}|\%|
}| 

%% %
(обратите внимание, как использовать аргумент {\it destination}), или намного проще (если нам не нужны функции гиперссылки): 

{\tt|\def\processpointeritem#1|\char124|#2|\char124}|#3\endarg{|\%|
	\hbox{#2 (#1)}|\%|
}| \endlist

%%
Для управления шрифтом есть следующие макросы: 

\list

* |\size[#1]| для изменения размера, 

* |\color[#1 #2 #3]| для изменения цвета (значения RGB в диапазоне 0-100) и 

* |\rm|, |\it|, |\bf|, |\ss|, |\si| для изменения типа отображения. \endlist

%If you use own texts in \TeX\ macros (like a label for the scale bar), these 
%font switches work only in restricted manner: it's supposed that all characters 
%are present in the first encoding specified in the initialization file. 
Ниже приведен список предопределенных настроек текстов, которые могут быть использованы в атласе. 

Также есть макрос |\framed|, который принимает бокс в качестве аргумента и отображает бокс в рамке. Стиль рамки можно настроить, переопределив макрос |\linestyle|, который по умолчанию равен |1 J 1 j 1.5 w|. 

Теперь мы готовы определить макрос |\dopage|. Вы можете выбрать, какой из предопределенных элементов использовать. Очень простой пример: 

|layout my_layout
	scale 1 200
	page-setup 29.7 21 27.7 19 1 1 cm
	size 26.7 18 cm
	overlap 0.5 cm
	code tex-atlas
		\def\dopage{\box\mapbox}
		\insertmaps
endlayout| 

который определяет размер формата A4 без навигатора и любых текстов. На странице есть только карта. 

Обратите внимание на макрос |\insertmaps|. Страницы карты вставляются в его положение. Это не делается автоматически, потому что вы можете вставить некоторые другие страницы перед первой страницей карты. 

Более продвинутым является определение по умолчанию макроса |\dopage|: 

|\def\dopage{ \vbox{\centerline{\framed{\mapbox}} \bigskip

%
\line{ \vbox to \ht\navbox{ \hbox{\size[20]\the\pagelabel \ifpagenumbering\space(\the\pagenum)\fi \space\size[16]\the\pagename} \ifpagenumbering

%
\medskip

\hbox{\qquad\qquad \vtop{ \hbox to 0pt{\hss\showpointer\pointerN\hss} \hbox to 0pt{\llap{\showpointer\pointerW\hskip0.7em} \raise1pt\hbox to 0pt{\hss$\updownarrow$\hss} \raise1pt\hbox to 0pt{\hss$\leftrightarrow$\hss} \rlap{\hskip0.7em\showpointer\pointerE}} \hbox to 0pt{\hss\showpointer\pointerS\hss} }\qquad\qquad \vtop{ \def\arr{$\uparrow$} \showpointerlist\pointerU \def\arr{$\downarrow$} \showpointerlist\pointerD } } \fi

%%%%
\vss

\scalebar

}\hss \box\navbox } } }| 

Используя другие plain макросы \TeX\ или примитивы \TeX, можно добавить другие функции, например другой макет для нечетных и четных страниц, заголовки и колонтитулы или добавить логотип на каждую страницу. 

В дополнение к страницам карты атлас содержит дополнительные области: титульная страница, основные факты о пещере, легенда с использованием символов карты и т.д. 

Therion автоматически генерирует список используемых символов карты и списки лиц, которые обнаружили, исследовали и нарисовали выбранную часть пещеры. Следующие символьные регистры могут использоваться (в соответствии с необходимостью до или после макроса |\insertmaps|): 

\list

* |\explotitle|, |\topotitle|, |\cartotitle| = перевод названий; * |\exploteam|, |\topoteam|, |\cartoteam| = участники (в соответствии с опциями |team|, |explo-team| команды |centreline| и опции |author| для скрапов); * |\explodate|, |\topodate|, |\cartodate| = соответствующие даты; * |\comment| = задано в соответствии с опцией |map-comment| команды |layout|; * |\copyrights| = устанавливается в соответствии с вариантами авторского права для съемок и других объектов; * |\cavename| = имя экспортируемой карты, устанавливается в соответствии с опцией |-title| экспортируемой карты; * |\cavelength|, |\cavedepth| = приблизительная длина и глубина отображаемой карты; * |\cavelengthtitle|, |\cavedepthtitle| = переведенные метки; * \NEW{5.4}|\cavemaxz|, |\caveminz| = значение высоты max/min; * \NEW{5.4}|\thversion| = текущая версия Therion'а; * \NEW{5.4}|\currentdate| = текущая дата; * \NEW{5.4}|\outcscode|, |\outcsname| = вывести код и наименование системы координат; * \NEW{5.4}|\northdir| = `true' или `grid'; * \NEW{5.4}|\magdecl| = магнитное склонение в градусах; * \NEW{5.4}|\gridconv| = конвергенция сетки меридиана в градусах. \endlist

Макрос |\atlastitlepages| объединяет большинство перечисленных токенов,\break чтобы получить простой, предварительно отформатированный, вывод стра\-ницы в виде атласа. 

Для отображения легенды есть макросы: 

\list

* |\iflegend| = условный; true если опция |legend| команды |layout| была установ\-лена в |on| или |all|; * |\legendtitle| = регистровый токен, содержащий переведенное название\break легенды; * |\insertlegend| = макрос для вставки изображений символов легенды с пере\-веденными описаниями в указанное количество столбцов (в соответствии с опцией |legend-columns| макета); * |\formattedlegend| = объединяет все три приведенные выше команды, чтобы получить предварительно отформатированную легенду с заголовком и сим\-волами в двух\[Значение по умолчанию; устанавливайте опцию |legend-columns| макета, чтобы указать количество столбцов.] столбцах, если опция |legend| установлена в |on|. \endlist

Стрелка направления на север и шкала масштаба могут отображаться с использованием: 

\list

* |\ifnortharrow| =  условный; true, если проекция карты -- это план, а символ стрелки на север не скрыт в |layout|; * |\ifscalebar| = условный; true, если шкала масштаба не скрыта; * |\northarrow| = PDF-форма со стрелкой на север; * |\scalebar| = PDF-форма со шкалой масштаба. \endlist

Есть макрос общего назначения для набора текста в нескольких столбцах\[Не используйте с легендой карты оформленной в несколько столбцов с помощью опции |legend-columns| макета.]: \list

* |\begmulti <i>|, |\endmulti| = текст между этими макросами набирается в столбцы |<i>|. \endlist

Пример создания атласа со списками съемщиков и т.д.\ за которыми следуют карты и с легендой в конце: 

|code tex-atlas \atlastitlepages

\insertmaps

\formattedlegend| 

\subchapter Макет страницы в режиме карты. 

В режиме карты можно использовать множество предопределенных пере\-менных, которые описаны в предыдущей главе: 

{\rightskip0cm plus 5cm |\cavename|, |\comment|, |\copyrights|, |\explotitle|, |\topotitle|, |\cartotitle|, |\exploteam|, |\topoteam|, |\cartoteam|, |\explodate|, |\topodate|, |\cartodate|, |\cavelength|, |\cavedepth|, |\cavelengthtitle|, |\cavedepthtitle|, |\cavemaxz|, |\caveminz|, |\thversion|, |\currentdate|, |\outcscode|, |\outcsname|, |\northdir|, |\magdecl|, |\gridconv|, |\ifnortharrow|, |\ifscalebar|, |\northarrow|, |\scalebar|, |\iflegend|, |\legendtitle|, |\insertlegend|, |\begmulti <i>|, |\endmulti|, |\formattedlegend|, |\legendcolumns|. \par} 

Чтобы разместить их где-нибудь на странице карты, вам нужно определить макрос |\maplayout| в разделе |code tex-map| команды |layout|. Он должен содер\-жать один или несколько |\legendbox| вызовов. Макрос |\legendbox| имеет четыре параметра: координаты в диапазоне 0--100, спецификация выравни\-вания (N, E, S, W, NE, SE, SW, NW или C) и отображаемый контент. 

Простой пример: 

|\def\maplayout{
	\legendbox{0}{100}{NW}{\northarrow}
}| 

который отображает стрелку на север в верхнем левом углу листа карты. 

Для удобства пользователя существует символьный регистр |\legendcontent|. Он содержит предварительно отформатированное имя пещеры, стрелку на север, шкалу масштаба, команды исследователей, съемщиков и авторов\break карты, комментарии, авторские права и легенду. (|\legendcontent| также\break используется в определении макета карты по умолчанию:

|\def\maplayout{\legendbox{0}{100}{NW}{\the\legendcontent}}|). 

Ширина вышеуказанного текста может быть скорректирована с помощью регистра |\legendwidth| (его значение по умолчанию задано опцией\break |legend-width| эскиза). Цвет и размер текстов в преформатированной легенде можно легко изменить, используя символьные регистры |\legendtextcolor|, |\legendtextsize|, |\legendtextsectionsize| и |\legendtextheadersize|, например для большого синего текста: 

|code tex-map
	\legendwidth=20cm
	\legendtextcolor={\color[0 0 100]}
	\legendtextsize={\size[20]}
	\legendtextheadersize={\size[60]}| 

Можно отобразить всю карту, обрамленную установкой регистра\break |\framethickness| в положительное значение, например |0.5mm|. 

\subchapter Настройка текстовых меток. 

Начиная с версии 5.4.1 вы можете использовать опцию |fonts-setup| макета вместо макроса \MP\ |fonts_setup()|. 

\subchapter Новые символы карты. 

Команда компоновки Therion позволяет легко переключаться между различ\-ными предопределенными наборами символов карты. Если такой символ или набор символов вам не нужен, можно создать новые символы карты. 

Однако для этого требуется знание языка \MP, который используется для визуализации карты. Это описано в: 

\list

Hobby, J. D.: {\it A User's Manual for MetaPost}, доступно здесь: \hfil\break \www{http://cm.bell-labs.com/cm/cs/cstr/162.ps.gz} \endlist

Пользователь также может воспользоваться исчерпывающей ссылкой на\break язык {\manfnt METAFONT}, который очень похож на \MP: 

\list

Knuth, D. E.: {\it The METAFONTbook}, Reading, Massachusetts, Addison-Wesley $^1$1986 \endlist

Новые символы могут быть определены в разделе |code metapost| команды\break |layout|. Это упрощает добавление новых символов во время выполнения. Также можно добавлять символы для постоянного использования, компили\-руя их в исполняемый файл Therion (смотрите {\it Приложение} для инструкций, как это сделать). 

Каждый символ должен иметь уникальное имя, состоящее из следующих элементов: 

\list * одна из букв `p', `l', `a', `s' для точки, линии, области или специальных символов, соответственно; * символ подчеркивания; * тип символа, указанный в главе {\it Формат данных\/} с удалением всех тире; * если символ имеет подтип, добавьте символ подчеркивания и подтип; * символ подчеркивания; * идентификатор набора символов в верхнем регистре. \endlist

Пример: стандартное имя для символа `water-flow' с подтипом `permanent' в наборе `MY' -- |p_waterflow_permanent_MY|. Стандартное имя для пользова\-тельских типов символов не должно включать идентификатор набора сим\-волов, например |p_u_bat|. 

Каждый новый символ должен быть зарегистрирован вызовом макроса: 

|initsymbol("<стандартное имя символа>");| 

если он не скомпилирован в исполняемый файл Therion. 

Существует четыре предопределенных ручки {\it PenA} (самый толстый) \dots\ {\it PenD} (самый тонкий), который должен использоваться для всех чертежей. Для рисования и заполнения используйте команды |thdraw| и |thfill| вместо команд \MP\  |draw| и |fill|. 

\NEW{5.4}Доступны также следующие переменные: 

\list

* булевская |ATTR__shotflag_splay|, |ATTR__shotflag_duplicate|,\hfil\break |ATTR__shotflag_approx| = устанавливает линию съемки; * булевская |ATTR__stationflag_splay| = установлено в `true' для боковых заме\-ров крайних станций; * булевская |ATTR__scrap_centerline| = установлено в `true' для скрапов создан\-ных по нитке хода; * булевская |ATTR__elevation| = устанавливается в `true' для разрезе (разрез-развертки), в `false' для проекции плана; * числовая |ATTR__height| = глубина колодца (pit) или входного колодца\break (wall:pit); * строковая |ATTR__id| = содержит текущий идентификатор объекта ID; * строковая |ATTR__survey| = содержит текущее название съемки; * строковая |ATTR__scrap| = содержит текущее название скрапа; * изображение |ATTR__text| = содержит набранный текст, например для\break точечного символа -- продолжение (continuation); * строковая |NorthDir| = `true' или `grid'; * числовая |MagDecl| = магнитное склонение в градусах; * числовая |GridConv| = конвергенция сетки магнитного меридиана в гра\-дусах. \endlist

\subsubchapter Точечные символы. 

Точечные символы определяются как макросы с использованием команд\break |def ... enddef;|. Большинство определений точечных символов имеют четыре аргумента: position (положение, пара), rotation (вращение, числовое), scale (масштаб, числовое) и alignment (выравнивание, пара). Исключения\break составляют {\it section (сечение)}, который не имеет визуального представления; все {\it labels (подписи)}, которые требуют специальной обработки, как описано в предыдущей главе; и {\it station (станция)}, которая принимает только один аргумент: position (положение, пара). 

Все точечные символы рисуются в локальных координатах с единицей длины {\it u}. Рекомендуемые диапазоны: $\left<-0.5u,0.5u\right>$ в обоих осях. Символ должен быть центрирован в начале координат. Для окончательной карты все\break чертежи трансформируются, как указано в переменной трансформации {\it T\/},\break поэтому перед ее рисованием необходимо установить эту переменную. 

Обычно это делается в два этапа (предположим, есть четыре аргумента: {\it P}, {\it R}, {\it S}, {\it A}): 

\list

* устанавливается переменная {\it U} (пара) символа в $\left({width\over2},{height\over2}\right)$ для\break правильного выравнивания. Аргумент alignment (выравнивание) {\it A}\break является парой значений, представляющих собой отношения $\left(shift_x\over U_x\right)$ и $\left(shift_y\over U_y\right)$. 

Следовательно, |aligned A| означает |shifted (xpart A * xpart U, ypart A * ypart U)|. * устанавливается переменная трансформации {\it T} 

{\catcode`\=12|T:=идентично для выравнивания A, вращения R, масштабирования S и сдвига P;|} \endlist

Для рисования и заполнения используйте команды |thdraw| и |thfill| вместо команд \MP |draw| и |fill|. Они автоматически обрабатывают трансформацию {\it T}. 

Пример может быть следующим: 

|def p_entrance_UIS (expr P,R,S,A)= U:=(.2u,.5u); T:=identity aligned A rotated R scaled S shifted P; thfill (-.2u,-.5u)--(0,.5u)--(.2u,-.5u)--cycle; enddef; initsymbol("p_entrance_UIS");| 

\subsubchapter Линейные символы. 

Line symbols differ from point symbols in respect that there is no local coordinate system. Each line symbol gets the {\it path} in absolute coordinates as the first argument. Therefore it's necessary to set {\it T} variable to |identity| before drawing. 

Following symbols take additional arguments: \list

* arrow = numeric: 0 is no arrows, 1 arrow at the end, 2 begin, 3 both ends * contour = text: list of points which get the tick or one of $-1$, $-2$ or $-3$ to mark undefined tick, tick in the middle or no tick, respectively * section = text: list of points which get the orientation arrow or $-1$ to indicate no arrows * slope = numeric: 0 no border, 1 border; text: list of (point,direction,length) triplets \endlist

Usage example: 

|def l_wall_bedrock_UIS (expr P) = T:=identity; pickup PenA; thdraw P; enddef; initsymbol("l_wall_bedrock_UIS");| 

\subsubchapter Area symbols. 

Areas are similar to lines: they take only one argument -- {\it path} in absolute coordinates. 

You may fill them in three ways: 

\list

* fill an uniform or randomised grid in a temporary picture (having dimensions |bbox path|) with some point symbols; clip it according to |path| and add to the |currentpicture| * fill |path| with a solid colour * fill |path| with a predefined pattern using a |withpattern| keyword. \endlist

Patterns are defined using the same user interface (without the |patterncolor| macro) as described in the article 

\list

Bolek, P.: ``\MP\ and patterns,'' {\it TUGboat}, 3, XIX (1998), pp.~276--283, available online at \www{https://www.tug.org/TUGboat/Articles/tb19-3/tb60bolek.pdf} \endlist

You may use standard \MP\ |draw| and similar macros without setting of {\it T} variable in pattern definitions. 

Example on how to define and use patterns: 

|beginpattern(pattern_water_UIS); draw origin--10up withpen pensquare scaled (0.02u); patternxstep(.18u); patterntransform(identity rotated 45); endpattern; 

def a_water_UIS (expr p) = T:=identity; thclean p; thfill p withpattern pattern_water_UIS; enddef; initsymbol("a_water_UIS");| 

\subsubchapter Special symbols. 

There are currently two special symbols: scale bar and north arrow. Both are experimental and subject to change. 

\endinput

